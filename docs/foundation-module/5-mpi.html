<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Markdown Phase I</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-assets/Octagram.png" width=72 height=72">
</a></h1>
<ul><li><a href="../inweb/index.html">inweb</a></li>
</ul><h2>Foundation Module</h2><ul>
<li><a href="index.html"><span class="selectedlink">foundation</span></a></li>
<li><a href="../foundation-test/index.html">foundation-test</a></li>
</ul><h2>Example Webs</h2><ul>
<li><a href="../goldbach/index.html">goldbach</a></li>
<li><a href="../twinprimes/twinprimes.html">twinprimes</a></li>
<li><a href="../eastertide/index.html">eastertide</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/inweb"><img src="../docs-assets/github.png" height=18> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="../../../inform/docs/index.html">inform</a></li>
<li><a href="../../../intest/docs/index.html">intest</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Markdown Phase I' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">foundation</a></li><li><a href="index.html#5">Chapter 5: Generating Websites</a></li><li><b>Markdown Phase I</b></li></ul></div>
<p class="purpose">Phase I of the Markdown parser: reading a series of lines into a tree of container and leaf blocks.</p>

<ul class="toc"><li><a href="5-mpi.html#SP1">&#167;1. Disclaimer</a></li><li><a href="5-mpi.html#SP2">&#167;2. State</a></li><li><a href="5-mpi.html#SP4">&#167;4. Receivers</a></li><li><a href="5-mpi.html#SP8">&#167;8. Markers</a></li><li><a href="5-mpi.html#SP19">&#167;19. Containers</a></li><li><a href="5-mpi.html#SP23">&#167;23. Comparing the two stacks</a></li><li><a href="5-mpi.html#SP24">&#167;24. The main function</a></li><li><a href="5-mpi.html#SP25">&#167;25. Finding interpretations</a></li><li><a href="5-mpi.html#SP27">&#167;27. Parsing link references</a></li><li><a href="5-mpi.html#SP29">&#167;29. The interstage</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. Disclaimer. </b>Do not call functions in this section directly: use the API in <a href="5-mrk.html" class="internal">Markdown</a>.
</p>

<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. State. </b>We now define the state of the Phase I parser preserved between successive
calls to the function <span class="extract"><span class="extract-syntax">MDBlockParser::add_to_document</span></span>.
</p>

<p class="commentary">The most important part is the pair of stacks. The "container stack" holds the
chain of container blocks containing the current write position. For
example, if the words "Sundman traded the Z-Grill for a block of four Inverted
Jennys" appear in a paragraph under a list of notable philately deals, then
the container stack will consist of the <span class="extract"><span class="extract-syntax">DOCUMENT_MIT</span></span> head node (position 0),
then an <span class="extract"><span class="extract-syntax">UNORDERED_LIST_ITEM_MIT</span></span> node (position 1), and the <span class="extract"><span class="extract-syntax">container_sp</span></span>
will be 2. The paragraph item does exist, but is not a container and is not
held on the stack; it will be one of the child nodes (in fact, the last one)
of the <span class="extract"><span class="extract-syntax">UNORDERED_LIST_ITEM_MIT</span></span> node.
</p>

<p class="commentary">The container stack, then, refers to the actual tree, and provides us with a
quick way to access the latest goings-on. The full tree may be very large,
so we wouldn't want to traverse it every time a line came along: that would
have quadratic running time in the number of lines.
</p>

<p class="commentary">The "marker stack" records the notation used to specify this situation.
For example, the line <span class="extract"><span class="extract-syntax">* &gt; The future King George V paid Â£1,450 for an unused blue</span></span>
contains two "positional marker" notations: the <span class="extract"><span class="extract-syntax">*</span></span> indicates an unordered list
item, the <span class="extract"><span class="extract-syntax">&gt;</span></span> a block quote. Here, then, the marker stack also holds two items.
But because we want the indexing of the two stacks to correspond exactly,
these two items are indexed 1 and 2, not 0 and 1. The hypothetical entry 0
on the marker stack would correspond to saying that the text is to go into
the document as a whole, and that goes without saying, so we do not use entry 0.
</p>

<p class="commentary">This correspondence means that when the line has been acted on, marker 1
(the <span class="extract"><span class="extract-syntax">*</span></span>) leads to container 1 being an <span class="extract"><span class="extract-syntax">UNORDERED_LIST_ITEM_MIT</span></span>, and
marker 2 (the <span class="extract"><span class="extract-syntax">&gt;</span></span>) leads to container 2 being a <span class="extract"><span class="extract-syntax">BLOCK_QUOTE_MIT</span></span>. So at
some points during parsing, the two stacks line up nicely. Nevertheless,
they are not the same, and they have different stack pointers, because
at times one contains more entries than the other.
</p>

<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3.  </b>A dirty secret: the code below currently has a hard maximum on the nesting
depth of list items and block quotes. No human will remotely discover this,
and the only consequence of exceeding it is that we won't render block quotes
or list items deeper than that. It wouldn't be too hard to remove this hard
maximum, but it doesn't seem worth it.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax"> </span><span class="constant-syntax">128</span><span class="plain-syntax"> </span><span class="comment-syntax"> human users rarely exceed 2</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_variation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">variation</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tree_head</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">md_links_dictionary</span><span class="plain-syntax"> *</span><span class="identifier-syntax">link_references</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">containers</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">container_sp</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> </span><span class="identifier-syntax">markers</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">marker_sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">temporary_marker_limit</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">receiving_PARAGRAPH</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">receiving_CODE_ITEM</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">receiving_HTML</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">blank_matter_after_receiver</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">md_fencing_data</span><span class="plain-syntax"> </span><span class="identifier-syntax">fencing</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_end_condition</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="constant-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::initialise</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::initialise</span></span>:<br/>Markdown - <a href="5-mrk.html#SP5">&#167;5</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">markdown_variation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">variation</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">head</span><span class="plain-syntax">, </span><span class="reserved-syntax">md_links_dictionary</span><span class="plain-syntax"> *</span><span class="identifier-syntax">dict</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">variation</span><span class="plain-syntax"> = </span><span class="identifier-syntax">variation</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">tree_head</span><span class="plain-syntax"> = </span><span class="identifier-syntax">head</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">link_references</span><span class="plain-syntax"> = </span><span class="identifier-syntax">dict</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP3_1" class="named-paragraph-link"><span class="named-paragraph">Initialise the two stacks</span><span class="named-paragraph-number">3.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP3_2" class="named-paragraph-link"><span class="named-paragraph">Initialise the receiver data</span><span class="named-paragraph-number">3.2</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::open_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">head</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure md_doc_state is accessed in 5/mrk and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP3_1" class="paragraph-anchor"></a><b>&#167;3.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Initialise the two stacks</span><span class="named-paragraph-number">3.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">marker_sp</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP8" class="function-link"><span class="function-syntax">MDBlockParser::clear_marker</span></a><span class="plain-syntax">(&amp;(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">]));</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP9" class="function-link"><span class="function-syntax">MDBlockParser::lift_marker_limit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">container_sp</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">] = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">containers</span><span class="plain-syntax">[0] = </span><span class="identifier-syntax">head</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP3">&#167;3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP3_2" class="paragraph-anchor"></a><b>&#167;3.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Initialise the receiver data</span><span class="named-paragraph-number">3.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">receiving_PARAGRAPH</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">receiving_CODE_ITEM</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">receiving_HTML</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">blank_matter_after_receiver</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>

<span class="plain-syntax">    </span><a href="5-mpi.html#SP6" class="function-link"><span class="function-syntax">MDBlockParser::clear_fencing_data</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP7" class="function-link"><span class="function-syntax">MDBlockParser::clear_HTML_data</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP3">&#167;3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. Receivers. </b>A "receiver" is a block into which actual copy, that is, text, is poured. In
theory that would include headings, but headings are created by converting
them from paragraphs, so they are not included here: thus, there are just three.
</p>

<p class="commentary">We can never have two different paragraphs both being receivers at the same
time, and so on, but it is possible for both a paragraph and a code block
to be receivers simultaneously during parsing (for reasons to do with lazy
continuation and blank lines). So although it is tempting to have just a
single variable, "the current receiver item", we can't do that.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::latest_paragraph</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::latest_paragraph</span></span>:<br/><a href="5-mpi.html#SP17">&#167;17</a>, <a href="5-mpi.html#SP24_3_1_1">&#167;24.3.1.1</a>, <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>, <a href="5-mpi.html#SP24_3_2_1">&#167;24.3.2.1</a>, <a href="5-mpi.html#SP24_3_2_2">&#167;24.3.2.2</a>, <a href="5-mpi.html#SP25_4">&#167;25.4</a>, <a href="5-mpi.html#SP25_8">&#167;25.8</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_PARAGRAPH</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::latest_HTML_block</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::latest_HTML_block</span></span>:<br/><a href="5-mpi.html#SP24_3_3_2">&#167;24.3.3.2</a>, <a href="5-mpi.html#SP24_3_3_2_1">&#167;24.3.3.2.1</a>, <a href="5-mpi.html#SP24_3_3_2_2">&#167;24.3.3.2.2</a>, <a href="5-mpi.html#SP24_3_3_1_2_2">&#167;24.3.3.1.2.2</a>, <a href="5-mpi.html#SP25_10">&#167;25.10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_HTML</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::latest_code_block</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::latest_code_block</span></span>:<br/><a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>, <a href="5-mpi.html#SP24_3_3_10">&#167;24.3.3.10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_CODE_ITEM</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
<span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::latest_receiver</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::latest_receiver</span></span>:<br/><a href="5-mpi.html#SP21">&#167;21</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PARAGRAPH_MIT:</span><span class="plain-syntax"> </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_PARAGRAPH</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_BLOCK_MIT:</span><span class="plain-syntax"> </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_CODE_ITEM</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MIT:</span><span class="plain-syntax"> </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_HTML</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5.  </b>These functions make a block a receiver, or make it stop being one.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::make_receiver</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::make_receiver</span></span>:<br/><a href="5-mpi.html#SP19">&#167;19</a>, <a href="5-mpi.html#SP21">&#167;21</a>, <a href="5-mpi.html#SP24_3_3_3">&#167;24.3.3.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PARAGRAPH_MIT:</span><span class="plain-syntax">  </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_PARAGRAPH</span><span class="plain-syntax"> = </span><span class="identifier-syntax">block</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_BLOCK_MIT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_CODE_ITEM</span><span class="plain-syntax"> = </span><span class="identifier-syntax">block</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MIT:</span><span class="plain-syntax">       </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_HTML</span><span class="plain-syntax"> = </span><span class="identifier-syntax">block</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_matter_after_receiver</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::remove_receiver</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::remove_receiver</span></span>:<br/><a href="5-mpi.html#SP19">&#167;19</a>, <a href="5-mpi.html#SP21">&#167;21</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PARAGRAPH_MIT:</span><span class="plain-syntax">  </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_PARAGRAPH</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_BLOCK_MIT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_CODE_ITEM</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MIT:</span><span class="plain-syntax">       </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">receiving_HTML</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6.  </b>"Fencing", in the sense of gardens not sword-fighting, happens when a
fenced code block is being parsed. This requires quite a bit of extra state,
since we are not allowed to match a fence <span class="extract"><span class="extract-syntax">~~~</span></span> with a fence <span class="extract"><span class="extract-syntax">````</span></span>, and so on.
The width of the fence is the number of characters used in its opening, so
for example 3 for <span class="extract"><span class="extract-syntax">~~~</span></span>.
</p>

<p class="commentary">Note that <span class="extract"><span class="extract-syntax">fencing_material</span></span> is always 0 when we are not parsing a fenced
code block.
</p>

<p class="commentary">The "left margin" is measured in character positions (not string index points)
and is the number of characters by which the fenced code block is indented,
when this is required. (This happens sometimes when fenced code blocks occur
inside list items, for example.)
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">md_fencing_data</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">material</span><span class="plain-syntax">; </span><span class="comment-syntax"> character used in the fence syntax</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">width</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">fenced_code</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">left_margin</span><span class="plain-syntax">; </span><span class="comment-syntax"> measured as a position, not a string index</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">md_fencing_data</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::clear_fencing_data</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::clear_fencing_data</span></span>:<br/><a href="5-mpi.html#SP3_2">&#167;3.2</a>, <a href="5-mpi.html#SP24_3_3_1_2_1">&#167;24.3.3.1.2.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">width</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">fenced_code</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">left_margin</span><span class="plain-syntax"> = -1; </span><span class="comment-syntax"> meaning "none"</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure md_fencing_data is accessed in 5/mpi2 and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7.  </b>Similarly, HTML blocks have closing syntax which depends on their opening
syntax, so we need to remember some state when parsing those, too.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::clear_HTML_data</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::clear_HTML_data</span></span>:<br/><a href="5-mpi.html#SP3_2">&#167;3.2</a>, <a href="5-mpi.html#SP24_3_3_1_2_2">&#167;24.3.3.1.2.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">HTML_end_condition</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. Markers. </b>Markers can survive from one line to the next, and indeed this is essential.
Consider the sequence
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    * Victorian stamps</span>
<span class="plain-syntax">      - Penny Black</span>
<span class="plain-syntax">    * Edwardian stamps</span>
</pre>
<p class="commentary">Three positional markers are obvious in this text, but in fact there's a fourth
implicit one. The line <span class="extract"><span class="extract-syntax">  - Penny Black</span></span> implicitly marks itself as being a subentry
of the outer entry, as if a ghostly asterisk were hiding behind the opening spacing.
In this case, we will parse that by preserving the marker from the previous line,
but flagging it as <span class="extract"><span class="extract-syntax">continues_from_earlier_line</span></span>.
</p>

<p class="commentary">Note that block quote markers are never flagged as continuing, because they work
differently: instead of being implicitly continued, block quotes are explicitly so.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    &gt; This is all part of</span>
<span class="plain-syntax">    &gt; the same block quote.</span>
</pre>
<p class="commentary">The <span class="extract"><span class="extract-syntax">blank_counts</span></span> keeps track of how many blank lines follow, and is needed only
because of the special rule that a list item cannot begin with two blank lines.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">item_type</span><span class="plain-syntax">; </span><span class="comment-syntax"> </span><span class="extract"><span class="extract-syntax">BLOCK_QUOTE_MIT</span></span><span class="comment-syntax">, </span><span class="extract"><span class="extract-syntax">ORDERED_LIST_ITEM_MIT</span></span><span class="comment-syntax"> or </span><span class="extract"><span class="extract-syntax">UNORDERED_LIST_ITEM_MIT</span></span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">indent</span><span class="plain-syntax">;                </span><span class="comment-syntax"> minimum required indentation for subsequent lines to continue</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">at</span><span class="plain-syntax">;                    </span><span class="comment-syntax"> character position (not string index) of the start of the marker</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">width</span><span class="plain-syntax">;                 </span><span class="comment-syntax"> for example, 2 for </span><span class="extract"><span class="extract-syntax">7) </span></span><span class="comment-syntax"> or </span><span class="extract"><span class="extract-syntax">7. </span></span><span class="comment-syntax">: the non-whitespace chars only</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">list_item_value</span><span class="plain-syntax">;       </span><span class="comment-syntax"> for example, 7 for </span><span class="extract"><span class="extract-syntax">7) </span></span><span class="comment-syntax"> or </span><span class="extract"><span class="extract-syntax">7. </span></span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">list_item_flavour</span><span class="plain-syntax">; </span><span class="comment-syntax"> for example, </span><span class="extract"><span class="extract-syntax">')'</span></span><span class="comment-syntax"> for </span><span class="extract"><span class="extract-syntax">7) </span></span><span class="comment-syntax"> and </span><span class="extract"><span class="extract-syntax">'.'</span></span><span class="comment-syntax"> for </span><span class="extract"><span class="extract-syntax">7. </span></span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">continues_from_earlier_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">blank_counts</span><span class="plain-syntax">;</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::clear_marker</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::clear_marker</span></span>:<br/><a href="5-mpi.html#SP3_1">&#167;3.1</a>, <a href="5-mpi.html#SP10">&#167;10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="comment-syntax"> which is not a valid item type: this will never be used</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">at</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">continues_from_earlier_line</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_value</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_flavour</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_counts</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure positional_marker is accessed in 4/jsn, 5/mrk, 5/mpi2 and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9.  </b>Ordinarily, we can parse markers to our heart's content, or at least up to
<span class="extract"><span class="extract-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span></span> of them. But sometimes we mustn't. Consider:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    ```</span>
<span class="plain-syntax">    &gt; * 1) Whatever</span>
<span class="plain-syntax">    ```</span>
</pre>
<p class="commentary">This is a fenced code block, so the tantalising string of potential markers,
<span class="extract"><span class="extract-syntax">&gt; * 1)</span></span>, is in fact part of the code being fenced. We need to prevent that,
so during the parsing of lines in such a block, the following limit is
imposed on the number of markers we are allowed to parse. (In this example, 0.)
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::impose_marker_limit</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::impose_marker_limit</span></span>:<br/><a href="5-mpi.html#SP24_3_3_3">&#167;24.3.3.3</a>, <a href="5-mpi.html#SP24_3_3_9">&#167;24.3.3.9</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">limit</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">temporary_marker_limit</span><span class="plain-syntax"> = </span><span class="identifier-syntax">limit</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::lift_marker_limit</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::lift_marker_limit</span></span>:<br/><a href="5-mpi.html#SP3_1">&#167;3.1</a>, <a href="5-mpi.html#SP24_3_3_1_2">&#167;24.3.3.1.2</a>, <a href="5-mpi.html#SP24_3_3_1_2_1">&#167;24.3.3.1.2.1</a>, <a href="5-mpi.html#SP24_3_3_1_2_2">&#167;24.3.3.1.2.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">temporary_marker_limit</span><span class="plain-syntax"> = </span><span class="constant-syntax">100000000</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10.  </b>The marker stack is only in some ways a stack: we have access at any time
to the markers at each level. Here, we put a new blank marker in place at
level <span class="extract"><span class="extract-syntax">position</span></span>: remember that this counts from 1, not from 0.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::new_marker_at</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::new_marker_at</span></span>:<br/><a href="5-mpi.html#SP17_2_1">&#167;17.2.1</a>, <a href="5-mpi.html#SP17_2_2">&#167;17.2.2</a>, <a href="5-mpi.html#SP17_2_3">&#167;17.2.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">position</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">type</span><span class="plain-syntax"> != </span><span class="constant-syntax">BLOCK_QUOTE_MIT</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">type</span><span class="plain-syntax"> != </span><span class="constant-syntax">UNORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">type</span><span class="plain-syntax"> != </span><span class="constant-syntax">ORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"bad type for marker stack"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">position</span><span class="plain-syntax"> &lt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">position</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"marker out of range"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> = &amp;(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">position</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP8" class="function-link"><span class="function-syntax">MDBlockParser::clear_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">marker</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> = </span><span class="identifier-syntax">type</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">marker</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11.  </b>And this gives access to the marker at any level.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::marker_at</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::marker_at</span></span>:<br/><a href="5-mpi.html#SP17_1">&#167;17.1</a>, <a href="5-mpi.html#SP18">&#167;18</a>, <a href="5-mpi.html#SP23">&#167;23</a>, <a href="5-mpi.html#SP24_3_3_1_1">&#167;24.3.3.1.1</a>, <a href="5-mpi.html#SP24_3_3_1_3">&#167;24.3.3.1.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">position</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">position</span><span class="plain-syntax"> &lt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">position</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> = &amp;(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">position</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">marker</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12.  </b>Inevitably, more notation:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::debug_positional_stack</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::debug_positional_stack</span></span>:<br/><a href="5-mpi.html#SP24">&#167;24</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=1; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i</span><span class="plain-syntax"> == </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"[top] "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">i</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">].</span><span class="element-syntax">item_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">)) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP12" class="function-link"><span class="function-syntax">MDBlockParser::debug_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, &amp;(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">]), (</span><span class="identifier-syntax">i</span><span class="plain-syntax"> == </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">-1)?</span><span class="identifier-syntax">TRUE:FALSE</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"empty"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::debug_marker</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::debug_marker</span></span>:<br/><a href="5-mpi.html#SP24_3_3_1_1">&#167;24.3.3.1.1</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">in_full</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) { </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;no-marker&gt;"</span><span class="plain-syntax">); </span><span class="reserved-syntax">return</span><span class="plain-syntax">; }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">continues_from_earlier_line</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"continuing:"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">BLOCK_QUOTE_MIT:</span><span class="plain-syntax">         </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&gt; "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">UNORDERED_LIST_ITEM_MIT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"(%c) "</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_flavour</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">ORDERED_LIST_ITEM_MIT:</span><span class="plain-syntax">   </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%d%c "</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                                        </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_value</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_flavour</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                                      </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;invalid-marker&gt;"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">in_full</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"[at=%d] "</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"[min-indent=%d] "</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_counts</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"[blanks=%d] "</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_counts</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13.  </b>Let's finally do some actual parsing. Block quote markers are very simple:
they are just <span class="extract"><span class="extract-syntax">&gt;</span></span> signs. The following function indicates success by advancing
the read position, and failure by not doing so.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::block_quote_marker</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::block_quote_marker</span></span>:<br/><a href="5-mpi.html#SP17_2_1">&#167;17.2.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">) != </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><a href="4-ts.html#SP5" class="function-link"><span class="function-syntax">TabbedStr::advance</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14.  </b>Bullet list markers are <span class="extract"><span class="extract-syntax">-</span></span>, <span class="extract"><span class="extract-syntax">+</span></span> or <span class="extract"><span class="extract-syntax">*</span></span>, this character being the "flavour".
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::bullet_list_marker</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::bullet_list_marker</span></span>:<br/><a href="5-mpi.html#SP17_2_2">&#167;17.2.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">flavour</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">old</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP16" class="function-link"><span class="function-syntax">MDBlockParser::thematic_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">.</span><span class="element-syntax">line</span><span class="plain-syntax">, </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_index</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">))) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">old</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'-'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'+'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'*'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP5" class="function-link"><span class="function-syntax">TabbedStr::advance</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        *</span><span class="identifier-syntax">flavour</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15.  </b>Ordered list markers are <span class="extract"><span class="extract-syntax">N)</span></span> or <span class="extract"><span class="extract-syntax">N.</span></span>, with the terminal character being the
flavour once more, and <span class="extract"><span class="extract-syntax">N</span></span> being a string of up to 9 decimal digits. These
can include leading zeros, but not minus signs, and can only be in decimal.
They are in fact almost entirely thrown away as information, as we'll see
when we get to rendering, but we parse them anyway.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::ordered_list_marker</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::ordered_list_marker</span></span>:<br/><a href="5-mpi.html#SP17_2_3">&#167;17.2.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> *</span><span class="identifier-syntax">v</span><span class="plain-syntax">, </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">flavour</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">old</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP16" class="function-link"><span class="function-syntax">MDBlockParser::thematic_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">.</span><span class="element-syntax">line</span><span class="plain-syntax">,</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_index</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">))) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">old</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">dc</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">val</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_ASCII_digit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">val</span><span class="plain-syntax"> = </span><span class="constant-syntax">10</span><span class="plain-syntax">*</span><span class="identifier-syntax">val</span><span class="plain-syntax"> + (</span><span class="reserved-syntax">int</span><span class="plain-syntax">) (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> - </span><span class="character-syntax">'0'</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP5" class="function-link"><span class="function-syntax">TabbedStr::advance</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">); </span><span class="identifier-syntax">dc</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">dc</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">1</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">dc</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">9</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">old</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'.'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">')'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        *</span><span class="identifier-syntax">flavour</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        *</span><span class="identifier-syntax">v</span><span class="plain-syntax"> = </span><span class="identifier-syntax">val</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP5" class="function-link"><span class="function-syntax">TabbedStr::advance</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">old</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16.  </b>A line which can be interpreted as a thematic break is never a list item,
so we need to parse those too. These always occur after the early phase in
which tabs count as spaces, so we no longer use a <span class="extract"><span class="extract-syntax">tabbed_string_iterator</span></span>
here. The function returns either true or false.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::thematic_marker</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::thematic_marker</span></span>:<br/><a href="5-mpi.html#SP14">&#167;14</a>, <a href="5-mpi.html#SP15">&#167;15</a>, <a href="5-mpi.html#SP25_2">&#167;25.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">index</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'-'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'_'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'*'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">j</span><span class="plain-syntax">=</span><span class="identifier-syntax">index</span><span class="plain-syntax">+1; </span><span class="identifier-syntax">j</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">j</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> == </span><span class="identifier-syntax">c</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">d</span><span class="plain-syntax"> != </span><span class="character-syntax">' '</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> != </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">3</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17.  </b>So now we're ready for the main function which parses the prefix to a line,
moving the scanner past the sequence of positional markers which appear to be
present. Note that we observe any temporary marker limit, and that in the
remote contingency of <span class="extract"><span class="extract-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span></span> being reached (e.g. if
somebody's cat stood on the "greater than" button when they weren't looking),
we simply ignore markers beyond that point.
</p>

<p class="commentary">On exit, the return value is the positional stack pointer, i.e., is the number
of markers read plus 1, and the line scanner has moved past each marker. If no
markers are found, the return value is 1 and the scanner has not moved.
</p>

<p class="commentary">The "left margin" is the width, in character positions, of any run of white
space at the start of the line. The first marker, if there is one, will
therefore begin at this character position.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::parse_positional_markers</span><button class="popup" onclick="togglePopup('usagePopup21')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup21">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::parse_positional_markers</span></span>:<br/><a href="5-mpi.html#SP24_1">&#167;24.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">; </span><span class="comment-syntax"> next positional stack position to store into</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">left_margin</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP8" class="function-link"><span class="function-syntax">TabbedStr::spaces_available</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRUE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">MAX_MARKDOWN_CONTAINER_DEPTH</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &gt;= </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temporary_marker_limit</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">rewind_point</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">interrupts_paragraph</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">)) </span><span class="identifier-syntax">interrupts_paragraph</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            ((</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">UNORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">                (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">ORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">interrupts_paragraph</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">available</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP8" class="function-link"><span class="function-syntax">TabbedStr::spaces_available</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP17_1" class="named-paragraph-link"><span class="named-paragraph">Is there enough space here to be able to infer a continuation of a marker?</span><span class="named-paragraph-number">17.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP17_2" class="named-paragraph-link"><span class="named-paragraph">Is there an explicit marker here?</span><span class="named-paragraph-number">17.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP17_1" class="paragraph-anchor"></a><b>&#167;17.1.  </b>Suppose we see these two lines in succession:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    2)   This is list entry two.</span>
<span class="plain-syntax">         It continues here.</span>
</pre>
<p class="commentary">The second line implies a continuation of the first because of the indentation
by five spaces, which is the <span class="extract"><span class="extract-syntax">width</span></span> recorded in marker 1 (i.e., the <span class="extract"><span class="extract-syntax">2)</span></span>)
recorded on line 1.
</p>

<p class="commentary">If we're in that position, we retain the marker from last time around, but
flag it as a continuation. (If we didn't, we would create a second list entry
also numbered <span class="extract"><span class="extract-syntax">2)</span></span>.)
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is there enough space here to be able to infer a continuation of a marker?</span><span class="named-paragraph-number">17.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP11" class="function-link"><span class="function-syntax">MDBlockParser::marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> != </span><span class="constant-syntax">BLOCK_QUOTE_MIT</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        ((</span><a href="4-ts.html#SP9" class="function-link"><span class="function-syntax">TabbedStr::blank_from_here</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">)) || (</span><span class="identifier-syntax">available</span><span class="plain-syntax"> &gt;= </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">            </span><a href="4-ts.html#SP7" class="function-link"><span class="function-syntax">TabbedStr::eat_spaces</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">].</span><span class="element-syntax">indent</span><span class="plain-syntax">, </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">continues_from_earlier_line</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP17">&#167;17</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP17_2" class="paragraph-anchor"></a><b>&#167;17.2.  </b>If there are more than four spaces, we have indented far enough to make this
a code block, so that any punctuation like <span class="extract"><span class="extract-syntax">17.</span></span> that we see past that point
would be part of the quoted code, not a marker.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is there an explicit marker here?</span><span class="named-paragraph-number">17.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">available</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">4</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP7" class="function-link"><span class="function-syntax">TabbedStr::eat_spaces</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">available</span><span class="plain-syntax">, </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">starts_at</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP17_2_1" class="named-paragraph-link"><span class="named-paragraph">Is there a block quote marker here?</span><span class="named-paragraph-number">17.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP17_2_2" class="named-paragraph-link"><span class="named-paragraph">Is there a bullet list marker here?</span><span class="named-paragraph-number">17.2.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP17_2_3" class="named-paragraph-link"><span class="named-paragraph">Is there an ordered list marker here?</span><span class="named-paragraph-number">17.2.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rewind_point</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP17">&#167;17</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP17_2_1" class="paragraph-anchor"></a><b>&#167;17.2.1.  </b>The "black width" of a marker is the width in characters of the actual
non-spaces used to express it: so, <span class="extract"><span class="extract-syntax">153. This is item 153.</span></span> has black width 3.
The "white width" is the black width plus the position width of any required
white spacing which follows. For block quote markers, no such spacing is
required - <span class="extract"><span class="extract-syntax">&gt;&gt; This is a legal double block quote</span></span> - and so the white width
is the same as the black width.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is there a block quote marker here?</span><span class="named-paragraph-number">17.2.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">BLOCK_QUOTES_MARKDOWNFEATURE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">adv</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP13" class="function-link"><span class="function-syntax">MDBlockParser::block_quote_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">starts_at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">black_width</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">) - </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">black_width</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><a href="4-ts.html#SP7" class="function-link"><span class="function-syntax">TabbedStr::eat_space</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">white_width</span><span class="plain-syntax"> = </span><span class="identifier-syntax">black_width</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">adv</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">bq_m</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP10" class="function-link"><span class="function-syntax">MDBlockParser::new_marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">, </span><span class="constant-syntax">BLOCK_QUOTE_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">bq_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> = </span><span class="identifier-syntax">black_width</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">bq_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">at</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">starts_at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">bq_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> = </span><span class="identifier-syntax">white_width</span><span class="plain-syntax"> + </span><a href="4-ts.html#SP8" class="function-link"><span class="function-syntax">TabbedStr::spaces_available</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">bq_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> += </span><span class="identifier-syntax">left_margin</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP17_2">&#167;17.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP17_2_2" class="paragraph-anchor"></a><b>&#167;17.2.2.  </b>Bullet list markers are not allowed to interrupt a paragraph going on from
the previous line: or rather, they are read as regular text if they do.
</p>

<p class="commentary">Bullets are recognised only as such if they occur at the end of the line, or
are followed by a single space. In the first case the white width equals the
black width, in the second case it is the black width plus 1.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is there a bullet list marker here?</span><span class="named-paragraph-number">17.2.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">UNORDERED_LISTS_MARKDOWNFEATURE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">flavour</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">adv</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP14" class="function-link"><span class="function-syntax">MDBlockParser::bullet_list_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">starts_at</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">flavour</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">black_width</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">) - </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">black_width</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">next</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">next</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">next</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                </span><a href="4-ts.html#SP7" class="function-link"><span class="function-syntax">TabbedStr::eat_space</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">white_width</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">) - </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">adv</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-ts.html#SP9" class="function-link"><span class="function-syntax">TabbedStr::blank_from_here</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">)) &amp;&amp; (</span><span class="identifier-syntax">interrupts_paragraph</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                    *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rewind_point</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">li_m</span><span class="plain-syntax"> =</span>
<span class="plain-syntax">                        </span><a href="5-mpi.html#SP10" class="function-link"><span class="function-syntax">MDBlockParser::new_marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">, </span><span class="constant-syntax">UNORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> = </span><span class="identifier-syntax">black_width</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">at</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">starts_at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> = </span><span class="identifier-syntax">white_width</span><span class="plain-syntax"> + </span><a href="4-ts.html#SP8" class="function-link"><span class="function-syntax">TabbedStr::spaces_available</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> += </span><span class="identifier-syntax">left_margin</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_flavour</span><span class="plain-syntax"> = </span><span class="identifier-syntax">flavour</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP17_2">&#167;17.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP17_2_3" class="paragraph-anchor"></a><b>&#167;17.2.3.  </b>Ordered list markers are allowed to interrupt a paragraph, but only if the
number used in them is 1, so that there's some evidence the author intended a
list and hasn't simply written something like:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    The Royal Philatelic Society London was founded on 10 April</span>
<span class="plain-syntax">    1869. Permission to use the prefix "Royal" was granted by King</span>
<span class="plain-syntax">    Edward VII in November 1906.</span>
</pre>
<p class="commentary">where we don't want to parse the <span class="extract"><span class="extract-syntax">1869.</span></span> as beginning a list with first
entry "Permission to use...".
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is there an ordered list marker here?</span><span class="named-paragraph-number">17.2.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">ORDERED_LISTS_MARKDOWNFEATURE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">flavour</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">val</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">adv</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP15" class="function-link"><span class="function-syntax">MDBlockParser::ordered_list_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">starts_at</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">val</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">flavour</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">black_width</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">) - </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">black_width</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">next</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP3" class="function-link"><span class="function-syntax">TabbedStr::get_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">next</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">next</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                </span><a href="4-ts.html#SP7" class="function-link"><span class="function-syntax">TabbedStr::eat_space</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">white_width</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">adv</span><span class="plain-syntax">) - </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">adv</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (((</span><a href="4-ts.html#SP9" class="function-link"><span class="function-syntax">TabbedStr::blank_from_here</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">)) || (</span><span class="identifier-syntax">val</span><span class="plain-syntax"> != </span><span class="constant-syntax">1</span><span class="plain-syntax">)) &amp;&amp; (</span><span class="identifier-syntax">interrupts_paragraph</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                    *</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rewind_point</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">li_m</span><span class="plain-syntax"> =</span>
<span class="plain-syntax">                        </span><a href="5-mpi.html#SP10" class="function-link"><span class="function-syntax">MDBlockParser::new_marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">, </span><span class="constant-syntax">ORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> = </span><span class="identifier-syntax">black_width</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">at</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">starts_at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> = </span><span class="identifier-syntax">white_width</span><span class="plain-syntax"> + </span><a href="4-ts.html#SP8" class="function-link"><span class="function-syntax">TabbedStr::spaces_available</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> += </span><span class="identifier-syntax">left_margin</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_flavour</span><span class="plain-syntax"> = </span><span class="identifier-syntax">flavour</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">li_m</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_value</span><span class="plain-syntax"> = </span><span class="identifier-syntax">val</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP17_2">&#167;17.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18.  </b>It's convenient to provide a quick way to test if the innermost marker is
for a list entry which is new this time around (i.e., not a continuation).
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="function-syntax">MDBlockParser::innermost_marker</span><button class="popup" onclick="togglePopup('usagePopup22')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup22">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::innermost_marker</span></span>:<br/><a href="5-mpi.html#SP24_2">&#167;24.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><a href="5-mpi.html#SP11" class="function-link"><span class="function-syntax">MDBlockParser::marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax"> - </span><span class="constant-syntax">1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::marker_is_list_entry</span><button class="popup" onclick="togglePopup('usagePopup23')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup23">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::marker_is_list_entry</span></span>:<br/><a href="5-mpi.html#SP24_2">&#167;24.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        ((</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">ORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">UNORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::marker_is_new_list_entry</span><button class="popup" onclick="togglePopup('usagePopup24')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup24">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::marker_is_new_list_entry</span></span>:<br/><a href="5-mpi.html#SP23">&#167;23</a>, <a href="5-mpi.html#SP24_2">&#167;24.2</a>, <a href="5-mpi.html#SP24_2_2">&#167;24.2.2</a>, <a href="5-mpi.html#SP24_3_3_1_1">&#167;24.3.3.1.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::marker_is_list_entry</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">marker</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">continues_from_earlier_line</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. Containers. </b>Enough on markers: we also need some preparatory work on container and leaf blocks.
</p>

<p class="commentary">A block can occasionally change type. For example, a <span class="extract"><span class="extract-syntax">PARAGRAPH_MIT</span></span> may turn
out to be a heading after all because of a subsequent setext underline, and then
it must become a <span class="extract"><span class="extract-syntax">HEADING_MIT</span></span>. We do this carefully to avoid getting the
receiver states cross-wired.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::change_type</span><button class="popup" onclick="togglePopup('usagePopup25')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup25">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::change_type</span></span>:<br/><a href="5-mpi.html#SP24_3_2_1">&#167;24.3.2.1</a>, <a href="5-mpi.html#SP27">&#167;27</a>, <a href="5-mpi.html#SP27_2">&#167;27.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">block</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">t</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"no block"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Change type: "</span><span class="plain-syntax">); </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">state</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">open</span><span class="plain-syntax">)) </span><a href="5-mpi.html#SP5" class="function-link"><span class="function-syntax">MDBlockParser::remove_receiver</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">type</span><span class="plain-syntax"> = </span><span class="identifier-syntax">t</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">state</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">open</span><span class="plain-syntax">)) </span><a href="5-mpi.html#SP5" class="function-link"><span class="function-syntax">MDBlockParser::make_receiver</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">" -&gt; "</span><span class="plain-syntax">); </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">); </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20.  </b>This marks a block as being followed by white space line(s) in the context
of its own container. Tracking this is annoying, but we need it in order to
determine whether lists are loose or tight when rendering.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::mark_block_with_ws</span><button class="popup" onclick="togglePopup('usagePopup26')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup26">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::mark_block_with_ws</span></span>:<br/><a href="5-mpi.html#SP24_2_4">&#167;24.2.4</a>, <a href="5-mpi.html#SP24_3_3_6">&#167;24.3.3.6</a>, <a href="5-mpi.html#SP30">&#167;30</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Mark as whitespace-following: "</span><span class="plain-syntax">); </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">whitespace_follows</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21.  </b>We have a not-very-important concept of blocks being open or closed. Only
leaf and container blocks can meaningfully be opened: for other items, <span class="extract"><span class="extract-syntax">block-&gt;open</span></span>
will remain <span class="extract"><span class="extract-syntax">NOT_APPLICABLE</span></span>. A block can be opened only once, and closed only
once, and it can only be closed after it has been opened.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::open_block</span><button class="popup" onclick="togglePopup('usagePopup27')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup27">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::open_block</span></span>:<br/><a href="5-mpi.html#SP3">&#167;3</a>, <a href="5-mpi.html#SP22">&#167;22</a>, <a href="5-mpi.html#SP24_3_3_1_3">&#167;24.3.3.1.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">open</span><span class="plain-syntax"> == </span><span class="constant-syntax">NOT_APPLICABLE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">open</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::close_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_receiver</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax">));</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP5" class="function-link"><span class="function-syntax">MDBlockParser::make_receiver</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::close_block</span><button class="popup" onclick="togglePopup('usagePopup28')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup28">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::close_block</span></span>:<br/><a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>, <a href="5-mpi.html#SP24_3_3_1_2">&#167;24.3.3.1.2</a>, <a href="5-mpi.html#SP24_3_3_1_2_2">&#167;24.3.3.1.2.2</a><br/>Markdown - <a href="5-mrk.html#SP5_1">&#167;5.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">at</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">at</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">open</span><span class="plain-syntax"> != </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Closing: "</span><span class="plain-syntax">); </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">); </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">STREAM_INDENT</span><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">open</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">ch</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">ch</span><span class="plain-syntax">; </span><span class="identifier-syntax">ch</span><span class="plain-syntax"> = </span><span class="identifier-syntax">ch</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::close_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">ch</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">STREAM_OUTDENT</span><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP5" class="function-link"><span class="function-syntax">MDBlockParser::remove_receiver</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP27" class="function-link"><span class="function-syntax">MDBlockParser::remove_link_references</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP22" class="paragraph-anchor"></a><b>&#167;22.  </b>So when are blocks opened? We've already seen that the <span class="extract"><span class="extract-syntax">DOCUMENT_MIT</span></span> block
is opened right at the start. As we will later see, container blocks are
opened when they are created. And the following function opens a new leaf
block and joins it to the tree:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span><button class="popup" onclick="togglePopup('usagePopup29')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup29">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></span>:<br/><a href="5-mpi.html#SP24_3_3_3">&#167;24.3.3.3</a>, <a href="5-mpi.html#SP24_3_3_7">&#167;24.3.3.7</a>, <a href="5-mpi.html#SP24_3_3_8">&#167;24.3.3.8</a>, <a href="5-mpi.html#SP24_3_3_9">&#167;24.3.3.9</a>, <a href="5-mpi.html#SP24_3_3_10">&#167;24.3.3.10</a>, <a href="5-mpi.html#SP24_3_3_11">&#167;24.3.3.11</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">block</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::open_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">block</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mrk.html#SP20" class="function-link"><span class="function-syntax">Markdown::add_to</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">block</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">-1]);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP23" class="paragraph-anchor"></a><b>&#167;23. Comparing the two stacks. </b>As we shall see, it's going to be essential when deciding on lazy continuation
to see if the markers currently in place would cause a change in the container
stack.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::container_will_change</span><button class="popup" onclick="togglePopup('usagePopup30')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup30">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::container_will_change</span></span>:<br/><a href="5-mpi.html#SP24_3_1">&#167;24.3.1</a>, <a href="5-mpi.html#SP24_3_1_1">&#167;24.3.1.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="function-syntax">&lt;state-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP11" class="function-link"><span class="function-syntax">MDBlockParser::marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax"> != </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::marker_is_new_list_entry</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">marker</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP24" class="paragraph-anchor"></a><b>&#167;24. The main function. </b>So, now we're off to the races. Unsurprisingly, we work from left to right.
We divide the line into four sections: left margin, positional markers,
intervening white space, and content. For example:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">      -  21)   Thomas Keay Tapling (1855-1891) was an English politician.</span>
<span class="plain-syntax">    mmpppppppppcccccccccccccccccccccccccccc</span>
<span class="plain-syntax">                  He played first-class cricket and was also an eminent philatelist</span>
<span class="plain-syntax">    mmpppppppppwwwccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc</span>
</pre>
<p class="commentary">Note that the intervening white space, if any, is the bonus white space beyond
any which is used to imply positional markers.
</p>

<p class="commentary">CommonMark requires that tabs are to be read as if spaces had been typed to
achieve the same effect as tabbed intervals of four spaces, but only for
purposes of determining block structure. So we parse with a tab-respecting
line scanner up to the beginning of the content, and then throw that away and
use regular string processing thereafter.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::add_to_document</span><button class="popup" onclick="togglePopup('usagePopup31')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup31">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::add_to_document</span></span>:<br/>Markdown - <a href="5-mrk.html#SP5_1">&#167;5.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"=======\nAdding '%S' to tree:\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mrk.html#SP52" class="function-link"><span class="function-syntax">Markdown::debug_subtree</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">tree_head</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Positional stack carried over: "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP12" class="function-link"><span class="function-syntax">MDBlockParser::debug_positional_stack</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temporary_marker_limit</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">100000000</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"(Marker limit %d is in force)"</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temporary_marker_limit</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">marker_sp_left_over_from_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">tabbed_string_iterator</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP1" class="function-link"><span class="function-syntax">TabbedStr::new</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="constant-syntax">4</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_1" class="named-paragraph-link"><span class="named-paragraph">Parse the left margin and the positional markers</span><span class="named-paragraph-number">24.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">indentation</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_2" class="named-paragraph-link"><span class="named-paragraph">Parse the white space between the markers and the content</span><span class="named-paragraph-number">24.2</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Line '%S' "</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"New positional stack: "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP12" class="function-link"><span class="function-syntax">MDBlockParser::debug_positional_stack</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3" class="named-paragraph-link"><span class="named-paragraph">Parse the content</span><span class="named-paragraph-number">24.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP24_1" class="paragraph-anchor"></a><b>&#167;24.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Parse the left margin and the positional markers</span><span class="named-paragraph-number">24.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">marker_sp</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP17" class="function-link"><span class="function-syntax">MDBlockParser::parse_positional_markers</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24">&#167;24</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_2" class="paragraph-anchor"></a><b>&#167;24.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Parse the white space between the markers and the content</span><span class="named-paragraph-number">24.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">ReparseIntervening:</span><span class="plain-syntax"> ;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">innermost</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::innermost_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_2_1" class="named-paragraph-link"><span class="named-paragraph">If the line is blank from here on, some of it may still be content</span><span class="named-paragraph-number">24.2.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">intervening_space_width</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP8" class="function-link"><span class="function-syntax">TabbedStr::spaces_available</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">intervening_space_width</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">4</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">INDENTED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_2_2" class="named-paragraph-link"><span class="named-paragraph">This line is indented enough to be part of an indented code block</span><span class="named-paragraph-number">24.2.2</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-ts.html#SP9" class="function-link"><span class="function-syntax">TabbedStr::blank_from_here</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::marker_is_new_list_entry</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">innermost</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_2_3" class="named-paragraph-link"><span class="named-paragraph">This line will open a list item with no content as yet</span><span class="named-paragraph-number">24.2.3</span></a></span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::marker_is_list_entry</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">innermost</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_2_4" class="named-paragraph-link"><span class="named-paragraph">But a list item cannot begin with two empty lines</span><span class="named-paragraph-number">24.2.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><a href="4-ts.html#SP7" class="function-link"><span class="function-syntax">TabbedStr::eat_spaces</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">intervening_space_width</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24">&#167;24</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_2_1" class="paragraph-anchor"></a><b>&#167;24.2.1.  </b>If the line contains only white space after the positional markers, that
does not necessarily mean there is no content. Consider:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    12)  ~~~</span>
<span class="plain-syntax">         This is a fenced code block.</span>

<span class="plain-syntax">         ~~~</span>
</pre>
<p class="commentary">Line 3 here contains an (implied) positional marker, since it's still part
of list item 12, but any white space occurring from the character position
underneath the <span class="extract"><span class="extract-syntax">T</span></span> onwards is part of the content, and must live on in the
code block. We deal with this by moving the read position of the line
scanner (which is currently at the end of the line, wherever that is)
back to the <span class="extract"><span class="extract-syntax">T</span></span> position.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">If the line is blank from here on, some of it may still be content</span><span class="named-paragraph-number">24.2.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-ts.html#SP9" class="function-link"><span class="function-syntax">TabbedStr::blank_from_here</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">innermost</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">continues_from_earlier_line</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><a href="4-ts.html#SP6" class="function-link"><span class="function-syntax">TabbedStr::seek</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">, </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">at</span><span class="plain-syntax"> + </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_2">&#167;24.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_2_2" class="paragraph-anchor"></a><b>&#167;24.2.2.  </b>Four or more spaces suggests indented code. If so, we want to consider
the intervening space as containing exactly four spaces (in position terms),
with any extras being part of the content. That requires us to set the
indentation level of a newly opening list item accordingly, so that on
subsequent lines the same margin will be followed.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">This line is indented enough to be part of an indented code block</span><span class="named-paragraph-number">24.2.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">indentation</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">; </span><span class="identifier-syntax">intervening_space_width</span><span class="plain-syntax"> = </span><span class="constant-syntax">4</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::marker_is_new_list_entry</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">innermost</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Opening line is code rule applies, and sets pos indent[%d] = %d\n"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">, </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> = </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_2">&#167;24.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_2_3" class="paragraph-anchor"></a><b>&#167;24.2.3.  </b>Suppose something like this:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    12)</span>
</pre>
<p class="commentary">where there is not enough white space after the <span class="extract"><span class="extract-syntax">)</span></span> to force indentation as a
new indented code block (i.e., of which the first line happens to be blank).
Where are we to set the indentation position for the <span class="extract"><span class="extract-syntax">12)</span></span>? We make it the
absolute minimum: the black width plus 1.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">This line will open a list item with no content as yet</span><span class="named-paragraph-number">24.2.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Opening line is empty rule applies, and sets pos indent[%d] = %d\n"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">, </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">indent</span><span class="plain-syntax"> = </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">width</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_counts</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_2">&#167;24.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_2_4" class="paragraph-anchor"></a><b>&#167;24.2.4.  </b>A list item is not permitted to begin with two blanks:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    11)</span>
<span class="plain-syntax">        This is part of list item 11.</span>

<span class="plain-syntax">    12)</span>

<span class="plain-syntax">        This is not part of list item 12.</span>
</pre>
<p class="commentary">So if we find ourselves in the situation of the blank line 5, we delete the
innermost marker, and go back to the start of the intervening space parsing,
because there's a new innermost marker now, and indentation also needs
reconsideration.
</p>

<p class="commentary">Note that we also have to mark the list item not being continued as being
followed by white space.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">But a list item cannot begin with two empty lines</span><span class="named-paragraph-number">24.2.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">innermost</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_counts</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Blank after blank opening rule applies\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP20" class="function-link"><span class="function-syntax">MDBlockParser::mark_block_with_ws</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">-1]);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">--;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">ReparseIntervening</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_2">&#167;24.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3" class="paragraph-anchor"></a><b>&#167;24.3.  </b>We finally reach the content, and move from tab-respecting-parsing with a
scanner to regular character-by-character parsing. <span class="extract"><span class="extract-syntax">content_index</span></span> is the
index position of the line at which content begins. There's actually a
tricky edge case here if we're in a code block where the content opens
with white space: we could find ourselves with the line scanner still midway
through a not-fully-consumed tab character. Infuriatingly, it is only
compliant with CommonMark to deal with this situation (by injecting additional
space characters not found in <span class="extract"><span class="extract-syntax">line</span></span>) in certain cases, so for now we have
to live with this uneasy worry.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Parse the content</span><span class="named-paragraph-number">24.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">content_index</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_index</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Indentation present. "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Content: '"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">content_index</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">            </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_char_briefly</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">));</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"'\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">NO_MDINTERPRETATIONS</span><span class="plain-syntax">], </span><span class="identifier-syntax">details</span><span class="plain-syntax">[</span><span class="constant-syntax">NO_MDINTERPRETATIONS</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_1" class="named-paragraph-link"><span class="named-paragraph">Work out the possible interpretations of this content</span><span class="named-paragraph-number">24.3.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">LAZY_CONTINUATION_MDINTERPRETATION</span><span class="plain-syntax">])</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_2" class="named-paragraph-link"><span class="named-paragraph">This is a lazy continuation</span><span class="named-paragraph-number">24.3.2</span></a></span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3" class="named-paragraph-link"><span class="named-paragraph">This is not a lazy continuation</span><span class="named-paragraph-number">24.3.3</span></a></span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24">&#167;24</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_1" class="paragraph-anchor"></a><b>&#167;24.3.1.  </b>"Interpretations" are possible ways to understand the context, and some
lines are open to multiple interpretations. We need to find all possible ways
because CommonMark requires us to consider lazy continuation only when no other
interpretation is possible.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Work out the possible interpretations of this content</span><span class="named-paragraph-number">24.3.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">which</span><span class="plain-syntax">&lt;</span><span class="constant-syntax">NO_MDINTERPRETATIONS</span><span class="plain-syntax">; </span><span class="identifier-syntax">which</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="identifier-syntax">which</span><span class="plain-syntax">] =</span>
<span class="plain-syntax">            </span><a href="5-mpi.html#SP25" class="function-link"><span class="function-syntax">MDBlockParser::can_interpret_as</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">indentation</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">which</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">, &amp;(</span><span class="identifier-syntax">details</span><span class="plain-syntax">[</span><span class="identifier-syntax">which</span><span class="plain-syntax">]));</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_1_1" class="named-paragraph-link"><span class="named-paragraph">Is this a lazy continuation?</span><span class="named-paragraph-number">24.3.1.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"interpretations: "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">which</span><span class="plain-syntax">&lt;</span><span class="constant-syntax">NO_MDINTERPRETATIONS</span><span class="plain-syntax">; </span><span class="identifier-syntax">which</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="identifier-syntax">which</span><span class="plain-syntax">]) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">c</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">which</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">WHITESPACE_MDINTERPRETATION:</span><span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"white? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">THEMATIC_MDINTERPRETATION:</span><span class="plain-syntax">          </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"thematic? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">ATX_HEADING_MDINTERPRETATION:</span><span class="plain-syntax">       </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"atx? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">SETEXT_UNDERLINE_MDINTERPRETATION:</span><span class="plain-syntax">  </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"setext? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MDINTERPRETATION:</span><span class="plain-syntax">              </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"html-open? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_FENCE_OPEN_MDINTERPRETATION:</span><span class="plain-syntax">   </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"fence-open? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION:</span><span class="plain-syntax">  </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"fence-close? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_BLOCK_MDINTERPRETATION:</span><span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"code? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">FENCED_CODE_BLOCK_MDINTERPRETATION:</span><span class="plain-syntax"> </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"fenced-code? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">LAZY_CONTINUATION_MDINTERPRETATION:</span><span class="plain-syntax"> </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"lazy-continuation? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_CONTINUATION_MDINTERPRETATION:</span><span class="plain-syntax"> </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"html-continuation? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"(none)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP23" class="function-link"><span class="function-syntax">MDBlockParser::container_will_change</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">)) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Container change coming\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3">&#167;24.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_1_1" class="paragraph-anchor"></a><b>&#167;24.3.1.1.  </b>This is a little subtle. It seems obvious enough that these lines all belong
to the same paragraph:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    By 1887 his collection was second only to that of Philippe Ferrari de La</span>
<span class="plain-syntax">    RenotiÃ¨re. Among his holdings were many world-famous rarities, including both</span>
<span class="plain-syntax">    values of the "Post Office" Mauritius and three examples of the Inverted</span>
<span class="plain-syntax">    Head Four Annas of India.</span>
</pre>
<p class="commentary">But "lazy continuation" goes further. It provides that if there is no indication
to the contrary, a line should be taken as a continuation of the current paragraph.
So for example:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    1) By 1887 his collection was second only to that of Philippe Ferrari de La</span>
<span class="plain-syntax">    RenotiÃ¨re. Among...</span>
</pre>
<p class="commentary">Here, all of the lines are part of list entry <span class="extract"><span class="extract-syntax">1)</span></span>. This is a different situation
from:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    1) By 1887 his collection was second only to that of Philippe Ferrari de La</span>
<span class="plain-syntax">       RenotiÃ¨re. Among...</span>
</pre>
<p class="commentary">where continuation occurs because the subsequent lines are indented to match
the list item marker's margin. The difference between these two cases is that
in the second case there is a continuing positional marker on the marker stack,
whereas in the first case there is not, since indentation was insufficient
for that.
</p>

<p class="commentary">The short version is that lines are LCs only if no other interpretation is
possible, but setext underlinings and certain kinds of raw HTML opening (but
not others) are exceptions to this. Because setext underlinings can be
syntactically identical to thematic division lines, we also have to ensure
that a thematic interpretation of that sort does not veto lazy continuation.
CommonMark requires close study here.
</p>

<p class="commentary">Note also that any requirement in the markers to create new list entries or
block quotes is enough to veto LC (this is what <span class="extract"><span class="extract-syntax">MDBlockParser::container_will_change</span></span>
is testing for), and of course, there has to be a paragraph going on or else
there is nothing to continue.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is this a lazy continuation?</span><span class="named-paragraph-number">24.3.1.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">        (</span><a href="5-mpi.html#SP23" class="function-link"><span class="function-syntax">MDBlockParser::container_will_change</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">) == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">lazy</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">SETEXT_UNDERLINE_MDINTERPRETATION</span><span class="plain-syntax">]) &amp;&amp;</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax"> == </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">THEMATIC_MDINTERPRETATION</span><span class="plain-syntax">] = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">which</span><span class="plain-syntax">&lt;</span><span class="constant-syntax">NO_MDINTERPRETATIONS</span><span class="plain-syntax">; </span><span class="identifier-syntax">which</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="identifier-syntax">which</span><span class="plain-syntax">]) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">SETEXT_UNDERLINE_MDINTERPRETATION</span><span class="plain-syntax">) </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">HTML_MDINTERPRETATION</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">                    (</span><span class="identifier-syntax">details</span><span class="plain-syntax">[</span><span class="identifier-syntax">which</span><span class="plain-syntax">] == </span><span class="constant-syntax">MISCPAIR_MDHTMLC</span><span class="plain-syntax">)) </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">lazy</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">LAZY_CONTINUATION_MDINTERPRETATION</span><span class="plain-syntax">] = </span><span class="identifier-syntax">lazy</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">LAZY_CONTINUATION_MDINTERPRETATION</span><span class="plain-syntax">] == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">SETEXT_UNDERLINE_MDINTERPRETATION</span><span class="plain-syntax">] = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_1">&#167;24.3.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_2" class="paragraph-anchor"></a><b>&#167;24.3.2.  </b>As noted above, what's lazy about lazy continuation is that the markers were
not fully specified to match the containers, so that <span class="extract"><span class="extract-syntax">marker_sp</span></span> is below
<span class="extract"><span class="extract-syntax">container_sp</span></span>. But the markers from last time are still there on the stack,
so to retrieve them, all we have to do is raise <span class="extract"><span class="extract-syntax">marker_sp</span></span> back to where it was.
</p>

<p class="commentary">As for the content, it's either paragraph copy or else a setext underline, but
can only be the latter if the alignment is right.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">This is a lazy continuation</span><span class="named-paragraph-number">24.3.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">marker_sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">marker_sp_left_over_from_last_line</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> == </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">SETEXT_UNDERLINE_MDINTERPRETATION</span><span class="plain-syntax">]))</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_2_1" class="named-paragraph-link"><span class="named-paragraph">Line is a setext underline and turns the existing paragraph into a heading</span><span class="named-paragraph-number">24.3.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_2_2" class="named-paragraph-link"><span class="named-paragraph">Line continues an existing paragraph</span><span class="named-paragraph-number">24.3.2.2</span></a></span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3">&#167;24.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3" class="paragraph-anchor"></a><b>&#167;24.3.3.  </b>With a sigh of relief, we're not in the lazy case here, and so the markers
are a true representation of what the containers ought to be. Since we're
not continuing a paragraph, it's now time to close any existing one, as it
can never be continued again.
</p>

<p class="commentary">The sequence of the interpretation tests is important here, as it decides
which take priority: for example, a blank line occurring inside HTML is
not white space and must be given the <span class="extract"><span class="extract-syntax">HTML_CONTINUATION_MDINTERPRETATION</span></span>.
Each of the 10 possible outcomes below ends with a <span class="extract"><span class="extract-syntax">return</span></span> from the function,
so exactly one will take effect.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">This is not a lazy continuation</span><span class="named-paragraph-number">24.3.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::close_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_code_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">CODE_BLOCK_MDINTERPRETATION</span><span class="plain-syntax">] == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">WHITESPACE_MDINTERPRETATION</span><span class="plain-syntax">] == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::close_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_code_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">));</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1" class="named-paragraph-link"><span class="named-paragraph">Make the container stack agree with the markers stack</span><span class="named-paragraph-number">24.3.3.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">HTML_CONTINUATION_MDINTERPRETATION</span><span class="plain-syntax">]) </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_2" class="named-paragraph-link"><span class="named-paragraph">Line is part of HTML</span><span class="named-paragraph-number">24.3.3.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span><span class="plain-syntax">])   </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_3" class="named-paragraph-link"><span class="named-paragraph">Line is an opening code fence</span><span class="named-paragraph-number">24.3.3.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION</span><span class="plain-syntax">])  </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_4" class="named-paragraph-link"><span class="named-paragraph">Line is a closing code fence</span><span class="named-paragraph-number">24.3.3.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">FENCED_CODE_BLOCK_MDINTERPRETATION</span><span class="plain-syntax">]) </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_5" class="named-paragraph-link"><span class="named-paragraph">Line is part of a fenced code block</span><span class="named-paragraph-number">24.3.3.5</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">WHITESPACE_MDINTERPRETATION</span><span class="plain-syntax">])        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_6" class="named-paragraph-link"><span class="named-paragraph">Line is whitespace</span><span class="named-paragraph-number">24.3.3.6</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">ATX_HEADING_MDINTERPRETATION</span><span class="plain-syntax">])       </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_7" class="named-paragraph-link"><span class="named-paragraph">Line is an ATX heading</span><span class="named-paragraph-number">24.3.3.7</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">THEMATIC_MDINTERPRETATION</span><span class="plain-syntax">])          </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_8" class="named-paragraph-link"><span class="named-paragraph">Line is a thematic break</span><span class="named-paragraph-number">24.3.3.8</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">HTML_MDINTERPRETATION</span><span class="plain-syntax">])              </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_9" class="named-paragraph-link"><span class="named-paragraph">Line opens HTML</span><span class="named-paragraph-number">24.3.3.9</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">CODE_BLOCK_MDINTERPRETATION</span><span class="plain-syntax">])        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_10" class="named-paragraph-link"><span class="named-paragraph">Line is part of an indented code block</span><span class="named-paragraph-number">24.3.3.10</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_11" class="named-paragraph-link"><span class="named-paragraph">Line opens a new paragraph</span><span class="named-paragraph-number">24.3.3.11</span></a></span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3">&#167;24.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_1" class="paragraph-anchor"></a><b>&#167;24.3.3.1.  </b>This is really the heart of the stacking algorithm: we've reached a point where
the row of markers has expressed a clear description of what the containers ought
to be. For example, if it read <span class="extract"><span class="extract-syntax">* * &gt; 2) Whatever</span></span>, we would have four items on
the marker stack, and we need to make sure that the container stack also has
four items (not counting item 0, the document head) which exactly match those
markers.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Make the container stack agree with the markers stack</span><span class="named-paragraph-number">24.3.3.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_1" class="named-paragraph-link"><span class="named-paragraph">Find the outermost point of current disagreement</span><span class="named-paragraph-number">24.3.3.1.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2" class="named-paragraph-link"><span class="named-paragraph">Close all existing containers inside that point</span><span class="named-paragraph-number">24.3.3.1.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_3" class="named-paragraph-link"><span class="named-paragraph">Open new containers as needed from that point to match the further markers</span><span class="named-paragraph-number">24.3.3.1.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Container stack:"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="function-syntax">&lt;state-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">" -&gt; "</span><span class="plain-syntax">); </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_1_1" class="paragraph-anchor"></a><b>&#167;24.3.3.1.1.  </b>The two stacks may in fact agree up to a certain point, but they diverge
as soon as they run into a non-continued list marker. For example, with the
lines:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    &gt; &gt; 1) Switzerland: Zurich: 1843 4 rappen, the unique unsevered horizontal strip of five;</span>
<span class="plain-syntax">    &gt; &gt; 2) Uruguay: 1858 120 centavos blue and 180 centavos green, in tÃªte beche pairs, two of five known;</span>
</pre>
<p class="commentary">the outermost point of disagreement (i.e., the leftmost) is at stack position
3, where the two numbered item markers live. The eventual effect will be to
change the container stack from:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    BLOCK_QUOTE_MIT</span>
<span class="plain-syntax">        BLOCK_QUOTE_MIT</span>
<span class="plain-syntax">            ORDERED_LIST_ITEM_MIT "Switzerland: Zurich: 1843..."</span>
</pre>
<p class="commentary">to become:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    BLOCK_QUOTE_MIT</span>
<span class="plain-syntax">        BLOCK_QUOTE_MIT</span>
<span class="plain-syntax">            ORDERED_LIST_ITEM_MIT "Uruguay: 1858 120 centavos..."</span>
</pre>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Find the outermost point of current disagreement</span><span class="named-paragraph-number">24.3.3.1.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">min_sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">min_sp</span><span class="plain-syntax">) </span><span class="identifier-syntax">min_sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">max_sp</span><span class="plain-syntax">) </span><span class="identifier-syntax">max_sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax"> = </span><span class="identifier-syntax">min_sp</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">min_sp</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP11" class="function-link"><span class="function-syntax">MDBlockParser::marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP18" class="function-link"><span class="function-syntax">MDBlockParser::marker_is_new_list_entry</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) == </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax"> = </span><span class="identifier-syntax">sp</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Stacks compared: "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">" WIPE"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax">=1; (</span><span class="identifier-syntax">sp</span><span class="function-syntax">&lt;state-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">sp</span><span class="function-syntax">&lt;state-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">); </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">" "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &gt;= </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"--"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><a href="5-mpi.html#SP12" class="function-link"><span class="function-syntax">MDBlockParser::debug_marker</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><a href="5-mpi.html#SP11" class="function-link"><span class="function-syntax">MDBlockParser::marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">), </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">" vs "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &gt;= </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"--"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><a href="5-mrk.html#SP51" class="function-link"><span class="function-syntax">Markdown::debug_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">STDOUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sp</span><span class="plain-syntax">+1 == </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">" WIPE"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_1">&#167;24.3.3.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_1_2" class="paragraph-anchor"></a><b>&#167;24.3.3.1.2.  </b>This looks straightforward, but we need to be aware that if we are closing
a container which contains an incomplete fenced code block (one which never
reached its closing fence) then it needs to be ended as the container does;
and similarly for raw HTML which has not yet, and now never will, reach its
ending line.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Close all existing containers inside that point</span><span class="named-paragraph-number">24.3.3.1.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">-1; </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> &gt;= </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="plain-syntax">--) {</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::close_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">] = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">container_sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temporary_marker_limit</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2_1" class="named-paragraph-link"><span class="named-paragraph">Close the code fence</span><span class="named-paragraph-number">24.3.3.1.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">FENCED_CODE_BLOCK_MDINTERPRETATION</span><span class="plain-syntax">] = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2_2" class="named-paragraph-link"><span class="named-paragraph">End the HTML block</span><span class="named-paragraph-number">24.3.3.1.2.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">interpretations</span><span class="plain-syntax">[</span><span class="constant-syntax">HTML_CONTINUATION_MDINTERPRETATION</span><span class="plain-syntax">] = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP9" class="function-link"><span class="function-syntax">MDBlockParser::lift_marker_limit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_1">&#167;24.3.3.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_1_3" class="paragraph-anchor"></a><b>&#167;24.3.3.1.3.  </b>And this is where all container items are born, except of course for the
outermost document item.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Open new containers as needed from that point to match the further markers</span><span class="named-paragraph-number">24.3.3.1.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">wipe_down_to_pos</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="function-syntax">&lt;state-&gt;</span><span class="element-syntax">marker_sp</span><span class="plain-syntax">; </span><span class="identifier-syntax">sp</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">positional_marker</span><span class="plain-syntax"> *</span><span class="identifier-syntax">marker</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP11" class="function-link"><span class="function-syntax">MDBlockParser::marker_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">sp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">newbq</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">item_type</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mrk.html#SP28" class="function-link"><span class="function-syntax">Markdown::set_item_number_and_flavour</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">newbq</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_value</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">list_item_flavour</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mrk.html#SP20" class="function-link"><span class="function-syntax">Markdown::add_to</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">newbq</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">-1]);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">container_sp</span><span class="plain-syntax">++] = </span><span class="identifier-syntax">newbq</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::open_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">newbq</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_1">&#167;24.3.3.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_2_1" class="paragraph-anchor"></a><b>&#167;24.3.2.1.  </b>That's it for the part of the algorithm which decides which interpretation
to give the content. There are 12 possible outcomes of that, and we'll give
them in the same priority sequence as was followed above.
</p>

<p class="commentary">First, the two paragraph-continuation cases, where a setext underline takes
priority. "Setext" stands for "Structure Enhanced Text", a precursor language
to Markdown created by Ian Feldman in 1991.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    Women in Philately</span>
<span class="plain-syntax">    ==================</span>
<span class="plain-syntax">    One of the earliest was Adelaide Lucy Fenton, who wrote articles in the</span>
<span class="plain-syntax">    1860s for the journal The Philatelist under the name Herbert Camoens.</span>
</pre>
<p class="commentary">This natural-looking notation survives in Markdown today, and line 2 above
is a "setext underline".
</p>

<p class="commentary">Dealing with it would be straightforward - simply make the paragraph item
holding "Women in Philately" a heading item, and throw the underline characters
away. But consider the following edge case:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    [pb]: /pennyblacks.html "Penny Black catalogue"</span>
<span class="plain-syntax">    -----</span>
</pre>
<p class="commentary">Here <span class="extract"><span class="extract-syntax">-----</span></span> looks like, and has been parsed as, a setext underline. But it
isn't, because in fact the whole paragraph was taken up with link references,
leaving it with no content. So the only way correctly to deal with this is to
remove the link references first and see if there's any para left.
</p>

<p class="commentary">It might seem tidier to deal with link references when they join paragraphs
but, infuriatingly, they can sometimes run across multiple lines, and moreover
can do so in a way such that the first line alone is also a valid link reference:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    [pb]: /pennyblacks.html</span>
<span class="plain-syntax">      "Penny Black catalogue"</span>
<span class="plain-syntax">    -----</span>
</pre>
<p class="commentary">So it is not safe to strip out link references until a paragraph is done.
In these cases where the apparent underline is, in fact, not an underline
because there was no content left, we have to preserve it as literal
content, opening a new paragraph to hold the <span class="extract"><span class="extract-syntax">-----</span></span>.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is a setext underline and turns the existing paragraph into a heading</span><span class="named-paragraph-number">24.3.2.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">headb</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">headb</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP27" class="function-link"><span class="function-syntax">MDBlockParser::remove_link_references</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">headb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">headb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">EMPTY_MIT</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_11" class="named-paragraph-link"><span class="named-paragraph">Line opens a new paragraph</span><span class="named-paragraph-number">24.3.3.11</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP19" class="function-link"><span class="function-syntax">MDBlockParser::change_type</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">headb</span><span class="plain-syntax">, </span><span class="constant-syntax">HEADING_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'='</span><span class="plain-syntax">) </span><a href="5-mrk.html#SP21" class="function-link"><span class="function-syntax">Markdown::set_heading_level</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">headb</span><span class="plain-syntax">, </span><span class="constant-syntax">1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><a href="5-mrk.html#SP21" class="function-link"><span class="function-syntax">Markdown::set_heading_level</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">headb</span><span class="plain-syntax">, </span><span class="constant-syntax">2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="4-sm.html#SP24" class="function-link"><span class="function-syntax">Str::trim_white_space</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">headb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_2">&#167;24.3.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_2_2" class="paragraph-anchor"></a><b>&#167;24.3.2.2.  </b>Actual paragraph continuation is much simpler.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line continues an existing paragraph</span><span class="named-paragraph-number">24.3.2.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">parb</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">parb</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">parb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">PARAGRAPH_MIT</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">parb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">parb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"no paragraph is open after all"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_2">&#167;24.3.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_2" class="paragraph-anchor"></a><b>&#167;24.3.3.2.  </b>Now for the 10 possibilities which don't fall under lazy continuations.
Top of the heap is an HTML continuation line. This may or may not meet the
criteria to be the final line. Note that in two cases of HTML start/end
conditions, the final line is white space, but is not to be included in the
material itself. In the other five cases, the final line is part of the matter.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is part of HTML</span><span class="named-paragraph-number">24.3.3.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">latest</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_HTML_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">latest</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2_2" class="named-paragraph-link"><span class="named-paragraph">End the HTML block</span><span class="named-paragraph-number">24.3.3.1.2.2</span></a></span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_2_2" class="named-paragraph-link"><span class="named-paragraph">Test for HTML end condition</span><span class="named-paragraph-number">24.3.3.2.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">latest</span><span class="plain-syntax">) &amp;&amp; (!((</span><span class="identifier-syntax">ends</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            ((</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax"> == </span><span class="constant-syntax">MISCSINGLE_MDHTMLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">                (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax"> == </span><span class="constant-syntax">MISCPAIR_MDHTMLC</span><span class="plain-syntax">)))))</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_2_1" class="named-paragraph-link"><span class="named-paragraph">Add text of line to HTML block</span><span class="named-paragraph-number">24.3.3.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ends</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2_2" class="named-paragraph-link"><span class="named-paragraph">End the HTML block</span><span class="named-paragraph-number">24.3.3.1.2.2</span></a></span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_3" class="paragraph-anchor"></a><b>&#167;24.3.3.3.  </b>Now to open a fenced code block, which means recording a lot of information
about it: the info string, if there is one, has to be preserved in the tree,
since it will be used during rendering to apply a CSS class. The other data
here is needed only during parsing, and remembers the syntax used here so that
we can make sure matching syntax is used on the closing line.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is an opening code fence</span><span class="named-paragraph-number">24.3.3.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">post_count</span><span class="plain-syntax"> = </span><span class="identifier-syntax">details</span><span class="plain-syntax">[</span><span class="constant-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">info_string</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP25" class="function-link"><span class="function-syntax">MDBlockParser::can_interpret_as</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">indentation</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">,</span>
<span class="plain-syntax">        </span><span class="constant-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span><span class="plain-syntax">, </span><span class="identifier-syntax">info_string</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cb</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">CODE_BLOCK_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">cb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">cb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">info_string</span><span class="plain-syntax"> = </span><span class="identifier-syntax">info_string</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP22" class="function-link"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">cb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">left_margin</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">width</span><span class="plain-syntax"> = </span><span class="identifier-syntax">post_count</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">fenced_code</span><span class="plain-syntax"> = </span><span class="identifier-syntax">cb</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP5" class="function-link"><span class="function-syntax">MDBlockParser::make_receiver</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">cb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP9" class="function-link"><span class="function-syntax">MDBlockParser::impose_marker_limit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_4" class="paragraph-anchor"></a><b>&#167;24.3.3.4.  </b>Next up, the closing line of a code fence. Note that this is not the only
way a fenced code block can end: it can also end when its container is closed,
see above.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is a closing code fence</span><span class="named-paragraph-number">24.3.3.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2_1" class="named-paragraph-link"><span class="named-paragraph">Close the code fence</span><span class="named-paragraph-number">24.3.3.1.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_1_2_1" class="paragraph-anchor"></a><b>&#167;24.3.3.1.2.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Close the code fence</span><span class="named-paragraph-number">24.3.3.1.2.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><a href="5-mpi.html#SP6" class="function-link"><span class="function-syntax">MDBlockParser::clear_fencing_data</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP9" class="function-link"><span class="function-syntax">MDBlockParser::lift_marker_limit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_1_2">&#167;24.3.3.1.2</a>, <a href="5-mpi.html#SP24_3_3_4">&#167;24.3.3.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_5" class="paragraph-anchor"></a><b>&#167;24.3.3.5.  </b>Next, a continuation line in a fenced code block. Here we're subject to the
tricky issue mentioned above where the line scanner working through tabs
early in the line and reading them as if they were spaces, may in fact be
only part-way through a tab at the start of the content. If that happens,
we need to inject artificial space characters into the code put into the block,
thus faking the same visual effect. (It does not comply with CommonMark to use a
tab for this: we must use the correct fraction of a tab, using spaces as quarter-tabs.)
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is part of a fenced code block</span><span class="named-paragraph-number">24.3.3.5</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">code_block</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">fenced_code</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">left_margin</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">left_margin</span><span class="plain-syntax"> &lt; </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_position</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP6" class="function-link"><span class="function-syntax">TabbedStr::seek</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">left_margin</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><a href="4-ts.html#SP4" class="function-link"><span class="function-syntax">TabbedStr::at_whole_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">) == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="character-syntax">' '</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP5" class="function-link"><span class="function-syntax">TabbedStr::advance</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_index</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_block</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_6" class="paragraph-anchor"></a><b>&#167;24.3.3.6.  </b>And next, white space! Where the content is entirely blank to the reader's eye.
But that doesn't mean it should be discarded. There's an edge case (those happy
words again) where something like this happens, where I'm typing underscores
in place of spaces to make it more visible:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    Here is some code:</span>

<span class="plain-syntax">    ____You can see this is a code block,</span>
<span class="plain-syntax">    ____because of the indentation by 4 spaces.</span>
<span class="plain-syntax">    _______</span>
<span class="plain-syntax">    ____Now this is part of the same code block, and although</span>
<span class="plain-syntax">    ____the whitespace line falling between the two looked blank,</span>
<span class="plain-syntax">    ____it actually contained more than 4 spaces of indentation,</span>
<span class="plain-syntax">    ____7 in fact, so three of those must be put into the block.</span>
</pre>
<p class="commentary">Those extra spaces are cached in <span class="extract"><span class="extract-syntax">state-&gt;blank_matter_after_receiver</span></span>. They
can't be added to the code block yet because, of course, we don't yet know
when parsing the blank line whether the future lines will continue the code
block or not. (In this example, they will, but we can't know that.)
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is whitespace</span><span class="named-paragraph-number">24.3.3.6</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sp</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">-1;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">markers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">].</span><span class="element-syntax">continues_from_earlier_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">ch</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">ch</span><span class="plain-syntax">; </span><span class="identifier-syntax">ch</span><span class="plain-syntax"> = </span><span class="identifier-syntax">ch</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">ch</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">ch</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> != </span><span class="constant-syntax">BLOCK_QUOTE_MIT</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                    </span><a href="5-mpi.html#SP20" class="function-link"><span class="function-syntax">MDBlockParser::mark_block_with_ws</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">ch</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><a href="5-mpi.html#SP20" class="function-link"><span class="function-syntax">MDBlockParser::mark_block_with_ws</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">containers</span><span class="plain-syntax">[</span><span class="identifier-syntax">sp</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">content_index</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_matter_after_receiver</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_matter_after_receiver</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_7" class="paragraph-anchor"></a><b>&#167;24.3.3.7.  </b>"ATX" was a direct precursor to Markdown, by Aaron Swartz, who collaborated
with John Gruber in its development: the term "ATX heading" preserves its
memory. (And indeed his. Whereas Gruber became a successful commentator and
Internet opinion-former through speech, Swartz's activism was more disruptive
and direct, and he was to be hounded to death by an overzealous Federal
prosecutor in 2013. He was just 26. But he deserves to be remembered for
pioneering work on RSS, podcasting, Reddit, Creative Commons, and numerous
other utopian Internet developments in that final decade when it was still
a hacker's playground. As with David Foster Wallace, we shall never know what
he might have gone on to give us.)
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is an ATX heading</span><span class="named-paragraph-number">24.3.3.7</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">hash_count</span><span class="plain-syntax"> = </span><span class="identifier-syntax">details</span><span class="plain-syntax">[</span><span class="constant-syntax">ATX_HEADING_MDINTERPRETATION</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">headb</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">HEADING_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mrk.html#SP21" class="function-link"><span class="function-syntax">Markdown::set_heading_level</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">headb</span><span class="plain-syntax">, </span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">H</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">headb</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">stashed</span><span class="plain-syntax"> = </span><span class="identifier-syntax">H</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_last_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_last_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_last_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">)-1; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&gt;=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">--) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::truncate</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="character-syntax">'#'</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_last_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_last_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_last_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">H</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP22" class="function-link"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">headb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_8" class="paragraph-anchor"></a><b>&#167;24.3.3.8.  </b>Next, a thematic break. Which couldn't be easier: there's no text to preserve.
All thematic breaks are identical leaf blocks in the tree.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is a thematic break</span><span class="named-paragraph-number">24.3.3.8</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">themb</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">THEMATIC_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP22" class="function-link"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">themb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_9" class="paragraph-anchor"></a><b>&#167;24.3.3.9.  </b>And now for a line which opens a verbatim HTML block. Something to look
out for is that sometimes the opening line is also the closing line for such
a block, so we need to test for that.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line opens HTML</span><span class="named-paragraph-number">24.3.3.9</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">HTML_end_condition</span><span class="plain-syntax"> = </span><span class="identifier-syntax">details</span><span class="plain-syntax">[</span><span class="constant-syntax">HTML_MDINTERPRETATION</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"enter HTML with end_condition = %d\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">htmlb</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">HTML_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">htmlb</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">stashed</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP22" class="function-link"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">htmlb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP9" class="function-link"><span class="function-syntax">MDBlockParser::impose_marker_limit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">container_sp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_2_1" class="named-paragraph-link"><span class="named-paragraph">Add text of line to HTML block</span><span class="named-paragraph-number">24.3.3.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_2_2" class="named-paragraph-link"><span class="named-paragraph">Test for HTML end condition</span><span class="named-paragraph-number">24.3.3.2.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ends</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP24_3_3_1_2_2" class="named-paragraph-link"><span class="named-paragraph">End the HTML block</span><span class="named-paragraph-number">24.3.3.1.2.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_2_1" class="paragraph-anchor"></a><b>&#167;24.3.3.2.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add text of line to HTML block</span><span class="named-paragraph-number">24.3.3.2.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">latest</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_HTML_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax"> = </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temporary_marker_limit</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">from</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="identifier-syntax">from</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">latest</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">latest</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_2">&#167;24.3.3.2</a>, <a href="5-mpi.html#SP24_3_3_9">&#167;24.3.3.9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_2_2" class="paragraph-anchor"></a><b>&#167;24.3.3.2.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Test for HTML end condition</span><span class="named-paragraph-number">24.3.3.2.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_HTML_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">) == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"HTML forcibly ended by closure of container\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"test '%S' for HTML_end_condition = %d\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PRE_MDHTMLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"&lt;/pre&gt;"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">                    (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"&lt;/script&gt;"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">                    (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"&lt;/style&gt;"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">                    (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"&lt;/textarea&gt;"</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">COMMENT_MDHTMLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"--&gt;"</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">QUERY_MDHTMLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"?&gt;"</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PLING_MDHTMLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"!&gt;"</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CDATA_MDHTMLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::includes</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"]]&gt;"</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">MISCSINGLE_MDHTMLC:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">MISCPAIR_MDHTMLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP23" class="function-link"><span class="function-syntax">Str::is_whitespace</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ends</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"test outcome: %s\n"</span><span class="plain-syntax">, (</span><span class="identifier-syntax">ends</span><span class="plain-syntax">)?</span><span class="string-syntax">"yes"</span><span class="plain-syntax">:</span><span class="string-syntax">"no"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_2">&#167;24.3.3.2</a>, <a href="5-mpi.html#SP24_3_3_9">&#167;24.3.3.9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_1_2_2" class="paragraph-anchor"></a><b>&#167;24.3.3.1.2.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">End the HTML block</span><span class="named-paragraph-number">24.3.3.1.2.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">latest</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_HTML_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP7" class="function-link"><span class="function-syntax">MDBlockParser::clear_HTML_data</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP9" class="function-link"><span class="function-syntax">MDBlockParser::lift_marker_limit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">latest</span><span class="plain-syntax">) </span><a href="5-mpi.html#SP21" class="function-link"><span class="function-syntax">MDBlockParser::close_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">latest</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3_1_2">&#167;24.3.3.1.2</a>, <a href="5-mpi.html#SP24_3_3_2">&#167;24.3.3.2</a> (twice), <a href="5-mpi.html#SP24_3_3_9">&#167;24.3.3.9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_10" class="paragraph-anchor"></a><b>&#167;24.3.3.10.  </b>And now for a continuation of an existing indented (but not fenced) code
block:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line is part of an indented code block</span><span class="named-paragraph-number">24.3.3.10</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">latest</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_code_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">latest</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">latest</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_matter_after_receiver</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">blank_matter_after_receiver</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cb</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">CODE_BLOCK_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">cb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">left_margin</span><span class="plain-syntax"> = -1;</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP22" class="function-link"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">cb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">latest</span><span class="plain-syntax"> = </span><span class="identifier-syntax">cb</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><a href="4-ts.html#SP4" class="function-link"><span class="function-syntax">TabbedStr::at_whole_character</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">) == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">latest</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="character-syntax">' '</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="4-ts.html#SP5" class="function-link"><span class="function-syntax">TabbedStr::advance</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="4-ts.html#SP2" class="function-link"><span class="function-syntax">TabbedStr::get_index</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">line_scanner</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">latest</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">latest</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP24_3_3_11" class="paragraph-anchor"></a><b>&#167;24.3.3.11.  </b>There's just one interpretation left to deal with, the lowest-priority
but a very common outcome:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Line opens a new paragraph</span><span class="named-paragraph-number">24.3.3.11</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">parb</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">PARAGRAPH_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">parb</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">stashed</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><a href="5-mpi.html#SP22" class="function-link"><span class="function-syntax">MDBlockParser::turn_over_a_new_leaf</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">parb</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">content_index</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">parb</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP24_3_3">&#167;24.3.3</a>, <a href="5-mpi.html#SP24_3_2_1">&#167;24.3.2.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25" class="paragraph-anchor"></a><b>&#167;25. Finding interpretations. </b>That finally completes the main "process a line" function, but we delegated
a whole lot of syntactic parsing to work out which interpretations for a line
are tenable. So, here goes.
</p>

<p class="commentary">The following always says no to <span class="extract"><span class="extract-syntax">LAZY_CONTINUATION_MDINTERPRETATION</span></span> because
it's not in a position to know: that decision depends on all the other
decisions, and on the situation at large as well. See above for where it is
actually decided.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">NO_MDINTERPRETATIONS</span><span class="plain-syntax"> </span><span class="constant-syntax">12</span><span class="plain-syntax"> </span><span class="comment-syntax"> well, okay, so there are actually 11, but...</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">WHITESPACE_MDINTERPRETATION</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">THEMATIC_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">ATX_HEADING_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">SETEXT_UNDERLINE_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">HTML_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">CODE_BLOCK_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">FENCED_CODE_BLOCK_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">HTML_CONTINUATION_MDINTERPRETATION</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">LAZY_CONTINUATION_MDINTERPRETATION</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::can_interpret_as</span><button class="popup" onclick="togglePopup('usagePopup32')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup32">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::can_interpret_as</span></span>:<br/><a href="5-mpi.html#SP24_3_1">&#167;24.3.1</a>, <a href="5-mpi.html#SP24_3_3_3">&#167;24.3.3.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">indentation</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text_details</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> *</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">which</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">WHITESPACE_MDINTERPRETATION:</span><span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_1" class="named-paragraph-link"><span class="named-paragraph">Is WHITESPACE_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">THEMATIC_MDINTERPRETATION:</span><span class="plain-syntax">          </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_2" class="named-paragraph-link"><span class="named-paragraph">Is THEMATIC_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">ATX_HEADING_MDINTERPRETATION:</span><span class="plain-syntax">       </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_3" class="named-paragraph-link"><span class="named-paragraph">Is ATX_HEADING_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">SETEXT_UNDERLINE_MDINTERPRETATION:</span><span class="plain-syntax">  </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_4" class="named-paragraph-link"><span class="named-paragraph">Is SETEXT_UNDERLINE_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_FENCE_OPEN_MDINTERPRETATION:</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION:</span><span class="plain-syntax">  </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_5" class="named-paragraph-link"><span class="named-paragraph">Is either code fence interpretation tenable?</span><span class="named-paragraph-number">25.5</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MDINTERPRETATION:</span><span class="plain-syntax">              </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7" class="named-paragraph-link"><span class="named-paragraph">Is HTML_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.7</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_BLOCK_MDINTERPRETATION:</span><span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_8" class="named-paragraph-link"><span class="named-paragraph">Is CODE_BLOCK_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.8</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">FENCED_CODE_BLOCK_MDINTERPRETATION:</span><span class="plain-syntax"> </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_9" class="named-paragraph-link"><span class="named-paragraph">Is FENCED_CODE_BLOCK_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.9</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_CONTINUATION_MDINTERPRETATION:</span><span class="plain-syntax"> </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_10" class="named-paragraph-link"><span class="named-paragraph">Is HTML_CONTINUATION_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.10</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">LAZY_CONTINUATION_MDINTERPRETATION:</span><span class="plain-syntax"> </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP25_1" class="paragraph-anchor"></a><b>&#167;25.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is WHITESPACE_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">content_index</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="character-syntax">' '</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="character-syntax">'\t'</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_2" class="paragraph-anchor"></a><b>&#167;25.2.  </b>Beware: indent a thematic marker like <span class="extract"><span class="extract-syntax">-  -  -</span></span> far enough, and it becomes
part of a code block, not a thematic break at all.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is THEMATIC_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">INDENTED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        &amp;&amp; (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">THEMATIC_MARKERS_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><a href="5-mpi.html#SP16" class="function-link"><span class="function-syntax">MDBlockParser::thematic_marker</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_3" class="paragraph-anchor"></a><b>&#167;25.3.  </b>One to six <span class="extract"><span class="extract-syntax">#</span></span> characters, followed by white space or the end of the line.
Note that there can be junk in the form of further <span class="extract"><span class="extract-syntax">#</span></span>s at the far end,
but removing that junk is not our business here.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is ATX_HEADING_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">INDENTED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        &amp;&amp; (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">ATX_HEADINGS_MARKDOWNFEATURE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">hash_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">) == </span><span class="character-syntax">'#'</span><span class="plain-syntax">) </span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">1</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax"> &lt;= </span><span class="constant-syntax">6</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">                (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">                (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+</span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax">) *</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax"> = </span><span class="identifier-syntax">hash_count</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_4" class="paragraph-anchor"></a><b>&#167;25.4.  </b>Provided we're following a paragraph, any sequence of 1 or more identical
<span class="extract"><span class="extract-syntax">-</span></span> or <span class="extract"><span class="extract-syntax">=</span></span> characters followed by white space to the end of the line is a
setext underline.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is SETEXT_UNDERLINE_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">) == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">INDENTED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        &amp;&amp; (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">SETEXT_HEADINGS_MARKDOWNFEATURE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'-'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'='</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="identifier-syntax">extraneous</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">j</span><span class="plain-syntax">=</span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+1;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">j</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">j</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> == </span><span class="identifier-syntax">c</span><span class="plain-syntax">) </span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">j</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">j</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">d</span><span class="plain-syntax"> != </span><span class="character-syntax">' '</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> != </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">extraneous</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">ornament_count</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">extraneous</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_5" class="paragraph-anchor"></a><b>&#167;25.5.  </b>A code fence is a run of three or more backticks or three or more tildes,
except that if it's to be a closing fence then it only works if it matches the
opening fence, using at least as many of the same character. Thus:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    ---</span>
<span class="plain-syntax">    ~~~~</span>
<span class="plain-syntax">    ~~~~</span>
<span class="plain-syntax">    --</span>
<span class="plain-syntax">    -----</span>
</pre>
<p class="commentary">is in fact a single fenced code block. Once line 1 has been accepted as being
a <span class="extract"><span class="extract-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span></span> case, the subsequent lines are not
the closing fence because they are too short or of the wrong kind, until we
reach line 5.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is either code fence interpretation tenable?</span><span class="named-paragraph-number">25.5</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">INDENTED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        &amp;&amp; (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">FENCED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">info_string</span><span class="plain-syntax"> = </span><span class="identifier-syntax">text_details</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> != </span><span class="identifier-syntax">c</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'`'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'~'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">post_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">j</span><span class="plain-syntax"> = </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">j</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">j</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> == </span><span class="identifier-syntax">c</span><span class="plain-syntax">) </span><span class="identifier-syntax">post_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">post_count</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">3</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">                    (</span><span class="identifier-syntax">post_count</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">width</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_5_1" class="named-paragraph-link"><span class="named-paragraph">Looks good so far, but what about the info string?</span><span class="named-paragraph-number">25.5.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_5_1" class="paragraph-anchor"></a><b>&#167;25.5.1.  </b>We need to deal with backslashes used as escape characters in the info
string, which is an optional run of characters following the opening fence
on the same line. Note that a code fence is illegal if unescaped backticks
are used in it, where the backtick is the fencing material. In such a case,
it is not enough to reject the info string, we must reject the interpretation
of the line as <span class="extract"><span class="extract-syntax">CODE_FENCE_OPEN_MDINTERPRETATION</span></span>.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Looks good so far, but what about the info string?</span><span class="named-paragraph-number">25.5.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ambiguous</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">, </span><span class="identifier-syntax">count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">j</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">j</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> == </span><span class="character-syntax">'\\'</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            (</span><a href="4-chr.html#SP5" class="function-link"><span class="function-syntax">Characters::is_ASCII_punctuation</span></a><span class="plain-syntax">(</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">+1))))</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">d</span><span class="plain-syntax"> == </span><span class="character-syntax">'`'</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="identifier-syntax">d</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ambiguous</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">info_string</span><span class="plain-syntax">, </span><span class="identifier-syntax">d</span><span class="plain-syntax">); </span><span class="identifier-syntax">count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><a href="4-sm.html#SP24" class="function-link"><span class="function-syntax">Str::trim_white_space</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">info_string</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">which</span><span class="plain-syntax"> == </span><span class="constant-syntax">CODE_FENCE_CLOSE_MDINTERPRETATION</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">count</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ambiguous</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax">) *</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax"> = </span><span class="identifier-syntax">post_count</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_5">&#167;25.5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_6" class="paragraph-anchor"></a><b>&#167;25.6.  </b>HTML blocks are runs of verbatim copy found inside the Markdown file and
passed straight through. This sounds easy, but the trick is to decide what
is, and isn't, HTML. The doctrine is that HTML begins on the first line which
meets a "start condition" and ends on the next which meets its corresponding
"end condition" (and that may be the same line, as noted above).
</p>

<p class="commentary">Simple enough? Infuriatingly, there are seven different pairs of start/end
condition for HTML blocks, referred to in CommonMark as types. They must not
quite be tested in their numerical order, since type 4 implies type 5, so
5 must be checked before 4.
</p>

<p class="commentary">The one piece of good news is that they all start with a <span class="extract"><span class="extract-syntax">&lt;</span></span> character.
</p>

<pre class="definitions code-font"><span class="definition-keyword">enum</span> <span class="constant-syntax">PRE_MDHTMLC</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">   </span><span class="comment-syntax"> CommonMark type 1</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">COMMENT_MDHTMLC</span><span class="plain-syntax">      </span><span class="comment-syntax"> CommonMark type 2</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">QUERY_MDHTMLC</span><span class="plain-syntax">        </span><span class="comment-syntax"> CommonMark type 3</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">PLING_MDHTMLC</span><span class="plain-syntax">        </span><span class="comment-syntax"> CommonMark type 4</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">CDATA_MDHTMLC</span><span class="plain-syntax">        </span><span class="comment-syntax"> CommonMark type 5</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">MISCSINGLE_MDHTMLC</span><span class="plain-syntax">   </span><span class="comment-syntax"> CommonMark type 6</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">MISCPAIR_MDHTMLC</span><span class="plain-syntax">     </span><span class="comment-syntax"> CommonMark type 7</span>
</pre>
<p class="commentary firstcommentary"><a id="SP25_7" class="paragraph-anchor"></a><b>&#167;25.7.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is HTML_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.7</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">INDENTED_CODE_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        &amp;&amp; (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">HTML_BLOCKS_MARKDOWNFEATURE</span><span class="plain-syntax">) == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'&lt;'</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="comment-syntax"> not a valid condition</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="identifier-syntax">content_index</span><span class="plain-syntax">+1; </span><span class="comment-syntax"> i.e., the index after the </span><span class="extract"><span class="extract-syntax">&lt;</span></span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">)) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_1" class="named-paragraph-link"><span class="named-paragraph">Is a PRE_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_2" class="named-paragraph-link"><span class="named-paragraph">Is a COMMENT_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_3" class="named-paragraph-link"><span class="named-paragraph">Is a QUERY_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_4" class="named-paragraph-link"><span class="named-paragraph">Is a CDATA_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_5" class="named-paragraph-link"><span class="named-paragraph">Is a PLING_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.5</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_first_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) == </span><span class="character-syntax">'/'</span><span class="plain-syntax">) </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_first_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><a href="4-sm.html#SP14" class="function-link"><span class="function-syntax">Str::put_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'/'</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+1) == </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><a href="4-sm.html#SP14" class="function-link"><span class="function-syntax">Str::put_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_6" class="named-paragraph-link"><span class="named-paragraph">Is a MISCSINGLE_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.6</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP25_7_7" class="named-paragraph-link"><span class="named-paragraph">Is a MISCPAIR_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.7</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">HTML_Start_Found:</span><span class="plain-syntax"> ;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">)</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax">) *</span><span class="identifier-syntax">int_detail</span><span class="plain-syntax"> = </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_1" class="paragraph-anchor"></a><b>&#167;25.7.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a PRE_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"pre"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"script"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"style"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"textarea"</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">PRE_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_2" class="paragraph-anchor"></a><b>&#167;25.7.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a COMMENT_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP21" class="function-link"><span class="function-syntax">Str::begins_with</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"!--"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">COMMENT_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_3" class="paragraph-anchor"></a><b>&#167;25.7.3.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a QUERY_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP21" class="function-link"><span class="function-syntax">Str::begins_with</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"?"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">QUERY_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_4" class="paragraph-anchor"></a><b>&#167;25.7.4.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a CDATA_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP21" class="function-link"><span class="function-syntax">Str::begins_with</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"![CDATA["</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">CDATA_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_5" class="paragraph-anchor"></a><b>&#167;25.7.5.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a PLING_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.5</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP21" class="function-link"><span class="function-syntax">Str::begins_with</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"!"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">PLING_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_6" class="paragraph-anchor"></a><b>&#167;25.7.6.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a MISCSINGLE_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.6</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"address"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"article"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"aside"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"base"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"basefont"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"blockquote"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"body"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"caption"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"center"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"col"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"colgroup"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"dd"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"details"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"dialog"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"dir"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"div"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"dl"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"dt"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"fieldset"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"figcaption"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"figure"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"footer"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"form"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"frame"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"frameset"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"h1"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"h2"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"h3"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"h4"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"h5"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"h6"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"head"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"header"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"hr"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"html"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"iframe"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"legend"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"li"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"link"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"main"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"menu"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"menuitem"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"nav"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"noframes"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"ol"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"optgroup"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"option"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"p"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"param"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"section"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"source"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"summary"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"table"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"tbody"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"td"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"tfoot"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"th"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"thead"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"title"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"tr"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"track"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"ul"</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">MISCSINGLE_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_7_7" class="paragraph-anchor"></a><b>&#167;25.7.7.  </b>And now the really painful one. See CommonMark, but basically this is
where we have what looks like a tag and is not one that would cause <span class="extract"><span class="extract-syntax">PRE_MDHTMLC</span></span>,
but can also be followed by HTML attributes and values: for example,
<span class="extract"><span class="extract-syntax">&lt;img src="this"&gt;</span></span> would be matched by the following.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is a MISCPAIR_MDHTMLC type HTML opening tenable?</span><span class="named-paragraph-number">25.7.7</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="4-sm.html#SP24" class="function-link"><span class="function-syntax">Str::trim_white_space</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_first_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) == </span><span class="character-syntax">'&lt;'</span><span class="plain-syntax">) { </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_first_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">); </span><a href="4-sm.html#SP24" class="function-link"><span class="function-syntax">Str::trim_white_space</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">); }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">, </span><span class="identifier-syntax">closing</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_first_char</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) == </span><span class="character-syntax">'/'</span><span class="plain-syntax">) { </span><span class="identifier-syntax">closing</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">; </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_first_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">); }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_ASCII_letter</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">            ((</span><span class="identifier-syntax">i</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; ((</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_ASCII_digit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'-'</span><span class="plain-syntax">))))</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"pre"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"script"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"style"</span><span class="plain-syntax">)) ||</span>
<span class="plain-syntax">        (</span><a href="4-sm.html#SP19" class="function-link"><span class="function-syntax">Str::eq_insensitive</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"textarea"</span><span class="plain-syntax">))) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag_name</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">closing</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRUE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">' '</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'_'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">':'</span><span class="plain-syntax">) || (</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_ASCII_letter</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'_'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">':'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'.'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'-'</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">                    (</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_ASCII_letter</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)) || (</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_ASCII_digit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'='</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\''</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'\''</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                        }</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'"'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'"'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                        }</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">nc</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">' '</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'\n'</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'"'</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">                            (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'\''</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'='</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'&lt;'</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'`'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">nc</span><span class="plain-syntax">++; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                        }</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">nc</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    }</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">closing</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'/'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">valid</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">condition_type</span><span class="plain-syntax"> = </span><span class="constant-syntax">MISCPAIR_MDHTMLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">goto</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_Start_Found</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25_7">&#167;25.7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_8" class="paragraph-anchor"></a><b>&#167;25.8.  </b>After which, the rest are anticlimactic: they are all forms of continuation
of blocks already under way.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is CODE_BLOCK_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.8</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">indentation</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_9" class="paragraph-anchor"></a><b>&#167;25.9.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is FENCED_CODE_BLOCK_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.9</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fencing</span><span class="plain-syntax">.</span><span class="element-syntax">material</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25_10" class="paragraph-anchor"></a><b>&#167;25.10.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Is HTML_CONTINUATION_MDINTERPRETATION tenable?</span><span class="named-paragraph-number">25.10</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="5-mpi.html#SP4" class="function-link"><span class="function-syntax">MDBlockParser::latest_HTML_block</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">HTML_end_condition</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP25">&#167;25</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP26" class="paragraph-anchor"></a><b>&#167;26.  </b>The function above makes use of the following, where we skip white space provided
we do not skip an entire visually blank line.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::advance_past_spacing</span><button class="popup" onclick="togglePopup('usagePopup33')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup33">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></span>:<br/><a href="5-mpi.html#SP25_7_7">&#167;25.7.7</a>, <a href="5-mpi.html#SP27_1">&#167;27.1</a>, <a href="5-mpi.html#SP27_1_2">&#167;27.1.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">newlines</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">newlines</span><span class="plain-syntax">++; </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">newlines</span><span class="plain-syntax"> == </span><span class="constant-syntax">2</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP27" class="paragraph-anchor"></a><b>&#167;27. Parsing link references. </b>When a paragraph contains link references, that will be at the beginning,
and they need to be excised. Since this can in principle leave the paragraph
entirely denuded of text, we may need to convert it to an <span class="extract"><span class="extract-syntax">EMPTY_MIT</span></span> node.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::remove_link_references</span><button class="popup" onclick="togglePopup('usagePopup34')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup34">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::remove_link_references</span></span>:<br/><a href="5-mpi.html#SP21">&#167;21</a>, <a href="5-mpi.html#SP24_3_2_1">&#167;24.3.2.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">at</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">PARAGRAPH_MIT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">matched_to</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="identifier-syntax">matched_to</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">matched_to</span><span class="plain-syntax"> = -1;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">X</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">stashed</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP27_1" class="named-paragraph-link"><span class="named-paragraph">Try to match a single link reference</span><span class="named-paragraph-number">27.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">matched_to</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_n_characters</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">, </span><span class="identifier-syntax">matched_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">stashed</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><a href="5-mpi.html#SP19" class="function-link"><span class="function-syntax">MDBlockParser::change_type</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">, </span><span class="constant-syntax">EMPTY_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mv.html#SP4" class="function-link"><span class="function-syntax">MarkdownVariations::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">variation</span><span class="plain-syntax">, </span><span class="constant-syntax">TABLES_MARKDOWNFEATURE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP27_2" class="named-paragraph-link"><span class="named-paragraph">See if this is really a table</span><span class="named-paragraph-number">27.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP27_1" class="paragraph-anchor"></a><b>&#167;27.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Try to match a single link reference</span><span class="named-paragraph-number">27.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'['</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">ws_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">label</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP27_1_1" class="named-paragraph-link"><span class="named-paragraph">Find the label text</span><span class="named-paragraph-number">27.1.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">':'</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">count</span><span class="plain-syntax"> &lt;= </span><span class="constant-syntax">999</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">ws_count</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">count</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>

<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>

<span class="plain-syntax">            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">destination</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">title</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP27_1_2" class="named-paragraph-link"><span class="named-paragraph">Find the destination and title texts</span><span class="named-paragraph-number">27.1.2</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">valid</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><a href="5-mrk.html#SP48" class="function-link"><span class="function-syntax">Markdown::create</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">link_references</span><span class="plain-syntax">, </span><span class="identifier-syntax">label</span><span class="plain-syntax">, </span><span class="identifier-syntax">destination</span><span class="plain-syntax">, </span><span class="identifier-syntax">title</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">matched_to</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">destination</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">title</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">label</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP27">&#167;27</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP27_1_1" class="paragraph-anchor"></a><b>&#167;27.1.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Find the label text</span><span class="named-paragraph-number">27.1.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\\'</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-chr.html#SP5" class="function-link"><span class="function-syntax">Characters::is_ASCII_punctuation</span></a><span class="plain-syntax">(</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+1)))) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">']'</span><span class="plain-syntax">) { </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="reserved-syntax">break</span><span class="plain-syntax">; }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'['</span><span class="plain-syntax">) { </span><span class="identifier-syntax">count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">; }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ws_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">label</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP27_1">&#167;27.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP27_1_2" class="paragraph-anchor"></a><b>&#167;27.1.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Find the destination and title texts</span><span class="named-paragraph-number">27.1.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'&lt;'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">'\n'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\\'</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-chr.html#SP5" class="function-link"><span class="function-syntax">Characters::is_ASCII_punctuation</span></a><span class="plain-syntax">(</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+1)))) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">destination</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_control_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">) == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">bl</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> != </span><span class="character-syntax">' '</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-chr.html#SP8" class="function-link"><span class="function-syntax">Characters::is_control_character</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">) == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\\'</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-chr.html#SP5" class="function-link"><span class="function-syntax">Characters::is_ASCII_punctuation</span></a><span class="plain-syntax">(</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+1)))) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'('</span><span class="plain-syntax">) </span><span class="identifier-syntax">bl</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">')'</span><span class="plain-syntax">) { </span><span class="identifier-syntax">bl</span><span class="plain-syntax">--; </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">bl</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">; }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">destination</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">bl</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">ws_count</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">stop_here</span><span class="plain-syntax"> = -1;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">valid</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">stop_here</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP26" class="function-link"><span class="function-syntax">MDBlockParser::advance_past_spacing</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">ws_count</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax"> - </span><span class="identifier-syntax">ws_count</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">quot</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'"'</span><span class="plain-syntax">) </span><span class="identifier-syntax">quot</span><span class="plain-syntax"> = </span><span class="character-syntax">'"'</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\''</span><span class="plain-syntax">) </span><span class="identifier-syntax">quot</span><span class="plain-syntax"> = </span><span class="character-syntax">'\''</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">ws_count</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">quot</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\\'</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-chr.html#SP5" class="function-link"><span class="function-syntax">Characters::is_ASCII_punctuation</span></a><span class="plain-syntax">(</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+1)))) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="identifier-syntax">quot</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">title</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="identifier-syntax">quot</span><span class="plain-syntax">) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="character-syntax">'\n'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">valid</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">stop_here</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">)) { </span><span class="identifier-syntax">valid</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="identifier-syntax">stop_here</span><span class="plain-syntax">+1; }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP27_1">&#167;27.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP27_2" class="paragraph-anchor"></a><b>&#167;27.2.  </b>This is a GitHub-flavored Markdown extension:
</p>

<p class="commentary">"A table is an arrangement of data with rows and columns, consisting of a single
header row, a delimiter row separating the header from the data, and zero or
more data rows.
</p>

<p class="commentary">Each row consists of cells containing arbitrary text, in which inlines are
parsed, separated by pipes. A leading and trailing pipe is also recommended
for clarity of reading, and if thereâs otherwise parsing ambiguity. Spaces
between pipes and cell content are trimmed. Block-level elements cannot be
inserted in a table.
</p>

<p class="commentary">The delimiter row consists of cells whose only content are hyphens, and
optionally, a leading or trailing colon, or both, to indicate left, right,
or center alignment respectively."
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">See if this is really a table</span><span class="named-paragraph-number">27.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">X</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">line2</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">remainder_at</span><span class="plain-syntax"> = -1;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0, </span><span class="identifier-syntax">counter</span><span class="plain-syntax">=1; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">) </span><span class="identifier-syntax">counter</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> == </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> == </span><span class="constant-syntax">2</span><span class="plain-syntax">) </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">line2</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> == </span><span class="constant-syntax">3</span><span class="plain-syntax">) { </span><span class="identifier-syntax">remainder_at</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">; }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cell_count1</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP28" class="function-link"><span class="function-syntax">MDBlockParser::count_cells</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">, </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cell_count2</span><span class="plain-syntax"> = </span><a href="5-mpi.html#SP28" class="function-link"><span class="function-syntax">MDBlockParser::count_cells</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line2</span><span class="plain-syntax">, </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tracing_Markdown_parser</span><span class="plain-syntax">) </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Try as table: cells %d, %d\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">cell_count1</span><span class="plain-syntax">, </span><span class="identifier-syntax">cell_count2</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">cell_count1</span><span class="plain-syntax"> == </span><span class="identifier-syntax">cell_count2</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">cell_count1</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP19" class="function-link"><span class="function-syntax">MDBlockParser::change_type</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">, </span><span class="constant-syntax">TABLE_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mrk.html#SP22" class="function-link"><span class="function-syntax">Markdown::set_column_count</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">at</span><span class="plain-syntax">, </span><span class="identifier-syntax">cell_count1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP28" class="function-link"><span class="function-syntax">MDBlockParser::count_cells</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line2</span><span class="plain-syntax">, </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP28" class="function-link"><span class="function-syntax">MDBlockParser::count_cells</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">, </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">remainder_at</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">remainder_at</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><a href="5-mpi.html#SP28" class="function-link"><span class="function-syntax">MDBlockParser::count_cells</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">, </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><a href="5-mpi.html#SP28" class="function-link"><span class="function-syntax">MDBlockParser::count_cells</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">, </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">line1</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">line2</span><span class="plain-syntax">)</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP27">&#167;27</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP28" class="paragraph-anchor"></a><b>&#167;28.  </b></p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::count_cells</span><button class="popup" onclick="togglePopup('usagePopup35')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup35">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::count_cells</span></span>:<br/><a href="5-mpi.html#SP27_2">&#167;27.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">is_delimiter_row</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">table_item</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">col_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">table_item</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">is_delimiter_row</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">md</span><span class="plain-syntax"> = </span><span class="identifier-syntax">table_item</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">md</span><span class="plain-syntax">; </span><span class="identifier-syntax">md</span><span class="plain-syntax"> = </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">) </span><span class="identifier-syntax">col_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">row_item</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">table_item</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">row_item</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TABLE_ROW_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="5-mrk.html#SP20" class="function-link"><span class="function-syntax">Markdown::add_to</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">row_item</span><span class="plain-syntax">, </span><span class="identifier-syntax">table_item</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">edge_pipes</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'|'</span><span class="plain-syntax">) { </span><span class="identifier-syntax">edge_pipes</span><span class="plain-syntax">++; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++; }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">j</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">) - </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">j</span><span class="plain-syntax">--;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">) == </span><span class="character-syntax">'|'</span><span class="plain-syntax">) { </span><span class="identifier-syntax">edge_pipes</span><span class="plain-syntax">++; </span><span class="identifier-syntax">j</span><span class="plain-syntax">--; }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cell_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">, </span><span class="identifier-syntax">cell_number</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">k</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax">; </span><span class="identifier-syntax">k</span><span class="plain-syntax"> &lt;= </span><span class="identifier-syntax">j</span><span class="plain-syntax">; </span><span class="identifier-syntax">k</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">k</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\\'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'|'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">cell_count</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">cell_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">2</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">cell_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP28_1" class="named-paragraph-link"><span class="named-paragraph">Deal with cell contents</span><span class="named-paragraph-number">28.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><a href="4-sm.html#SP15" class="function-link"><span class="function-syntax">Str::clear</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">escaped</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-mpi.html#SP28_1" class="named-paragraph-link"><span class="named-paragraph">Deal with cell contents</span><span class="named-paragraph-number">28.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">cell_count</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">edge_pipes</span><span class="plain-syntax"> == </span><span class="constant-syntax">2</span><span class="plain-syntax">)) </span><span class="identifier-syntax">cell_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">table_item</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">is_delimiter_row</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">cell_number</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">col_count</span><span class="plain-syntax">; </span><span class="identifier-syntax">cell_number</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cell_item</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TABLE_COLUMN_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">cell_item</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">            </span><a href="5-mrk.html#SP20" class="function-link"><span class="function-syntax">Markdown::add_to</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell_item</span><span class="plain-syntax">, </span><span class="identifier-syntax">row_item</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">cell_count</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP28_1" class="paragraph-anchor"></a><b>&#167;28.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Deal with cell contents</span><span class="named-paragraph-number">28.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><a href="4-sm.html#SP24" class="function-link"><span class="function-syntax">Str::trim_white_space</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">to</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">) - </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="identifier-syntax">alignment</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">is_delimiter_row</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">, </span><span class="identifier-syntax">from</span><span class="plain-syntax">) == </span><span class="character-syntax">':'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">from</span><span class="plain-syntax">++; </span><span class="identifier-syntax">alignment</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">, </span><span class="identifier-syntax">to</span><span class="plain-syntax">) == </span><span class="character-syntax">':'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">to</span><span class="plain-syntax">--; </span><span class="identifier-syntax">alignment</span><span class="plain-syntax"> = </span><span class="constant-syntax">3</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">, </span><span class="identifier-syntax">to</span><span class="plain-syntax">) == </span><span class="character-syntax">':'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">to</span><span class="plain-syntax">--; </span><span class="identifier-syntax">alignment</span><span class="plain-syntax"> = </span><span class="constant-syntax">2</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">from</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;=</span><span class="identifier-syntax">to</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) != </span><span class="character-syntax">'-'</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">table_item</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tc</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TABLE_COLUMN_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><a href="5-mrk.html#SP23" class="function-link"><span class="function-syntax">Markdown::set_alignment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tc</span><span class="plain-syntax">, </span><span class="identifier-syntax">alignment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><a href="5-mrk.html#SP20" class="function-link"><span class="function-syntax">Markdown::add_to</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tc</span><span class="plain-syntax">, </span><span class="identifier-syntax">row_item</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">table_item</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">cell_number</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">col_count</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cell_item</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TABLE_COLUMN_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">cell_item</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP3" class="function-link"><span class="function-syntax">Str::duplicate</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><a href="5-mrk.html#SP20" class="function-link"><span class="function-syntax">Markdown::add_to</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">cell_item</span><span class="plain-syntax">, </span><span class="identifier-syntax">row_item</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">cell_number</span><span class="plain-syntax">++;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-mpi.html#SP28">&#167;28</a> (twice).</li></ul>
<p class="commentary firstcommentary"><a id="SP29" class="paragraph-anchor"></a><b>&#167;29. The interstage. </b>Phase I is now complete except for two tidying-up operations needed for lists.
The first is to group together consecutive list entries which look as if they
belong to the same list; they need the same flavour and the same basic type
(ordered or unordered). We insert <span class="extract"><span class="extract-syntax">ORDERED_LIST_MIT</span></span> or <span class="extract"><span class="extract-syntax">UNORDERED_LIST_MIT</span></span>
items into the tree to hold these.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::gather_lists</span><button class="popup" onclick="togglePopup('usagePopup36')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup36">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::gather_lists</span></span>:<br/>Markdown - <a href="5-mrk.html#SP5_1">&#167;5.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">at</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">at</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP29" class="function-link"><span class="function-syntax">MDBlockParser::gather_lists</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">, *</span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">; </span><span class="identifier-syntax">d</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP29" class="function-link"><span class="function-syntax">MDBlockParser::in_same_list</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">type</span><span class="plain-syntax"> = </span><span class="constant-syntax">ORDERED_LIST_MIT</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">UNORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">) </span><span class="identifier-syntax">type</span><span class="plain-syntax"> = </span><span class="constant-syntax">UNORDERED_LIST_MIT</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">list</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">type</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">d</span><span class="plain-syntax">) </span><span class="identifier-syntax">d</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax"> = </span><span class="identifier-syntax">list</span><span class="plain-syntax">; </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax"> = </span><span class="identifier-syntax">list</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">list</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><a href="5-mpi.html#SP29" class="function-link"><span class="function-syntax">MDBlockParser::in_same_list</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)) </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">list</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">list</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::in_same_list</span><span class="plain-syntax">(</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">B</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">A</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">B</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><a href="5-mrk.html#SP28" class="function-link"><span class="function-syntax">Markdown::get_item_flavour</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">        (</span><a href="5-mrk.html#SP28" class="function-link"><span class="function-syntax">Markdown::get_item_flavour</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">) == </span><a href="5-mrk.html#SP28" class="function-link"><span class="function-syntax">Markdown::get_item_flavour</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP30" class="paragraph-anchor"></a><b>&#167;30.  </b>In order to be able to detect looseness of lists, we will need to make
sure the white space flags are correct. Why would they be wrong, you ask?
Well, because the new <span class="extract"><span class="extract-syntax">ORDERED_LIST_MIT</span></span> or <span class="extract"><span class="extract-syntax">UNORDERED_LIST_MIT</span></span> items have
only just appeared, so had no opportunity to pick up these flags during Phase I.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::propagate_white_space_follows</span><button class="popup" onclick="togglePopup('usagePopup37')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup37">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::propagate_white_space_follows</span></span>:<br/>Markdown - <a href="5-mrk.html#SP5_1">&#167;5.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">at</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">at</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP30" class="function-link"><span class="function-syntax">MDBlockParser::propagate_white_space_follows</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">whitespace_follows</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><a href="5-mpi.html#SP20" class="function-link"><span class="function-syntax">MDBlockParser::mark_block_with_ws</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP31" class="paragraph-anchor"></a><b>&#167;31.  </b>This detects task list items, a GitHub extension:
</p>

<p class="commentary">"A task list item is a list item where the first block in it is a paragraph
which begins with a task list item marker and at least one whitespace character
before any other content.
</p>

<p class="commentary">A task list item marker consists of an optional number of spaces, a left square bracket,
either a whitespace character or the letter x in either lowercase or uppercase,
and then a right square bracket."
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">MDBlockParser::task_list_items</span><button class="popup" onclick="togglePopup('usagePopup38')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup38">Usage of <span class="code-font"><span class="function-syntax">MDBlockParser::task_list_items</span></span>:<br/>Markdown - <a href="5-mrk.html#SP5_1">&#167;5.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">md_doc_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">at</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">at</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">ORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">UNORDERED_LIST_ITEM_MIT</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">type</span><span class="plain-syntax"> == </span><span class="constant-syntax">PARAGRAPH_MIT</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">X</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">down</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">stashed</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'['</span><span class="plain-syntax">) &amp;&amp; (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+2) == </span><span class="character-syntax">']'</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">middle</span><span class="plain-syntax"> = </span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+1);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ticked</span><span class="plain-syntax"> = </span><span class="constant-syntax">NOT_APPLICABLE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">middle</span><span class="plain-syntax"> == </span><span class="character-syntax">'x'</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">middle</span><span class="plain-syntax"> == </span><span class="character-syntax">'X'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ticked</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">middle</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">middle</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">ticked</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ticked</span><span class="plain-syntax"> != </span><span class="constant-syntax">NOT_APPLICABLE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tickbox</span><span class="plain-syntax"> = </span><a href="5-mrk.html#SP18" class="function-link"><span class="function-syntax">Markdown::new_item</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TICKBOX_MIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><a href="5-mrk.html#SP26" class="function-link"><span class="function-syntax">Markdown::set_tick_state</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tickbox</span><span class="plain-syntax">, </span><span class="identifier-syntax">ticked</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax"> = </span><span class="identifier-syntax">tickbox</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">i</span><span class="plain-syntax">+=3;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">' '</span><span class="plain-syntax">) || (</span><a href="4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">) == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">)) </span><span class="identifier-syntax">i</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    </span><a href="4-sm.html#SP25" class="function-link"><span class="function-syntax">Str::delete_n_characters</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">X</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">at</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">down</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">c</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="5-mpi.html#SP31" class="function-link"><span class="function-syntax">MDBlockParser::task_list_items</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">state</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="5-mrk.html">&#10094;</a></li><li class="progresschapter"><a href="P-abgtf.html">P</a></li><li class="progresschapter"><a href="1-fm.html">1</a></li><li class="progresschapter"><a href="2-dl.html">2</a></li><li class="progresschapter"><a href="3-em.html">3</a></li><li class="progresschapter"><a href="4-chr.html">4</a></li><li class="progresscurrentchapter">5</li><li class="progresssection"><a href="5-htm.html">htm</a></li><li class="progresssection"><a href="5-he.html">he</a></li><li class="progresssection"><a href="5-mrk.html">mrk</a></li><li class="progresscurrent">mpi</li><li class="progresssection"><a href="5-mpi2.html">mpi2</a></li><li class="progresssection"><a href="5-mr.html">mr</a></li><li class="progresssection"><a href="5-mv.html">mv</a></li><li class="progresssection"><a href="5-ee.html">ee</a></li><li class="progresschapter"><a href="6-bf.html">6</a></li><li class="progresschapter"><a href="7-vn.html">7</a></li><li class="progresschapter"><a href="8-ws.html">8</a></li><li class="progresschapter"><a href="9-pl.html">9</a></li><li class="progressnext"><a href="5-mpi2.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

