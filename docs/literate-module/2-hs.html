<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Holon Syntax</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html"><img src="../docs-assets/Octagram.png" height=72> </a></h1>
<ul><li><a href="../inweb/index.html">inweb</a></li>
</ul><h2>Foundation Modules</h2><ul>
<li><a href="../foundation-module/index.html">foundation</a></li>
<li><a href="../foundation-test/index.html">foundation-test</a></li>
<li><a href="index.html"><span class="selectedlink">literate</span></a></li>
<li><a href="../literate-test/index.html">literate-test</a></li>
</ul><h2>Example Webs</h2><ul>
<li><a href="../goldbach/index.html">goldbach</a></li>
<li><a href="../twinprimes/twinprimes.html">twinprimes</a></li>
<li><a href="../eastertide/index.html">eastertide</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/inweb"><img src="../docs-assets/github.png" height=0> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="https://github.com/ganelson/inform"><img src="../docs-assets/github.png" height=0> inform</a></li>
<li><a href="https://github.com/ganelson/intest"><img src="../docs-assets/github.png" height=0> intest</a></li>
</ul>
		</nav>
		<main role="main">
		<!-- Weave of 'Holon Syntax' generated by inweb -->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">literate</a></li><li><a href="index.html#2">Chapter 2: Literate Code</a></li><li><b>Holon Syntax</b></li></ul></div>
<p class="purpose">Constructing a finite state machine for the parsing of code in holons.</p>

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. </b>The code in each holon has to be scanned, mainly to spot names of other holons
within it. This is not as simple as it seems because it depends both on the
syntax used to mark holons inside code, and also the syntax of the programming
language, in order that we don't get false positives of holon notation from
inside comments, string literals or character literals. For example, if our
syntax for a holon in C is <span class="extract"><span class="extract-syntax">XXname of holonYY</span></span>, then we don't want to be fooled
by <span class="extract"><span class="extract-syntax">printf("XX"); /* YYZ is my favourite Rush number */</span></span>, where the <span class="extract"><span class="extract-syntax">XX</span></span>
doesn't count because it's inside a string literal, and the <span class="extract"><span class="extract-syntax">YY</span></span> because it's
inside a multiline comment.
</p>

<p class="commentary">We therefore construct a finite state machine which does the necessary parsing
depending on these two sets of syntax. For efficiency, we don't want to construct
a new FSM every time, so we cache the results.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">DO_NOT_TRACE_HOLON_FSMS</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_holon_scanner</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_notation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">syntax</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">programming_language</span><span class="plain-syntax"> *</span><span class="identifier-syntax">pl</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">finite_state_machine</span><span class="plain-syntax"> *</span><span class="identifier-syntax">machine</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">ls_holon_scanner</span><span class="plain-syntax">;</span>

<span class="identifier-syntax">finite_state_machine</span><span class="plain-syntax"> *</span><span class="function-syntax">HolonSyntax::get</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="function-syntax">HolonSyntax::get</span></span>:<br/>Holons - <a href="2-hln.html#SP5">&#167;5</a><br/>The Tangler - <a href="4-tt2.html#SP13">&#167;13</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_notation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="reserved-syntax">programming_language</span><span class="plain-syntax"> *</span><span class="identifier-syntax">pl</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_holon_scanner</span><span class="plain-syntax"> *</span><span class="identifier-syntax">sc</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER</span><span class="plain-syntax">(</span><span class="identifier-syntax">sc</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_holon_scanner</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax"> == </span><span class="identifier-syntax">S</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">pl</span><span class="plain-syntax"> == </span><span class="identifier-syntax">pl</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">machine</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1" class="named-paragraph-link"><span class="named-paragraph">Create a new scanner</span><span class="named-paragraph-number">1.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    #</span><span class="identifier-syntax">ifdef</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRACE_HOLON_FSMS</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">STDERR</span><span class="plain-syntax">, </span><span class="string-syntax">"Created scanner for language %S with %S\n"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">pl</span><span class="plain-syntax">)?(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">language_name</span><span class="plain-syntax">):</span><span class="identifier-syntax">I</span><span class="string-syntax">"NONE"</span><span class="plain-syntax">, </span><span class="identifier-syntax">S</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">FSM::write_fsm</span><span class="plain-syntax">(</span><span class="identifier-syntax">STDERR</span><span class="plain-syntax">, </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">machine</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    #</span><span class="identifier-syntax">endif</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">machine</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure ls_holon_scanner is accessed in 2/ls, 2/hln, 4/tt2 and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1" class="paragraph-anchor"></a><b>&#167;1.1. </b>Every scanner has a state called "code" for the normal compiled matter,
that is, what isn't in some form of quotation marks or comment markers.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Create a new scanner</span><span class="named-paragraph-number">1.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">sc</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_holon_scanner</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax"> = </span><span class="identifier-syntax">S</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">pl</span><span class="plain-syntax"> = </span><span class="identifier-syntax">pl</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">code_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"code"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_1" class="named-paragraph-link"><span class="named-paragraph">Create the finite state machine</span><span class="named-paragraph-number">1.1.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">pl</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_3" class="named-paragraph-link"><span class="named-paragraph">Add line comment syntax to finite state machine</span><span class="named-paragraph-number">1.1.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_4" class="named-paragraph-link"><span class="named-paragraph">Add multiline comment syntax to finite state machine</span><span class="named-paragraph-number">1.1.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_5" class="named-paragraph-link"><span class="named-paragraph">Add whole line comment syntax to finite state machine</span><span class="named-paragraph-number">1.1.5</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_6" class="named-paragraph-link"><span class="named-paragraph">Add string literal syntax to finite state machine</span><span class="named-paragraph-number">1.1.6</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_7" class="named-paragraph-link"><span class="named-paragraph">Add character literal syntax to finite state machine</span><span class="named-paragraph-number">1.1.7</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-hs.html#SP1_1_2" class="named-paragraph-link"><span class="named-paragraph">Add literate syntax to finite state machine</span><span class="named-paragraph-number">1.1.2</span></a></span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1">&#167;1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_1" class="paragraph-anchor"></a><b>&#167;1.1.1. </b>There's an annoying dance here because some languages have a form of line
comment which can only be used where the comment character(s) is/are the first
non-white-space token on that line: we call those "whole line comments".
That means having to track the difference between general code, and whitespace
at the start of a line inside code. But most languages do not, so we only
want to add this complexity if we have to.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Create the finite state machine</span><span class="named-paragraph-number">1.1.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">pl</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">whole_line_comment</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"whitespace"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">machine</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_machine</span><span class="plain-syntax">(</span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_entry_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">, </span><span class="character-syntax">' '</span><span class="plain-syntax">, </span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\t'</span><span class="plain-syntax">, </span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_with_event</span><span class="plain-syntax">(</span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">AGAIN_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">sc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">machine</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_machine</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_2" class="paragraph-anchor"></a><b>&#167;1.1.2. </b>Note that this scanner accepts holon names and commands which are empty, or which
contain newlines. That doesn't mean those are legal: they need to be rejected by
the user of the machine.
</p>

<pre class="definitions code-font"><span class="definition-keyword">enum</span> <span class="constant-syntax">NAME_START_FSMEVENT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">NAME_END_FSMEVENT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">COMMAND_START_FSMEVENT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">COMMAND_END_FSMEVENT</span>
</pre>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add literate syntax to finite state machine</span><span class="named-paragraph-number">1.1.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="2-wn.html#SP10" class="function-link"><span class="function-syntax">WebNotation::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">NAMED_HOLONS_WSF</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">holon_name_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"holon"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out_with_events</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">NAMED_HOLONS_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">1</span><span class="plain-syntax">),</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">holon_name_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">NO_FSMEVENT</span><span class="plain-syntax">, </span><span class="constant-syntax">NAME_START_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out_with_events</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name_state</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">NAMED_HOLONS_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">2</span><span class="plain-syntax">),</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">NO_FSMEVENT</span><span class="plain-syntax">, </span><span class="constant-syntax">NAME_END_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="2-wn.html#SP10" class="function-link"><span class="function-syntax">WebNotation::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">TANGLER_COMMANDS_WSF</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">command_name_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"tangle-command"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out_with_events</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">TANGLER_COMMANDS_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">1</span><span class="plain-syntax">),</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">command_name_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">NO_FSMEVENT</span><span class="plain-syntax">, </span><span class="constant-syntax">COMMAND_START_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">command_name_state</span><span class="plain-syntax">, </span><span class="character-syntax">'"'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">command_name_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out_with_events</span><span class="plain-syntax">(</span><span class="identifier-syntax">command_name_state</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">TANGLER_COMMANDS_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">2</span><span class="plain-syntax">),</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">NO_FSMEVENT</span><span class="plain-syntax">, </span><span class="constant-syntax">COMMAND_END_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_3" class="paragraph-anchor"></a><b>&#167;1.1.3. </b>These are mostly straightforward. For example, if you're scanning code and
you see the notation to start a line comment, then transition to line-comment
state; and stay there until you see a newline, and then revert to code state.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add line comment syntax to finite state machine</span><span class="named-paragraph-number">1.1.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">line_comment</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lc_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"line-comment"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">line_comment</span><span class="plain-syntax">, </span><span class="identifier-syntax">lc_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">lc_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_4" class="paragraph-anchor"></a><b>&#167;1.1.4. </b>Almost uniquely, Inform 7 comments respect string literals, so the closing
notation must not occur inside double-quoted matter in a comment.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add multiline comment syntax to finite state machine</span><span class="named-paragraph-number">1.1.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">multiline_comment_open</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">mlc_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"multi-line-comment"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">multiline_comment_open</span><span class="plain-syntax">, </span><span class="identifier-syntax">mlc_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">language_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Inform 7"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"string-in-mlc"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">mlc_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal</span><span class="plain-syntax">, </span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal</span><span class="plain-syntax">, </span><span class="identifier-syntax">mlc_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">mlc_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">multiline_comment_close</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_5" class="paragraph-anchor"></a><b>&#167;1.1.5. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add whole line comment syntax to finite state machine</span><span class="named-paragraph-number">1.1.5</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">whole_line_comment</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">wlc_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"whole-line-comment"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">whitespace_at_line_start_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">whole_line_comment</span><span class="plain-syntax">, </span><span class="identifier-syntax">wlc_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">wlc_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_6" class="paragraph-anchor"></a><b>&#167;1.1.6. </b>Also annoyingly, Inform 6 allows tangle commands to be used inside string literals.
We forbid this for all other languages.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add string literal syntax to finite state machine</span><span class="named-paragraph-number">1.1.6</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">string_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"string"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal</span><span class="plain-syntax">, </span><span class="identifier-syntax">string_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">string_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (((</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">language_name</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Inform 6"</span><span class="plain-syntax">)) || (</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">C_like</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">            (</span><a href="2-wn.html#SP10" class="function-link"><span class="function-syntax">WebNotation::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">TANGLER_COMMANDS_WSF</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"command-in-string"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition_spelling_out_with_events</span><span class="plain-syntax">(</span><span class="identifier-syntax">string_state</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">TANGLER_COMMANDS_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">1</span><span class="plain-syntax">),</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">AGAIN_FSMEVENT</span><span class="plain-syntax">, </span><span class="constant-syntax">COMMAND_START_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax">, </span><span class="character-syntax">'"'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition_spelling_out_with_events</span><span class="plain-syntax">(</span><span class="identifier-syntax">smlc_state</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">TANGLER_COMMANDS_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">2</span><span class="plain-syntax">),</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">string_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">AGAIN_FSMEVENT</span><span class="plain-syntax">, </span><span class="constant-syntax">COMMAND_END_FSMEVENT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal_escape</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">escape_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state_from</span><span class="plain-syntax">(</span><span class="identifier-syntax">string_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">string_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">string_literal_escape</span><span class="plain-syntax">, </span><span class="identifier-syntax">escape_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">escape_state</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">string_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP1_1_7" class="paragraph-anchor"></a><b>&#167;1.1.7. </b>Note the surprising transition here which can terminate a character literal at
a newline (unless it has been backslashed). There can be few if any languages
allowing newlines in character literals, so it really does no harm to have this
rule. We do it to avoid false positives with Preform notation in InC if we don't
allow for this.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add character literal syntax to finite state machine</span><span class="named-paragraph-number">1.1.7</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">character_literal</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">char_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state</span><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"character"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">code_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">character_literal</span><span class="plain-syntax">, </span><span class="identifier-syntax">char_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">char_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">character_literal</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">char_state</span><span class="plain-syntax">, </span><span class="character-syntax">'\n'</span><span class="plain-syntax">, </span><span class="identifier-syntax">code_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">character_literal_escape</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">fsm_state</span><span class="plain-syntax"> *</span><span class="identifier-syntax">escape_state</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FSM::new_state_from</span><span class="plain-syntax">(</span><span class="identifier-syntax">char_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition_spelling_out</span><span class="plain-syntax">(</span><span class="identifier-syntax">char_state</span><span class="plain-syntax">, </span><span class="identifier-syntax">pl</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">character_literal_escape</span><span class="plain-syntax">, </span><span class="identifier-syntax">escape_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">FSM::add_transition</span><span class="plain-syntax">(</span><span class="identifier-syntax">escape_state</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">char_state</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-hs.html#SP1_1">&#167;1.1</a>.</li></ul>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="2-hln.html">&#10094;</a></li><li class="progresschapter"><a href="P-abgtl.html">P</a></li><li class="progresschapter"><a href="1-lm.html">1</a></li><li class="progresscurrentchapter">2</li><li class="progresssection"><a href="2-ls.html">ls</a></li><li class="progresssection"><a href="2-lc.html">lc</a></li><li class="progresssection"><a href="2-we.html">we</a></li><li class="progresssection"><a href="2-wn.html">wn</a></li><li class="progresssection"><a href="2-hln.html">hln</a></li><li class="progresscurrent">hs</li><li class="progresschapter"><a href="3-pl.html">3</a></li><li class="progresschapter"><a href="4-tt.html">4</a></li><li class="progresschapter"><a href="5-wd.html">5</a></li><li class="progresschapter"><a href="6-mkf.html">6</a></li><li class="progressnext"><a href="3-pl.html">&#10095;</a></li></ul></div>
</nav><!-- End of weave -->

		</main>
	</body>
</html>

