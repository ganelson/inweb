<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Literate Source</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html"><img src="../docs-assets/Octagram.png" height=72> </a></h1>
<ul><li><a href="../inweb/index.html">inweb</a></li>
</ul><h2>Foundation Modules</h2><ul>
<li><a href="../foundation-module/index.html">foundation</a></li>
<li><a href="../foundation-test/index.html">foundation-test</a></li>
<li><a href="index.html"><span class="selectedlink">literate</span></a></li>
<li><a href="../literate-test/index.html">literate-test</a></li>
</ul><h2>Example Webs</h2><ul>
<li><a href="../goldbach/index.html">goldbach</a></li>
<li><a href="../twinprimes/twinprimes.html">twinprimes</a></li>
<li><a href="../eastertide/index.html">eastertide</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/inweb"><img src="../docs-assets/github.png" height=0> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="https://github.com/ganelson/inform"><img src="../docs-assets/github.png" height=0> inform</a></li>
<li><a href="https://github.com/ganelson/intest"><img src="../docs-assets/github.png" height=0> intest</a></li>
</ul>
		</nav>
		<main role="main">
		<!-- Weave of 'Literate Source' generated by inweb -->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">literate</a></li><li><a href="index.html#2">Chapter 2: Literate Code</a></li><li><b>Literate Source</b></li></ul></div>
<p class="purpose">To parse and represent units of literate source text.</p>

<ul class="toc"><li><a href="2-ls.html#SP14">&#167;14. Fragments only</a></li><li><a href="2-ls.html#SP15">&#167;15. Functions for examining webs</a></li><li><a href="2-ls.html#SP19">&#167;19. Functions for crawling webs</a></li><li><a href="2-ls.html#SP20">&#167;20. Tagging of paragraphs</a></li><li><a href="2-ls.html#SP24">&#167;24. Footnote notation</a></li><li><a href="2-ls.html#SP26">&#167;26. Debugging</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. </b>At this point we've done all of the large-scale organisations of webs into
chapters and sections, and we get into the lower-level literate source.
By analogy with "compilation units", we use the term "unit" to mean a stretch
of self-contained literate source &mdash; self-contained in that its holons can
incorporate each other, but not holons from other sections of a web, which
are different units.
</p>

<p class="commentary">We will end up with an <span class="extract"><span class="extract-syntax">ls_unit</span></span> which is essentially a list of <span class="extract"><span class="extract-syntax">ls_paragraph</span></span>,
which is a list of <span class="extract"><span class="extract-syntax">ls_chunk</span></span>, which is a list of <span class="extract"><span class="extract-syntax">ls_line</span></span>.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_notation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">syntax</span><span class="plain-syntax">; </span><span class="comment-syntax"> what notation is this unit written with?</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">programming_language</span><span class="plain-syntax"> *</span><span class="identifier-syntax">language</span><span class="plain-syntax">; </span><span class="comment-syntax"> what language is the program in?</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_section</span><span class="plain-syntax"> *</span><span class="identifier-syntax">owning_section</span><span class="plain-syntax">; </span><span class="comment-syntax"> can be NULL if not read from a web</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">heading</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">purpose</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">first_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">last_par</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> result of parsing</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">lines_read</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">errors</span><span class="plain-syntax">; </span><span class="comment-syntax"> of </span><span class="extract"><span class="extract-syntax">ls_error</span></span>

<span class="plain-syntax">    </span><span class="comment-syntax"> temporary workspace used only in parsing</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">incomplete</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">eligible_to_have_implicit_purpose</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">window_for_implicit_purpose_open</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">pathname</span><span class="plain-syntax"> *</span><span class="identifier-syntax">extracts_path</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_web</span><span class="plain-syntax"> *</span><span class="identifier-syntax">context</span><span class="plain-syntax">; </span><span class="comment-syntax"> used only for finding language names</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">temp_first_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">temp_last_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">spool_point</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure ls_unit is accessed in 1/wcl, 1/ws, 1/wcp, 2/we, 2/wn, 2/hln, 2/hs, 3/ca, 3/lm, 4/tt, 4/tt2, 5/tc, 5/tw, 5/wt, 5/ptf, 5/tf, 5/hf, 5/df and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. </b>To parse source text into an <span class="extract"><span class="extract-syntax">ls_unit</span></span>, begin by calling this to produce
an empty one, ready for parsing. Note that <span class="extract"><span class="extract-syntax">S</span></span>, the section, can be <span class="extract"><span class="extract-syntax">NULL</span></span>,
in cases when tiny fragments of code are being parsed outside the context
of a full literate program. However, <span class="extract"><span class="extract-syntax">syntax</span></span> and <span class="extract"><span class="extract-syntax">language</span></span> must be set.
</p>

<p class="commentary">The <span class="extract"><span class="extract-syntax">extracts_path</span></span> and <span class="extract"><span class="extract-syntax">dialects_path</span></span> directories are relevant only when
parsing extracts: those drawn from files need to get the files from somewhere,
and those which name their contents as being written in a given language
need to get that from somewhere, too. Either or both can be <span class="extract"><span class="extract-syntax">NULL</span></span>, which
means the current working directory.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::begin_unit</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::begin_unit</span></span>:<br/><a href="2-ls.html#SP14">&#167;14</a><br/>Web Structure - <a href="1-ws.html#SP12_1">&#167;12.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_section</span><span class="plain-syntax"> *</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_notation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">syntax</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">programming_language</span><span class="plain-syntax"> *</span><span class="identifier-syntax">language</span><span class="plain-syntax">, </span><span class="identifier-syntax">pathname</span><span class="plain-syntax"> *</span><span class="identifier-syntax">extracts_path</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_web</span><span class="plain-syntax"> *</span><span class="identifier-syntax">context</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax"> = </span><span class="identifier-syntax">syntax</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">language</span><span class="plain-syntax"> = </span><span class="identifier-syntax">language</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_section</span><span class="plain-syntax"> = </span><span class="identifier-syntax">S</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::unclassified</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::unclassified</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">lines_read</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">errors</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEW_LINKED_LIST</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_error</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">incomplete</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">eligible_to_have_implicit_purpose</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">window_for_implicit_purpose_open</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">extracts_path</span><span class="plain-syntax"> = </span><span class="identifier-syntax">extracts_path</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">context</span><span class="plain-syntax"> = </span><span class="identifier-syntax">context</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">spool_point</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. </b>You can, optionally, then follow up by supplying a "purpose" text from outside
of the source code.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::add_purpose</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::add_purpose</span></span>:<br/>Web Structure - <a href="1-ws.html#SP12_1_1">&#167;12.1.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">PURPOSE_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">text</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. </b>Once the unit has been begun, call <span class="extract"><span class="extract-syntax">LiterateSource::feed_line</span></span> on each line
of source text to feed into it; then call <span class="extract"><span class="extract-syntax">LiterateSource::complete_unit</span></span> to
indicate that you're done.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::feed_line</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::feed_line</span></span>:<br/>Web Structure - <a href="1-ws.html#SP13">&#167;13</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">lines_read</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. </b>That function wasn't recursive: this one is. We need to remember here that a
literal line of source text can, in some notations for LS, produce multiple
<span class="extract"><span class="extract-syntax">ls_line</span></span> objects &mdash; if a single line combines a title for a paragraph with
some commentary beginning that paragraph, for example.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::feed_line_segment</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::feed_line_segment</span></span>:<br/><a href="2-ls.html#SP3">&#167;3</a>, <a href="2-ls.html#SP4">&#167;4</a>, <a href="2-ls.html#SP5_2">&#167;5.2</a>, <a href="2-ls.html#SP5_4">&#167;5.4</a>, <a href="2-ls.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">major</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"no unit to feed lines to"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">incomplete</span><span class="plain-syntax"> == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"too late to for lines: unit already completed"</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">ls_class_parsing</span><span class="plain-syntax"> </span><span class="identifier-syntax">res</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP5_1" class="named-paragraph-link"><span class="named-paragraph">Classify this line segment</span><span class="named-paragraph-number">5.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP5_2" class="named-paragraph-link"><span class="named-paragraph">Insert any implied lines first</span><span class="named-paragraph-number">5.2</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP7" class="function-link"><span class="function-syntax">LiterateSource::new_line</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">cf</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">error</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_in_unit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">error</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP5_3" class="named-paragraph-link"><span class="named-paragraph">Then insert the explicit line</span><span class="named-paragraph-number">5.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP5_4" class="named-paragraph-link"><span class="named-paragraph">And finally insert any residue left over</span><span class="named-paragraph-number">5.4</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5_1" class="paragraph-anchor"></a><b>&#167;5.1. </b>If we were called with <span class="extract"><span class="extract-syntax">major</span></span> and <span class="extract"><span class="extract-syntax">minor</span></span> already set to a given classification,
then that's how the line segment is classified. If not, then we don't know the
answer in advance, and will have to work it out. This depends on context, as
provided by the previous line segment's classification.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Classify this line segment</span><span class="named-paragraph-number">5.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">major</span><span class="plain-syntax"> != </span><span class="constant-syntax">UNCLASSIFIED_MAJLC</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">res</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP14" class="function-link"><span class="function-syntax">LineClassification::new_results</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">major</span><span class="plain-syntax">, </span><span class="identifier-syntax">minor</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">last_cf</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">last_cf</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::unclassified</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">last_cf</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">res</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP14" class="function-link"><span class="function-syntax">LineClassification::classify</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax">, </span><span class="identifier-syntax">text</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">last_cf</span><span class="plain-syntax">);</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">cf</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">window_for_implicit_purpose_open</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">text</span><span class="plain-syntax">) == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">eligible_to_have_implicit_purpose</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">cf</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> != </span><span class="constant-syntax">PARAGRAPH_START_MAJLC</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">cf</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">HEADING_COMMAND_MINLC</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">window_for_implicit_purpose_open</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP5">&#167;5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP5_2" class="paragraph-anchor"></a><b>&#167;5.2. </b>In some syntaxes for literate programming, paragraph breaks (for example) are
explicitly marked: in others they are implied, and we need to insert them.
</p>

<p class="commentary">Note that it is possible for more than one of these occur at at single position.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Insert any implied lines first</span><span class="named-paragraph-number">5.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">implies_extract_end</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"(implied extract end line)"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="constant-syntax">EXTRACT_END_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">implies_paragraph</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"(implied paragraph start line)"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="constant-syntax">PARAGRAPH_START_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">implies_extract</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"(implied extract start line)"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="constant-syntax">EXTRACT_START_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">CODE_MINLC</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP5">&#167;5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP5_3" class="paragraph-anchor"></a><b>&#167;5.3. </b>For now, we're storing the lines as a doubly-linked list:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Then insert the explicit line</span><span class="named-paragraph-number">5.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP5">&#167;5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP5_4" class="paragraph-anchor"></a><b>&#167;5.4. </b>Sometimes the classifier has decided that only the first few characters
of the line were significant, and wants to give us a "residue" of material
left over. We recurse in order to insert line(s) arising from that, too.
</p>

<p class="commentary">Usually the classifier has left that residue unclassified for now &mdash; so that
it will be classified when we recurse &mdash; but sometimes the classifier already
knows and wants to tell us:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">And finally insert any residue left over</span><span class="named-paragraph-number">5.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">residue</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">residue</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">residue_cf</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax">, </span><span class="identifier-syntax">res</span><span class="plain-syntax">.</span><span class="element-syntax">residue_cf</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP5">&#167;5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. </b>If for some reason you don't want to use any external classification, because
you already know how all your lines are to be classified, you can use these
convenience functions rather than calling <span class="extract"><span class="extract-syntax">LiterateSource::feed_line</span></span>.
Note that these all increment the line count, just as that does:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::feed_paragraph_start</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::feed_paragraph_start</span></span>:<br/><a href="2-ls.html#SP14">&#167;14</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">lines_read</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">""</span><span class="plain-syntax">, </span><span class="constant-syntax">PARAGRAPH_START_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::feed_code_start</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::feed_code_start</span></span>:<br/><a href="2-ls.html#SP14">&#167;14</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">lines_read</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">""</span><span class="plain-syntax">, </span><span class="constant-syntax">EXTRACT_START_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">CODE_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::feed_code_line</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::feed_code_line</span></span>:<br/><a href="2-ls.html#SP14">&#167;14</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">lines_read</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="constant-syntax">EXTRACT_MATTER_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">text</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::feed_code_end</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::feed_code_end</span></span>:<br/><a href="2-ls.html#SP14">&#167;14</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">lines_read</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP5" class="function-link"><span class="function-syntax">LiterateSource::feed_line_segment</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">""</span><span class="plain-syntax">, </span><span class="constant-syntax">EXTRACT_END_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. </b>The above created <span class="extract"><span class="extract-syntax">ls_line</span></span> objects, so we should take a look at those:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="comment-syntax"> where this came from, and its original text</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">origin</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> what the line means to us</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">void</span><span class="plain-syntax"> *</span><span class="identifier-syntax">analysis_ref</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax"> *</span><span class="identifier-syntax">footnote_text</span><span class="plain-syntax">; </span><span class="comment-syntax"> which fn this is the text of, if it is at all</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">suppress_tangling</span><span class="plain-syntax">; </span><span class="comment-syntax"> if e.g., lines are tangled out of order</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> how the line sits inside the wider source</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">owning_chunk</span><span class="plain-syntax">; </span><span class="comment-syntax"> </span><span class="extract"><span class="extract-syntax">NULL</span></span><span class="comment-syntax"> until the unit has been divided up into chunks</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">prev_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::new_line</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::new_line</span></span>:<br/><a href="2-ls.html#SP5">&#167;5</a>, <a href="2-ls.html#SP9">&#167;9</a></span></button><span class="plain-syntax">(</span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">cf</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">) </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">origin</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">; </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">origin</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TextFiles::nowhere</span><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">text</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">analysis_ref</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax"> = </span><span class="identifier-syntax">cf</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">suppress_tangling</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure ls_line is accessed in 1/ws, 2/we, 2/hln, 3/ca, 3/taf, 3/lm, 3/as, 3/cl, 3/is, 4/tt, 4/tt2, 4/cs, 5/tw, 5/twot, 5/wt, 5/ptf, 5/tf, 5/hf, 5/df and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. </b>With the raw parsing done, the fun can really begin. At this point all the lines
have been read in, but they sit inside the unit only as a doubly-linked list.
We need to reassemble that into a hierarchy of paragraphs and chunks, and
generally to tidy up so that the unit is ready for use. All of that happens
when the following is called:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::complete_unit</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::complete_unit</span></span>:<br/><a href="2-ls.html#SP14">&#167;14</a><br/>Web Structure - <a href="1-ws.html#SP12_1">&#167;12.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_1" class="named-paragraph-link"><span class="named-paragraph">Perform a sanity check before doing anything</span><span class="named-paragraph-number">8.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_2" class="named-paragraph-link"><span class="named-paragraph">Trim off header lines at the top</span><span class="named-paragraph-number">8.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_3" class="named-paragraph-link"><span class="named-paragraph">Spool in extracts from external files</span><span class="named-paragraph-number">8.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_4" class="named-paragraph-link"><span class="named-paragraph">Convert the line list to a paragraph and chunk tree</span><span class="named-paragraph-number">8.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_5" class="named-paragraph-link"><span class="named-paragraph">Trim redundant lines away from the chunks</span><span class="named-paragraph-number">8.5</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="2-ls.html#SP15" class="function-link"><span class="function-syntax">LiterateSource::unit_has_purpose</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><a href="2-wn.html#SP10" class="function-link"><span class="function-syntax">WebNotation::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax">, </span><span class="constant-syntax">PURPOSE_UNDER_HEADING_WSF</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_6" class="named-paragraph-link"><span class="named-paragraph">Construe an opening paragraph consisting only of commentary as a purpose text</span><span class="named-paragraph-number">8.6</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_7" class="named-paragraph-link"><span class="named-paragraph">Parse some last nuances for text extracts</span><span class="named-paragraph-number">8.7</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_8" class="named-paragraph-link"><span class="named-paragraph">Assign holons to chunks containing fragments of the target code</span><span class="named-paragraph-number">8.8</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_9" class="named-paragraph-link"><span class="named-paragraph">Police carousel structure</span><span class="named-paragraph-number">8.9</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">next_footnote</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_10" class="named-paragraph-link"><span class="named-paragraph">Work out footnote numbering for this paragraph</span><span class="named-paragraph-number">8.10</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8_1" class="paragraph-anchor"></a><b>&#167;8.1. </b>To see the first (up to) N lines of the raw linked list of lines, before
completion begins, set the following constant to N.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">TRACE_RAW_LS_LINE_LIST</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span>
</pre>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Perform a sanity check before doing anything</span><span class="named-paragraph-number">8.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"no unit to complete"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">incomplete</span><span class="plain-syntax"> == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"too late: unit already completed"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">incomplete</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRACE_RAW_LS_LINE_LIST</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">lc</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">lc</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">TRACE_RAW_LS_LINE_LIST</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">line</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">lc</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">STDERR</span><span class="plain-syntax">, </span><span class="string-syntax">"%d: %d/%d &lt;%S&gt; &lt;%S&gt; &lt;%S&gt;\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">lc</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_2" class="paragraph-anchor"></a><b>&#167;8.2. </b>If the first line of substance is a section heading then we take that out of
the list; if the first remaining is a purpose line, we do likewise. Those should
be the only <span class="extract"><span class="extract-syntax">SECTION_HEADING_MINLC</span></span> or <span class="extract"><span class="extract-syntax">PURPOSE_MINLC</span></span> lines in the list,
leaving us with standard material only.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Trim off header lines at the top</span><span class="named-paragraph-number">8.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">top</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_2_1" class="named-paragraph-link"><span class="named-paragraph">Skip past insubstantial lines</span><span class="named-paragraph-number">8.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">top</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">SECTION_HEADING_MINLC</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax"> = </span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">top</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_2_1" class="named-paragraph-link"><span class="named-paragraph">Skip past insubstantial lines</span><span class="named-paragraph-number">8.2.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">top</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">PURPOSE_MINLC</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax"> = </span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_2_1" class="paragraph-anchor"></a><b>&#167;8.2.1. </b>Because of implicit paragraphing in some syntaxes, the line list may open
with some blank commentary lines or paragraph-start markers, so:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Skip past insubstantial lines</span><span class="named-paragraph-number">8.2.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">top</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (((</span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">Str::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">))) ||</span>
<span class="plain-syntax">        ((</span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">PARAGRAPH_START_MAJLC</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> != </span><span class="constant-syntax">SECTION_HEADING_MINLC</span><span class="plain-syntax">))))</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">top</span><span class="plain-syntax"> = </span><span class="identifier-syntax">top</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_2">&#167;8.2</a> (twice).</li></ul>
<p class="commentary firstcommentary"><a id="SP8_3" class="paragraph-anchor"></a><b>&#167;8.3. </b>We allow two forms of extract to display text drawn from an external file.
This is handled by loading it in, and inserting it as extract lines into the
list, with each new line being added after the "spool point".
</p>

<p class="commentary">After this point, all <span class="extract"><span class="extract-syntax">TEXT_FROM_MINLC</span></span> extracts have been converted to
<span class="extract"><span class="extract-syntax">TEXT_MINLC</span></span>, and all <span class="extract"><span class="extract-syntax">TEXT_FROM_AS_MINLC</span></span> to <span class="extract"><span class="extract-syntax">TEXT_AS_MINLC</span></span>.
</p>

<p class="commentary">We're forgiving if the file doesn't exist, but not if it does exist but
can't be read for some permissions reason, which is more serious.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Spool in extracts from external files</span><span class="named-paragraph-number">8.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_START_MAJLC</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">            ((</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">TEXT_FROM_MINLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">                (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">TEXT_FROM_AS_MINLC</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">filename</span><span class="plain-syntax"> *</span><span class="identifier-syntax">F</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Filenames::from_text_relative</span><span class="plain-syntax">(</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">extracts_path</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">TextFiles::exists</span><span class="plain-syntax">(</span><span class="identifier-syntax">F</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">spool_point</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">TextFiles::read</span><span class="plain-syntax">(</span><span class="identifier-syntax">F</span><span class="plain-syntax">, </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">, </span><span class="string-syntax">"can't open extract file"</span><span class="plain-syntax">, </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><a href="2-ls.html#SP9" class="function-link"><span class="function-syntax">LiterateSource::spool_line</span></a><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">, (</span><span class="reserved-syntax">void</span><span class="plain-syntax"> *) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">TEXT_FROM_MINLC</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">TEXT_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">TEXT_AS_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> = </span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::new</span><span class="plain-syntax">();</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">, </span><span class="string-syntax">"(No such file as %f)"</span><span class="plain-syntax">, </span><span class="identifier-syntax">F</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. </b>And this is the service function called on every line of the extract file:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::spool_line</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::spool_line</span></span>:<br/><a href="2-ls.html#SP8_3">&#167;8.3</a></span></button><span class="plain-syntax">(</span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="reserved-syntax">void</span><span class="plain-syntax"> *</span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax"> = (</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *) </span><span class="identifier-syntax">state</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">cf</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::new</span></a><span class="plain-syntax">(</span><span class="constant-syntax">EXTRACT_MATTER_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">NO_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">cf</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">new_lst</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP7" class="function-link"><span class="function-syntax">LiterateSource::new_line</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">cf</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">old_lst</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">spool_point</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">old_lst</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">old_lst</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">old_lst</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">spool_point</span><span class="plain-syntax"> = </span><span class="identifier-syntax">new_lst</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8_4" class="paragraph-anchor"></a><b>&#167;8.4. </b>Okay, so within the line list, paragraph divisions occur at <span class="extract"><span class="extract-syntax">PARAGRAPH_START_MAJLC</span></span>
lines. We assign an <span class="extract"><span class="extract-syntax">ls_paragraph</span></span> to each gap between those divisions, including
before the first and after the last. Note that the <span class="extract"><span class="extract-syntax">PARAGRAPH_START_MAJLC</span></span> lines
are then not included in any of the chunks.
</p>

<p class="commentary">Within each paragraph, chunk divisions occur when a line belonging to a different
"chunk type" is found, or when the start of a definition is found. Thus, for example,
these nine lines would be formed into three chunks, each getting an <span class="extract"><span class="extract-syntax">ls_chunk</span></span>:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">                </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax"> (2 </span><span class="identifier-syntax">lines</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="constant-syntax">COMMENTARY_MAJLC</span>
<span class="plain-syntax">    </span><span class="constant-syntax">EXTRACT_START_MAJLC</span><span class="plain-syntax">             </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> </span><span class="constant-syntax">2</span><span class="plain-syntax"> (4 </span><span class="identifier-syntax">lines</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="constant-syntax">EXTRACT_MATTER_MAJLC</span>
<span class="plain-syntax">    </span><span class="constant-syntax">EXTRACT_MATTER_MAJLC</span>
<span class="plain-syntax">    </span><span class="constant-syntax">EXTRACT_END_MAJLC</span>
<span class="plain-syntax">    </span><span class="constant-syntax">DEFINITION_MAJLC</span><span class="plain-syntax">                </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> </span><span class="constant-syntax">3</span><span class="plain-syntax"> (1 </span><span class="identifier-syntax">line</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="constant-syntax">DEFINITION_MAJLC</span><span class="plain-syntax">                </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> </span><span class="constant-syntax">4</span><span class="plain-syntax"> (2 </span><span class="identifier-syntax">lines</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="constant-syntax">DEFINITION_CONTINUED_MAJLC</span>
</pre>
<p class="commentary">The original doubly-linked line list is broken into smaller lists, one for each
chunk, and we conclude by removing the unit's pointers to its temporary list
altogether, so that nobody uses it by mistake.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Convert the line list to a paragraph and chunk tree</span><span class="named-paragraph-number">8.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">next_par_number</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">PARAGRAPH_START_MAJLC</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_4_1" class="named-paragraph-link"><span class="named-paragraph">Begin a new paragraph</span><span class="named-paragraph-number">8.4.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">PARAGRAPH_START_MAJLC</span><span class="plain-syntax">) </span><span class="reserved-syntax">continue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ct</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EXTRACT_START_MAJLC:</span><span class="plain-syntax">        </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EXTRACT_MATTER_MAJLC:</span><span class="plain-syntax">       </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EXTRACT_END_MAJLC:</span><span class="plain-syntax">          </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">COMMENTARY_MAJLC:</span><span class="plain-syntax">           </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFINITION_MAJLC:</span><span class="plain-syntax">           </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">DEFINITION_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFINITION_CONTINUED_MAJLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">DEFINITION_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">QUOTATION_MAJLC:</span><span class="plain-syntax">            </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">QUOTATION_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HOLON_DECLARATION_MAJLC:</span><span class="plain-syntax">    </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">HOLON_DECLARATION_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">INSERTION_MAJLC:</span><span class="plain-syntax">            </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">INSERTION_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">default:</span><span class="plain-syntax">                         </span><span class="identifier-syntax">ct</span><span class="plain-syntax"> = </span><span class="constant-syntax">OTHER_LSCT</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">ct</span><span class="plain-syntax"> != </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">DEFINITION_MAJLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">INSERTION_MAJLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">HOLON_DECLARATION_MAJLC</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_4_2" class="named-paragraph-link"><span class="named-paragraph">Begin a new chunk with this line</span><span class="named-paragraph-number">8.4.2</span></a></span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_4_3" class="named-paragraph-link"><span class="named-paragraph">Add this line to the current chunk</span><span class="named-paragraph-number">8.4.3</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">INSERTION_MAJLC</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_4_4" class="named-paragraph-link"><span class="named-paragraph">Tag the paragraph as containing a particular sort of insertion</span><span class="named-paragraph-number">8.4.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">; </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">temp_last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. </b>So this is the <span class="extract"><span class="extract-syntax">ls_paragraph</span></span> object:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="comment-syntax"> how the paragraph sits inside the wider source</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">owning_unit</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">prev_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_par</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> about the paragraph</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">paragraph_number</span><span class="plain-syntax">; </span><span class="comment-syntax"> note: a text, not an int</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">void</span><span class="plain-syntax"> *</span><span class="identifier-syntax">analysis_ref</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_holon</span><span class="plain-syntax"> *</span><span class="identifier-syntax">holon</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">titling</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">taggings</span><span class="plain-syntax">; </span><span class="comment-syntax"> of </span><span class="extract"><span class="extract-syntax">literate_source_tagging</span></span>

<span class="plain-syntax">    </span><span class="comment-syntax"> contents of the paragraph</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">first_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">last_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">footnote_count</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">footnotes</span><span class="plain-syntax">; </span><span class="comment-syntax"> of </span><span class="extract"><span class="extract-syntax">ls_footnote</span></span>

<span class="plain-syntax">    </span><span class="comment-syntax"> used only when computing the paragraph numbers</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">parent_paragraph</span><span class="plain-syntax">; </span><span class="comment-syntax"> the super-para of this, if any</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">next_child_number</span><span class="plain-syntax">; </span><span class="comment-syntax"> how many sub-paras we've had so far</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure ls_paragraph is accessed in 1/cln, 1/ws, 2/we, 2/hln, 3/ca, 3/cc, 3/taf, 3/lm, 3/cl, 3/is, 4/tt, 4/tt2, 5/tw, 5/ptf, 5/tf, 5/hf, 5/df and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_4_1" class="paragraph-anchor"></a><b>&#167;8.4.1. </b>The new paragraph is appended to the list of paras in the unit, and assigned
a temporary paragraph number. (This may be replaced later by better numbers,
but only after holons have been looked at to work out which paras are
subordinate to which others.)
</p>

<p class="commentary">When created, a paragraph is empty of chunks, but this is put right almost
immediately afterwards:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Begin a new paragraph</span><span class="named-paragraph-number">8.4.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_unit</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">paragraph_number</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::new</span><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">paragraph_number</span><span class="plain-syntax">, </span><span class="string-syntax">"%d"</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_par_number</span><span class="plain-syntax">++);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">titling</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_count</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnotes</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">parent_paragraph</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_child_number</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_4">&#167;8.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. </b>And now for chunks. Each chunk has a "chunk type", which is one of the
following:
</p>

<pre class="definitions code-font"><span class="definition-keyword">enum</span> <span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">EXTRACT_LSCT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">QUOTATION_LSCT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">DEFINITION_LSCT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">HOLON_DECLARATION_LSCT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">INSERTION_LSCT</span>
<span class="definition-keyword">enum</span> <span class="constant-syntax">OTHER_LSCT</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="comment-syntax"> how the chunk sits inside the wider source</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">owner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">prev_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_chunk</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> about the chunk</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">chunk_type</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_class</span><span class="plain-syntax"> </span><span class="identifier-syntax">metadata</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">onset_line</span><span class="plain-syntax">; </span><span class="comment-syntax"> where to report errors about the chunk</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> meaningful for EXTRACT_LSCT chunks only</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_holon</span><span class="plain-syntax"> *</span><span class="identifier-syntax">holon</span><span class="plain-syntax">; </span><span class="comment-syntax"> or </span><span class="extract"><span class="extract-syntax">NULL</span></span><span class="comment-syntax">, if this doesn't contain a program fragment</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">plainer</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">hyperlinked</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">extract_to</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">programming_language</span><span class="plain-syntax"> *</span><span class="identifier-syntax">extract_language</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> meaningful for DEFINITION_LSCT chunks only</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">symbol_defined</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">symbol_value</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> meaningful for COMMENTARY_LSCT chunks only</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">as_markdown</span><span class="plain-syntax">; </span><span class="comment-syntax"> for commentary only</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> meaningful for INSERTION_LSCT chunks only</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">carousel_caption_position</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> contents of the chunk</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">first_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">last_line</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure ls_chunk is accessed in 1/wcl, 1/cln, 2/we, 2/hln, 3/ca, 3/lm, 3/cl, 3/is, 4/tt, 4/tt2, 5/tw, 5/ptf, 5/tf, 5/hf, 5/df and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_4_2" class="paragraph-anchor"></a><b>&#167;8.4.2. </b>When created, a chunk contains a single line:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Begin a new chunk with this line</span><span class="named-paragraph-number">8.4.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owner</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> = </span><span class="identifier-syntax">ct</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::unclassified</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">plainer</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">hyperlinked</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">extract_to</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">extract_language</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_defined</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_value</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">as_markdown</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">carousel_caption_position</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_4">&#167;8.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_4_3" class="paragraph-anchor"></a><b>&#167;8.4.3. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add this line to the current chunk</span><span class="named-paragraph-number">8.4.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_4">&#167;8.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_4_4" class="paragraph-anchor"></a><b>&#167;8.4.4. </b>This automatic tagging is a convenience for extracting, say, a weave of
just those paragraphs containing figures.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Tag the paragraph as containing a particular sort of insertion</span><span class="named-paragraph-number">8.4.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">AUDIO_MINLC:</span><span class="plain-syntax">          </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Audio"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EMBEDDED_AV_MINLC:</span><span class="plain-syntax">    </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Video"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">FIGURE_MINLC:</span><span class="plain-syntax">         </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Figures"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DOWNLOAD_MINLC:</span><span class="plain-syntax">       </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Downloads"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">VIDEO_MINLC:</span><span class="plain-syntax">          </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Video"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MINLC:</span><span class="plain-syntax">           </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"HTML"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CAROUSEL_ABOVE_MINLC:</span><span class="plain-syntax"> </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Carousels"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CAROUSEL_BELOW_MINLC:</span><span class="plain-syntax"> </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Carousels"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CAROUSEL_SLIDE_MINLC:</span><span class="plain-syntax"> </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Carousels"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CAROUSEL_END_MINLC:</span><span class="plain-syntax">   </span><a href="2-ls.html#SP21" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"Carousels"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_4">&#167;8.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_5" class="paragraph-anchor"></a><b>&#167;8.5. </b>In some syntaxes, blank lines are used to indicate extract or commentary
ends, but then leak through as unnecessary bits of extract or commentary, etc.
The following trims such blanks away.
</p>

<p class="commentary">Note that whole chunks can be removed as a result, and even whole paragraphs,
if they then turn out to contain no chunks (unless they hold important heading
material).
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Trim redundant lines away from the chunks</span><span class="named-paragraph-number">8.5</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_5_1" class="named-paragraph-link"><span class="named-paragraph">Trim whitespace lines from start or end of this chunk</span><span class="named-paragraph-number">8.5.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_5_2" class="named-paragraph-link"><span class="named-paragraph">Trim extract end markers from an extract chunk</span><span class="named-paragraph-number">8.5.2</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">DEFINITION_LSCT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_5_3" class="named-paragraph-link"><span class="named-paragraph">Tidy up definition chunks</span><span class="named-paragraph-number">8.5.3</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">INSERTION_LSCT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_5_4" class="named-paragraph-link"><span class="named-paragraph">Tidy up insertion chunks</span><span class="named-paragraph-number">8.5.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">Str::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">titling</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">Str::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">titling</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><a href="2-ls.html#SP13" class="function-link"><span class="function-syntax">LiterateSource::remove_par_from_unit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_5_1" class="paragraph-anchor"></a><b>&#167;8.5.1. </b>This does just what it says. Note that if it ends up removing every line of
the chunk, then we remove the chunk entirely, because we do not allow empty chunks.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Trim whitespace lines from start or end of this chunk</span><span class="named-paragraph-number">8.5.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">first_dark</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">last_dark</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">) == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">first_dark</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">first_dark</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">last_dark</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">first_dark</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP13" class="function-link"><span class="function-syntax">LiterateSource::remove_chunk_from_par</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">first_dark</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">last_dark</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_5">&#167;8.5</a> and <a href="2-ls.html#SP8_5_2">&#167;8.5.2</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_5_2" class="paragraph-anchor"></a><b>&#167;8.5.2. </b>At this point an extract chunk can begin with one optional <span class="extract"><span class="extract-syntax">EXTRACT_START_MAJLC</span></span>
line, giving details of what sort of extract it is: if this isn't present, the
extract will be standard code. It then consists only of <span class="extract"><span class="extract-syntax">EXTRACT_MATTER_MAJLC</span></span>
lines, running up to an optional <span class="extract"><span class="extract-syntax">EXTRACT_END_MAJLC</span></span> line which, if present,
must be the last in the chunk.
</p>

<p class="commentary">Here we strip out the start and end markers, if they are present, extracting
any metadata from the start marker as we do. That leaves a chunk with a list
of 0 or more <span class="extract"><span class="extract-syntax">EXTRACT_MATTER_MAJLC</span></span> lines: if there are none, we remove the
chunk.
</p>

<p class="commentary">If the syntax calls for extracts to have opening and closing blank lines
removed, then we do that, and once again delete the chunk if it becomes
empty as a result.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Trim extract end markers from an extract chunk</span><span class="named-paragraph-number">8.5.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::new</span></a><span class="plain-syntax">(</span><span class="constant-syntax">EXTRACT_START_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">CODE_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax">) </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_START_MAJLC</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_END_MAJLC</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><a href="2-ls.html#SP13" class="function-link"><span class="function-syntax">LiterateSource::remove_chunk_from_par</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="2-wn.html#SP10" class="function-link"><span class="function-syntax">WebNotation::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax">, </span><span class="constant-syntax">TRIMMED_EXTRACTS_WSF</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_5_1" class="named-paragraph-link"><span class="named-paragraph">Trim whitespace lines from start or end of this chunk</span><span class="named-paragraph-number">8.5.1</span></a></span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_5">&#167;8.5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_5_3" class="paragraph-anchor"></a><b>&#167;8.5.3. </b>A definition chunk begins with a <span class="extract"><span class="extract-syntax">DEFINITION_MAJLC</span></span> line, followed by 0
or more <span class="extract"><span class="extract-syntax">DEFINITION_CONTINUED_MAJLC</span></span> lines. We trim away any blank continuation
lines from the bottom end, but don't touch the top. Note that the chunk cannot
thus become empty, because it always has its header line.
</p>

<p class="commentary">We take this opportunity to parse out the symbol defined, and the value given
for it.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Tidy up definition chunks</span><span class="named-paragraph-number">8.5.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">last_dark</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> != </span><span class="constant-syntax">DEFINITION_CONTINUED_MAJLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">Str::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">) == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">last_dark</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">last_dark</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"definition without header"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">last_dark</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">match_results</span><span class="plain-syntax"> </span><span class="identifier-syntax">mr</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Regexp::create_mr</span><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_defined</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">ENUMERATE_COMMAND_MINLC</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">Regexp::match</span><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">, </span><span class="identifier-syntax">U</span><span class="string-syntax">"from (%c+)"</span><span class="plain-syntax">))) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_value</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="identifier-syntax">exp</span><span class="plain-syntax">[0]);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_value</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">Regexp::dispose_of</span><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_5">&#167;8.5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_5_4" class="paragraph-anchor"></a><b>&#167;8.5.4. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Tidy up insertion chunks</span><span class="named-paragraph-number">8.5.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">CAROUSEL_BELOW_MINLC</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">carousel_caption_position</span><span class="plain-syntax"> = -1;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">CAROUSEL_SLIDE_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">CAROUSEL_SLIDE_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">CAROUSEL_ABOVE_MINLC</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">carousel_caption_position</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">CAROUSEL_SLIDE_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">CAROUSEL_SLIDE_MINLC</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_5">&#167;8.5</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_6" class="paragraph-anchor"></a><b>&#167;8.6. </b>If there's just one chunk in the opening para, and it contains commentary,
read this as a purpose written in plain text, and remove the para.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Construe an opening paragraph consisting only of commentary as a purpose text</span><span class="named-paragraph-number">8.6</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">eligible_to_have_implicit_purpose</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax"> = </span><a href="2-lc.html#SP13" class="function-link"><span class="function-syntax">LineClassification::new</span></a><span class="plain-syntax">(</span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">, </span><span class="constant-syntax">PURPOSE_MINLC</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::new</span><span class="plain-syntax">();</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">, </span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">, </span><span class="string-syntax">" "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP13" class="function-link"><span class="function-syntax">LiterateSource::remove_par_from_unit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_7" class="paragraph-anchor"></a><b>&#167;8.7. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Parse some last nuances for text extracts</span><span class="named-paragraph-number">8.7</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">language_name</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">TEXT_AS_MINLC:</span>
<span class="plain-syntax">                    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_7_1" class="named-paragraph-link"><span class="named-paragraph">Parse out the optional undisplayed and hyperlinked keywords</span><span class="named-paragraph-number">8.7.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">language_name</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">TEXT_TO_MINLC:</span>
<span class="plain-syntax">                    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_7_1" class="named-paragraph-link"><span class="named-paragraph">Parse out the optional undisplayed and hyperlinked keywords</span><span class="named-paragraph-number">8.7.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">language_name</span><span class="plain-syntax"> = </span><span class="identifier-syntax">I</span><span class="string-syntax">"Extracts"</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">extract_to</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">TEXT_MINLC:</span>
<span class="plain-syntax">                    </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_7_1" class="named-paragraph-link"><span class="named-paragraph">Parse out the optional undisplayed and hyperlinked keywords</span><span class="named-paragraph-number">8.7.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">language_name</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">extract_language</span><span class="plain-syntax"> =</span>
<span class="plain-syntax">                    </span><a href="3-pl.html#SP4" class="function-link"><span class="function-syntax">Languages::find_or_fail</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">context</span><span class="plain-syntax">, </span><span class="identifier-syntax">language_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_7_1" class="paragraph-anchor"></a><b>&#167;8.7.1. </b>This is all a little clumsy, but it'll do:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Parse out the optional undisplayed and hyperlinked keywords</span><span class="named-paragraph-number">8.7.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">options_bitmap</span><span class="plain-syntax"> &amp; </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">hyperlinked</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">options_bitmap</span><span class="plain-syntax"> &amp; </span><span class="constant-syntax">2</span><span class="plain-syntax">) </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">plainer</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_7">&#167;8.7</a> (three times).</li></ul>
<p class="commentary firstcommentary"><a id="SP8_8" class="paragraph-anchor"></a><b>&#167;8.8. </b>So, each chunk which contains a fragment of the actual program code (rather
than, say, a definition, or commentary, or an extract of other code not to be
compiled) must be paired to an <span class="extract"><span class="extract-syntax">ls_holon</span></span> structure. If there's a holon
declaration line (i.e., a name for it) anywhere in the paragraph prior to
this chunk, we'll use that as the name; otherwise it will go nameless.
</p>

<p class="commentary">This process removes all <span class="extract"><span class="extract-syntax">EARLY_MINLC</span></span> or <span class="extract"><span class="extract-syntax">VERY_EARLY_MINLC</span></span> lines.
</p>

<p class="commentary">We finish up by scanning the holons in detail, and resolving cross-references
between them, but that's another story: see <a href="2-hln.html#SP5" class="internal">Holons::scan</a>.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Assign holons to chunks containing fragments of the target code</span><span class="named-paragraph-number">8.8</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">HOLON_DECLARATION_LSCT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                    </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"second fragment name declaration in one paragraph"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">, </span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_MINLC:</span>
<span class="plain-syntax">                        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_8_1" class="named-paragraph-link"><span class="named-paragraph">Assign a holon to this chunk</span><span class="named-paragraph-number">8.8.1</span></a></span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EARLY_MINLC:</span>
<span class="plain-syntax">                        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_8_1" class="named-paragraph-link"><span class="named-paragraph">Assign a holon to this chunk</span><span class="named-paragraph-number">8.8.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">placed_early</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">CODE_MINLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">VERY_EARLY_MINLC:</span>
<span class="plain-syntax">                        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_8_1" class="named-paragraph-link"><span class="named-paragraph">Assign a holon to this chunk</span><span class="named-paragraph-number">8.8.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">placed_very_early</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> = </span><span class="constant-syntax">CODE_MINLC</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"no code fragment follows name declaration"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">HOLON_DECLARATION_LSCT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><a href="2-ls.html#SP13" class="function-link"><span class="function-syntax">LiterateSource::remove_chunk_from_par</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><a href="2-hln.html#SP5" class="function-link"><span class="function-syntax">Holons::scan</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_8_1" class="paragraph-anchor"></a><b>&#167;8.8.1. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Assign a holon to this chunk</span><span class="named-paragraph-number">8.8.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> = </span><a href="2-hln.html#SP1" class="function-link"><span class="function-syntax">Holons::new</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">, </span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owner</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"two code fragments in the same paragraph"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owner</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon_name</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_8">&#167;8.8</a> (three times).</li></ul>
<p class="commentary firstcommentary"><a id="SP8_9" class="paragraph-anchor"></a><b>&#167;8.9. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Police carousel structure</span><span class="named-paragraph-number">8.9</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">INSERTION_LSCT</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">                (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">CAROUSEL_SLIDE_MINLC</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">INSERTION_LSCT</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">                (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">CAROUSEL_END_MINLC</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                    </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"no carousel to end"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"code cannot appear in a carousel slide"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">DEFINITION_LSCT</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"definitions cannot appear in a carousel slide"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax">) </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"this carousel has no end"</span><span class="plain-syntax">, </span><span class="identifier-syntax">in_carousel</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">onset_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. </b>In some webs, the content of the commentary chunks is written in Markdown
format. We're only going to parse this if we need to: for tangling, for example,
we don't need to, and nor if the syntax doesn't use Markdown anyway. So this
is a further function which can be called after completion of a unit:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::parse_markdown</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::parse_markdown</span></span>:<br/>Web Structure - <a href="1-ws.html#SP2">&#167;2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">concatenated</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">concatenated</span><span class="plain-syntax">, </span><span class="string-syntax">"%S\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">as_markdown</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Markdown::parse_extended</span><span class="plain-syntax">(</span><span class="identifier-syntax">concatenated</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">MarkdownVariations::Inweb_flavoured_Markdown</span><span class="plain-syntax">());</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">concatenated</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">next_C</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_N</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">md</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">as_markdown</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><a href="2-ls.html#SP12" class="function-link"><span class="function-syntax">LiterateSource::recursively_check_note_numbering</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">md</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">next_C</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">next_N</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">next_C</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">"footnote cue"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">next_N</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">next_C</span><span class="plain-syntax">+1)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">"s [%d] to [%d] are missing in this paragraph"</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_C</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">-1);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">" [%d] is missing in this paragraph"</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">-1);</span>
<span class="plain-syntax">            </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">next_C</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">"footnote text"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">next_C</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">+1)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">"s [%d] to [%d] are missing in this paragraph"</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_C</span><span class="plain-syntax">-1);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">" [%d] is missing in this paragraph"</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_C</span><span class="plain-syntax">-1);</span>
<span class="plain-syntax">            </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_count</span><span class="plain-syntax"> = </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::recursively_check_note_numbering</span><span class="plain-syntax">(</span><span class="identifier-syntax">markdown_item</span><span class="plain-syntax"> *</span><span class="identifier-syntax">md</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">depth</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">report_at</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_C</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_N</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; </span><span class="identifier-syntax">md</span><span class="plain-syntax">; </span><span class="identifier-syntax">md</span><span class="plain-syntax"> = </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">next</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">type</span><span class="plain-syntax"> == </span><span class="identifier-syntax">FOOTNOTE_BODY_MIT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">N</span><span class="plain-syntax"> = </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">details</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">N</span><span class="plain-syntax"> != *</span><span class="identifier-syntax">next_N</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">"footnote [%d] occurs out of sequence"</span><span class="plain-syntax">, </span><span class="identifier-syntax">N</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="identifier-syntax">report_at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            *</span><span class="identifier-syntax">next_N</span><span class="plain-syntax"> = </span><span class="identifier-syntax">N</span><span class="plain-syntax">+1;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">details</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            *</span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">type</span><span class="plain-syntax"> == </span><span class="identifier-syntax">LINK_MIT</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">C</span><span class="plain-syntax"> = </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">details</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">C</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">C</span><span class="plain-syntax"> != *</span><span class="identifier-syntax">next_C</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="string-syntax">"footnote cue [%d] occurs out of sequence"</span><span class="plain-syntax">, </span><span class="identifier-syntax">C</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">, </span><span class="identifier-syntax">report_at</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">msg</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">                *</span><span class="identifier-syntax">next_C</span><span class="plain-syntax"> = </span><span class="identifier-syntax">C</span><span class="plain-syntax">+1;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">details</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                *</span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax"> = *</span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">down</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><a href="2-ls.html#SP12" class="function-link"><span class="function-syntax">LiterateSource::recursively_check_note_numbering</span></a><span class="plain-syntax">(</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">md</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">down</span><span class="plain-syntax">, </span><span class="identifier-syntax">depth</span><span class="plain-syntax">+1, </span><span class="identifier-syntax">report_at</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_C</span><span class="plain-syntax">, </span><span class="identifier-syntax">next_N</span><span class="plain-syntax">, </span><span class="identifier-syntax">cumulative_C</span><span class="plain-syntax">, </span><span class="identifier-syntax">cumulative_N</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13. </b>In all of that construction, we needed some surgery on doubly-linked lists:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::remove_chunk_from_par</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::remove_chunk_from_par</span></span>:<br/><a href="2-ls.html#SP8_5_1">&#167;8.5.1</a>, <a href="2-ls.html#SP8_5_2">&#167;8.5.2</a>, <a href="2-ls.html#SP8_8">&#167;8.8</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::remove_par_from_unit</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::remove_par_from_unit</span></span>:<br/><a href="2-ls.html#SP8_5">&#167;8.5</a>, <a href="2-ls.html#SP8_6">&#167;8.6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14. Fragments only.</b>The following provides the simplest possible demonstration of the functions
above. It makes an <span class="extract"><span class="extract-syntax">ls_unit</span></span> out of a small fragment of code stored as text
in memory, and which contains only code, not commentary or any of the other
bells and whistles possible.
</p>

<p class="commentary">As can be seen, most of the work is just breaking the text into lines, so
that they can be fed to the unit.
</p>

<p class="commentary">The result will be a unit of one paragraph, holding one chunk, corresponding
to a single nameless holon.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::code_fragment_to_unit</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::code_fragment_to_unit</span></span>:<br/>The Tangler - <a href="4-tt2.html#SP3">&#167;3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_notation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">syntax</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">programming_language</span><span class="plain-syntax"> *</span><span class="identifier-syntax">language</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">code</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_file_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP2" class="function-link"><span class="function-syntax">LiterateSource::begin_unit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">NULL</span><span class="plain-syntax">, </span><span class="identifier-syntax">syntax</span><span class="plain-syntax">, </span><span class="identifier-syntax">language</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP6" class="function-link"><span class="function-syntax">LiterateSource::feed_paragraph_start</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP6" class="function-link"><span class="function-syntax">LiterateSource::feed_code_start</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">buffer</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">code</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">inchar32_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::get_at</span><span class="plain-syntax">(</span><span class="identifier-syntax">code</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\n'</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><a href="2-ls.html#SP6" class="function-link"><span class="function-syntax">LiterateSource::feed_code_line</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">buffer</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">tfp</span><span class="plain-syntax">.</span><span class="element-syntax">line_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">buffer</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">PUT_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">buffer</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">buffer</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><a href="2-ls.html#SP6" class="function-link"><span class="function-syntax">LiterateSource::feed_code_line</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">, </span><span class="identifier-syntax">buffer</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">buffer</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP6" class="function-link"><span class="function-syntax">LiterateSource::feed_code_end</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">, &amp;</span><span class="identifier-syntax">tfp</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="2-ls.html#SP8" class="function-link"><span class="function-syntax">LiterateSource::complete_unit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15. Functions for examining webs.</b>Units first:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::unit_namespace</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::unit_namespace</span></span>:<br/>Types and Functions - <a href="3-taf.html#SP7_4">&#167;7.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">SECTION_HEADING_MINLC</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::unit_purpose</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::unit_purpose</span></span>:<br/>The Collater - <a href="5-tc.html#SP5_1_9_8_1">&#167;5.1.9.8.1</a><br/>The Weaver - <a href="5-tw.html#SP2_6">&#167;2.6</a><br/>Plain Text Format - <a href="5-ptf.html#SP2_1">&#167;2.1</a><br/>TeX Format - <a href="5-tf.html#SP4_3">&#167;4.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">PURPOSE_MINLC</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::unit_has_purpose</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::unit_has_purpose</span></span>:<br/><a href="2-ls.html#SP8">&#167;8</a><br/>The Collater - <a href="5-tc.html#SP5_1_3">&#167;5.1.3</a><br/>The Weaver - <a href="5-tw.html#SP2_6">&#167;2.6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><a href="2-ls.html#SP15" class="function-link"><span class="function-syntax">LiterateSource::unit_purpose</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">)) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::unit_has_errors</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::unit_has_errors</span></span>:<br/>Web Structure - <a href="1-ws.html#SP3">&#167;3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">LinkedLists::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">errors</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16. </b>Paragraphs:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::par_title</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_title</span></span>:<br/>The Weaver - <a href="5-tw.html#SP8">&#167;8</a><br/>Plain Text Format - <a href="5-ptf.html#SP2_9">&#167;2.9</a><br/>HTML Formats - <a href="5-hf.html#SP10">&#167;10</a><br/>Debugging Format - <a href="5-df.html#SP3">&#167;3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">titling</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::par_ornament</span><button class="popup" onclick="togglePopup('usagePopup21')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup21">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_ornament</span></span>:<br/><a href="2-ls.html#SP26">&#167;26</a>, <a href="2-ls.html#SP26_1">&#167;26.1</a><br/>Colonies - <a href="1-cln.html#SP14">&#167;14</a><br/>The Weaver - <a href="5-tw.html#SP8">&#167;8</a><br/>Plain Text Format - <a href="5-ptf.html#SP2_9">&#167;2.9</a>, <a href="5-ptf.html#SP2_28">&#167;2.28</a><br/>TeX Format - <a href="5-tf.html#SP4_34">&#167;4.34</a>, <a href="5-tf.html#SP5">&#167;5</a><br/>HTML Formats - <a href="5-hf.html#SP5_25">&#167;5.25</a>, <a href="5-hf.html#SP5_36">&#167;5.36</a>, <a href="5-hf.html#SP10">&#167;10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">I</span><span class="string-syntax">"S"</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::par_has_visible_number</span><button class="popup" onclick="togglePopup('usagePopup22')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup22">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_has_visible_number</span></span>:<br/>HTML Formats - <a href="5-hf.html#SP10">&#167;10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_section</span><span class="plain-syntax"> *</span><span class="identifier-syntax">S</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP19" class="function-link"><span class="function-syntax">LiterateSource::section_of_par</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">S</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">S</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">paragraph_numbers_visible</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::par_contains_early_code</span><button class="popup" onclick="togglePopup('usagePopup23')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup23">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_contains_early_code</span></span>:<br/>The Tangler - <a href="4-tt2.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">placed_early</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::par_contains_very_early_code</span><button class="popup" onclick="togglePopup('usagePopup24')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup24">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_contains_very_early_code</span></span>:<br/>Types and Functions - <a href="3-taf.html#SP7_4">&#167;7.4</a><br/>C-Like Languages - <a href="3-cl.html#SP2_1">&#167;2.1</a>, <a href="3-cl.html#SP6_3">&#167;6.3</a><br/>The Tangler - <a href="4-tt2.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">placed_very_early</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::par_contains_named_holon</span><button class="popup" onclick="togglePopup('usagePopup25')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup25">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_contains_named_holon</span></span>:<br/>The Weaver - <a href="5-tw.html#SP5">&#167;5</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) || (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon_name</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17. </b>Chunks:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::is_code_chunk</span><button class="popup" onclick="togglePopup('usagePopup26')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup26">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::is_code_chunk</span></span>:<br/>Language Methods - <a href="3-lm.html#SP5">&#167;5</a><br/>Tangle Targets - <a href="4-tt.html#SP4">&#167;4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::is_text_extract_chunk</span><button class="popup" onclick="togglePopup('usagePopup27')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup27">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::is_text_extract_chunk</span></span>:<br/>The Weaver of Text - <a href="5-twot.html#SP4">&#167;4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_LSCT</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18. </b>Lines:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::line_weaving_matter</span><button class="popup" onclick="togglePopup('usagePopup28')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup28">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::line_weaving_matter</span></span>:<br/>The Weaver - <a href="5-tw.html#SP2_6_1_2_2">&#167;2.6.1.2.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        ((</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_MAJLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">QUOTATION_MAJLC</span><span class="plain-syntax">) ||</span>
<span class="plain-syntax">            (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax"> == </span><span class="constant-syntax">EXTRACT_MATTER_MAJLC</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. Functions for crawling webs.</b></p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">ls_section</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::section_of_par</span><button class="popup" onclick="togglePopup('usagePopup29')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup29">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::section_of_par</span></span>:<br/><a href="2-ls.html#SP16">&#167;16</a><br/>Colonies - <a href="1-cln.html#SP14">&#167;14</a><br/>Conditional Compilation - <a href="3-cc.html#SP2">&#167;2</a>, <a href="3-cc.html#SP3">&#167;3</a><br/>Types and Functions - <a href="3-taf.html#SP9">&#167;9</a><br/>ACME Support - <a href="3-as.html#SP6">&#167;6</a><br/>InC Support - <a href="3-is.html#SP15_1">&#167;15.1</a>, <a href="3-is.html#SP15_2">&#167;15.2</a><br/>The Tangler - <a href="4-tt2.html#SP10_1_2">&#167;10.1.2</a><br/>The Weaver - <a href="5-tw.html#SP5_4">&#167;5.4</a>, <a href="5-tw.html#SP6">&#167;6</a>, <a href="5-tw.html#SP6_1">&#167;6.1</a><br/>TeX Format - <a href="5-tf.html#SP4_10">&#167;4.10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_unit</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_unit</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_section</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
<span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::par_of_line</span><button class="popup" onclick="togglePopup('usagePopup30')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup30">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::par_of_line</span></span>:<br/>Colonies - <a href="1-cln.html#SP13_5">&#167;13.5</a><br/>Code Analysis - <a href="3-ca.html#SP3">&#167;3</a>, <a href="3-ca.html#SP10">&#167;10</a><br/>Types and Functions - <a href="3-taf.html#SP7_4">&#167;7.4</a>, <a href="3-taf.html#SP8">&#167;8</a><br/>Language Methods - <a href="3-lm.html#SP23">&#167;23</a><br/>C-Like Languages - <a href="3-cl.html#SP5">&#167;5</a>, <a href="3-cl.html#SP6_1">&#167;6.1</a>, <a href="3-cl.html#SP7">&#167;7</a>, <a href="3-cl.html#SP6_3">&#167;6.3</a><br/>The Weaver - <a href="5-tw.html#SP2_6_1_2_2_2">&#167;2.6.1.2.2.2</a>, <a href="5-tw.html#SP2_6_1_2_1_1_5">&#167;2.6.1.2.1.1.5</a><br/>The Weaver of Text - <a href="5-twot.html#SP1_4">&#167;1.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
<span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::unit_of_line</span><button class="popup" onclick="togglePopup('usagePopup31')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup31">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::unit_of_line</span></span>:<br/>Web Errors - <a href="2-we.html#SP1">&#167;1</a><br/>The Tangler - <a href="4-tt2.html#SP13">&#167;13</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><a href="2-ls.html#SP19" class="function-link"><span class="function-syntax">LiterateSource::par_of_line</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_unit</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
<span class="reserved-syntax">ls_section</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::section_of_line</span><button class="popup" onclick="togglePopup('usagePopup32')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup32">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::section_of_line</span></span>:<br/>Code Analysis - <a href="3-ca.html#SP8">&#167;8</a>, <a href="3-ca.html#SP10">&#167;10</a><br/>ACME Support - <a href="3-as.html#SP9">&#167;9</a><br/>InC Support - <a href="3-is.html#SP9_1_2">&#167;9.1.2</a><br/>Ctags Support - <a href="4-cs.html#SP3">&#167;3</a><br/>The Weaver of Text - <a href="5-twot.html#SP4">&#167;4</a>, <a href="5-twot.html#SP4_3">&#167;4.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><a href="2-ls.html#SP19" class="function-link"><span class="function-syntax">LiterateSource::section_of_par</span></a><span class="plain-syntax">(</span><a href="2-ls.html#SP19" class="function-link"><span class="function-syntax">LiterateSource::par_of_line</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">));</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20. Tagging of paragraphs.</b>A "tagging" occurs when a paragraph is marked with a given tag, and perhaps
also with a contextually relevant caption. The following records those;
they're stored as a linked list within each paragraph.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">the_tag</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">caption</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::tag_paragraph_with_caption</span><button class="popup" onclick="togglePopup('usagePopup33')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup33">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::tag_paragraph_with_caption</span></span>:<br/><a href="2-ls.html#SP21">&#167;21</a><br/>Code Analysis - <a href="3-ca.html#SP2_2">&#167;2.2</a><br/>InC Support - <a href="3-is.html#SP2_1_2_5">&#167;2.1.2.5</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">caption</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"empty tag name"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEW_LINKED_LIST</span><span class="plain-syntax">(</span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax"> *</span><span class="identifier-syntax">pt</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">, </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">the_tag</span><span class="plain-syntax">, </span><span class="identifier-syntax">tag</span><span class="plain-syntax">)) &amp;&amp; (</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">caption</span><span class="plain-syntax">, </span><span class="identifier-syntax">caption</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">pt</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">the_tag</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">caption</span><span class="plain-syntax">) </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">caption</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">caption</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">caption</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::new</span><span class="plain-syntax">();</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">, </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure literate_source_tagging is accessed in 3/cc, 5/wt, 5/hf, 5/df and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21. </b>Tags are created simply by being used in taggings. If the tag notation
<span class="extract"><span class="extract-syntax">^"History: How tags came about"</span></span> is found, the following is called, and
the tag is <span class="extract"><span class="extract-syntax">History</span></span>, the caption "How tags came about".
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::tag_paragraph</span><button class="popup" onclick="togglePopup('usagePopup34')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup34">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::tag_paragraph</span></span>:<br/><a href="2-ls.html#SP8_4_4">&#167;8.4.4</a><br/>Code Analysis - <a href="3-ca.html#SP2_2">&#167;2.2</a><br/>Types and Functions - <a href="3-taf.html#SP2_2">&#167;2.2</a><br/>C-Like Languages - <a href="3-cl.html#SP2_1">&#167;2.1</a><br/>InC Support - <a href="3-is.html#SP2_1_1_1">&#167;2.1.1.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">text</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"empty tag name"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">name</span><span class="plain-syntax">) </span><span class="identifier-syntax">Str::copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">name</span><span class="plain-syntax">, </span><span class="identifier-syntax">text</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">caption</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">match_results</span><span class="plain-syntax"> </span><span class="identifier-syntax">mr</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Regexp::create_mr</span><span class="plain-syntax">();</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Regexp::match</span><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">, </span><span class="identifier-syntax">name</span><span class="plain-syntax">, </span><span class="identifier-syntax">U</span><span class="string-syntax">"(%c+?): (%c+)"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">Str::copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">name</span><span class="plain-syntax">, </span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="identifier-syntax">exp</span><span class="plain-syntax">[0]);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">Str::copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">caption</span><span class="plain-syntax">, </span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="identifier-syntax">exp</span><span class="plain-syntax">[1]);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><a href="2-ls.html#SP20" class="function-link"><span class="function-syntax">LiterateSource::tag_paragraph_with_caption</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">name</span><span class="plain-syntax">, </span><span class="identifier-syntax">caption</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">name</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">caption</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">Regexp::dispose_of</span><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP22" class="paragraph-anchor"></a><b>&#167;22. </b>If a given line is tagged with a given tag, what caption does it have?
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::retrieve_caption_for_tag</span><button class="popup" onclick="togglePopup('usagePopup35')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup35">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::retrieve_caption_for_tag</span></span>:<br/>The Weaver - <a href="5-tw.html#SP2_6_1_3_1">&#167;2.6.1.3.1</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax"> *</span><span class="identifier-syntax">pt</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">, </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tag</span><span class="plain-syntax"> == </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">the_tag</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">caption</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP23" class="paragraph-anchor"></a><b>&#167;23. </b>Finally, this tests whether a given paragraph falls under a given tag.
(Everything falls under the null non-tag: this ensures that a weave which
doesn't specify a tag will include everything.)
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::is_tagged_with</span><button class="popup" onclick="togglePopup('usagePopup36')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup36">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::is_tagged_with</span></span>:<br/>Language Methods - <a href="3-lm.html#SP23">&#167;23</a><br/>The Weaver - <a href="5-tw.html#SP2_6">&#167;2.6</a>, <a href="5-tw.html#SP2_6_1_2_2_2">&#167;2.6.1.2.2.2</a>, <a href="5-tw.html#SP5">&#167;5</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">tag</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">; </span><span class="comment-syntax"> see above!</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax"> *</span><span class="identifier-syntax">pt</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">, </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tag</span><span class="plain-syntax"> == </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">the_tag</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP24" class="paragraph-anchor"></a><b>&#167;24. Footnote notation.</b></p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">footnote_cue_number</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">footnote_text_number</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cue_text</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cued_already</span><span class="plain-syntax">;</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure ls_footnote is accessed in 5/tw, 5/twot, 5/wt, 5/ptf, 5/tf, 5/hf, 5/df and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_10" class="paragraph-anchor"></a><b>&#167;8.10. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Work out footnote numbering for this paragraph</span><span class="named-paragraph-number">8.10</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">next_footnote_in_para</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax"> *</span><span class="identifier-syntax">current_text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">before</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">after</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax"> == </span><span class="constant-syntax">COMMENTARY_LSCT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">before</span><span class="plain-syntax">); </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">); </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">after</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="2-ls.html#SP25" class="function-link"><span class="function-syntax">LiterateSource::detect_footnote</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owning_unit</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">syntax</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax">, </span><span class="identifier-syntax">before</span><span class="plain-syntax">, </span><span class="identifier-syntax">cue</span><span class="plain-syntax">, </span><span class="identifier-syntax">after</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">this_is_a_cue</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">LOOP_THROUGH_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">pos</span><span class="plain-syntax">, </span><span class="identifier-syntax">before</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Characters::is_whitespace</span><span class="plain-syntax">(</span><span class="identifier-syntax">Str::get</span><span class="plain-syntax">(</span><span class="identifier-syntax">pos</span><span class="plain-syntax">)) == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">this_is_a_cue</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">this_is_a_cue</span><span class="plain-syntax"> == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                        </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP8_10_1" class="named-paragraph-link"><span class="named-paragraph">This line begins a footnote text</span><span class="named-paragraph-number">8.10.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">current_text</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">before</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">after</span><span class="plain-syntax">)</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_10_1" class="paragraph-anchor"></a><b>&#167;8.10.1. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">This line begins a footnote text</span><span class="named-paragraph-number">8.10.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax"> *</span><span class="identifier-syntax">F</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_cue_number</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::atoi</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_cue_number</span><span class="plain-syntax"> != </span><span class="identifier-syntax">next_footnote_in_para</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">err</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">err</span><span class="plain-syntax">, </span><span class="string-syntax">"footnote should be numbered [%d], not [%d]"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">next_footnote_in_para</span><span class="plain-syntax">, </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_cue_number</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="2-we.html#SP1" class="function-link"><span class="function-syntax">WebErrors::record_at</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">err</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">err</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">next_footnote_in_para</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_text_number</span><span class="plain-syntax"> = </span><span class="identifier-syntax">next_footnote</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">cue_text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::new</span><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">cued_already</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">cue_text</span><span class="plain-syntax">, </span><span class="string-syntax">"%d"</span><span class="plain-syntax">, </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_text_number</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnotes</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnotes</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEW_LINKED_LIST</span><span class="plain-syntax">(</span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">F</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnotes</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_count</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">current_text</span><span class="plain-syntax"> = </span><span class="identifier-syntax">F</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP8_10">&#167;8.10</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP25" class="paragraph-anchor"></a><b>&#167;25. </b>Where:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::detect_footnote</span><button class="popup" onclick="togglePopup('usagePopup37')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup37">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::detect_footnote</span></span>:<br/><a href="2-ls.html#SP8_10">&#167;8.10</a><br/>The Weaver of Text - <a href="5-twot.html#SP1_4">&#167;1.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_notation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">S</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">before</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cue</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">after</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="2-wn.html#SP10" class="function-link"><span class="function-syntax">WebNotation::supports</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">FOOTNOTES_WSF</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">on_notation</span><span class="plain-syntax"> = </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">FOOTNOTES_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">off_notation</span><span class="plain-syntax"> = </span><a href="2-wn.html#SP11" class="function-link"><span class="function-syntax">WebNotation::notation</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">S</span><span class="plain-syntax">, </span><span class="constant-syntax">FOOTNOTES_WSF</span><span class="plain-syntax">, </span><span class="constant-syntax">2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">N1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">on_notation</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">N2</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">off_notation</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">N1</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">N2</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">); </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::includes_at</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">, </span><span class="identifier-syntax">on_notation</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">j</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax"> + </span><span class="identifier-syntax">N1</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="identifier-syntax">j</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::includes_at</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">, </span><span class="identifier-syntax">off_notation</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">b</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">a</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">Str::substr</span><span class="plain-syntax">(</span><span class="identifier-syntax">b</span><span class="plain-syntax">, </span><span class="identifier-syntax">Str::start</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">), </span><span class="identifier-syntax">Str::at</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">));</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">Str::substr</span><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">, </span><span class="identifier-syntax">Str::at</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax"> + </span><span class="identifier-syntax">N1</span><span class="plain-syntax">), </span><span class="identifier-syntax">Str::at</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">));</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">Str::substr</span><span class="plain-syntax">(</span><span class="identifier-syntax">a</span><span class="plain-syntax">, </span><span class="identifier-syntax">Str::at</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax"> + </span><span class="identifier-syntax">N2</span><span class="plain-syntax">), </span><span class="identifier-syntax">Str::end</span><span class="plain-syntax">(</span><span class="identifier-syntax">matter</span><span class="plain-syntax">));</span>
<span class="plain-syntax">                            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">allow</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">LOOP_THROUGH_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">pos</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Characters::isdigit</span><span class="plain-syntax">(</span><span class="identifier-syntax">Str::get</span><span class="plain-syntax">(</span><span class="identifier-syntax">pos</span><span class="plain-syntax">)) == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                                    </span><span class="identifier-syntax">allow</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">allow</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                                </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">before</span><span class="plain-syntax">); </span><span class="identifier-syntax">Str::copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">before</span><span class="plain-syntax">, </span><span class="identifier-syntax">b</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                                </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">); </span><span class="identifier-syntax">Str::copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                                </span><span class="identifier-syntax">Str::clear</span><span class="plain-syntax">(</span><span class="identifier-syntax">after</span><span class="plain-syntax">); </span><span class="identifier-syntax">Str::copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">after</span><span class="plain-syntax">, </span><span class="identifier-syntax">a</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                            }</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">b</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">a</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">allow</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                        }</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">j</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">                    }</span>
<span class="plain-syntax">                }</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">ls_footnote</span><span class="plain-syntax"> *</span><span class="function-syntax">LiterateSource::find_footnote_in_para</span><button class="popup" onclick="togglePopup('usagePopup38')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup38">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::find_footnote_in_para</span></span>:<br/>The Weaver of Text - <a href="5-twot.html#SP1_4">&#167;1.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">cue</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">N</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::atoi</span><span class="plain-syntax">(</span><span class="identifier-syntax">cue</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax"> *</span><span class="identifier-syntax">F</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">par</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnotes</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">F</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_footnote</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnotes</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">N</span><span class="plain-syntax"> == </span><span class="identifier-syntax">F</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">footnote_cue_number</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">F</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP26" class="paragraph-anchor"></a><b>&#167;26. Debugging.</b>The following provides a textual summary of a unit after its completion:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::write_lsu</span><button class="popup" onclick="togglePopup('usagePopup39')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup39">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::write_lsu</span></span>:<br/>Web Structure - <a href="1-ws.html#SP5">&#167;5</a>, <a href="1-ws.html#SP15">&#167;15</a></span></button><span class="plain-syntax">(</span><span class="identifier-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_unit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"(no literate source)\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">SECTION_HEADING_MINLC</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"heading '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">", namespace '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">heading</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax"> == </span><span class="constant-syntax">PURPOSE_MINLC</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"Purpose '%S'\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">purpose</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"(empty literate source)\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cc</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">lsu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax">; </span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_par</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S%S"</span><span class="plain-syntax">, </span><a href="2-ls.html#SP16" class="function-link"><span class="function-syntax">LiterateSource::par_ornament</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">), </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">paragraph_number</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">titling</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">titling</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax"> *</span><span class="identifier-syntax">pt</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">, </span><span class="reserved-syntax">literate_source_tagging</span><span class="plain-syntax">, </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">taggings</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" &lt;%S&gt;"</span><span class="plain-syntax">, </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">the_tag</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">caption</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"{%S}"</span><span class="plain-syntax">, </span><span class="identifier-syntax">pt</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">caption</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">INDENT</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">cc</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">my_previous</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_chunk</span><span class="plain-syntax"> *</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">; </span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">cc</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"C%d: "</span><span class="plain-syntax">, </span><span class="identifier-syntax">cc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP26_1" class="named-paragraph-link"><span class="named-paragraph">Write holon</span><span class="named-paragraph-number">26.1</span></a></span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="named-paragraph-container code-font"><a href="2-ls.html#SP26_2" class="named-paragraph-link"><span class="named-paragraph">Write non-holon chunk</span><span class="named-paragraph-number">26.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"*** first chunk but has prev_chunk set\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">last_chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_chunk</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"*** last chunk but has next_chunk set\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> != </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"*** prev_chunk is null\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">chunk</span><span class="plain-syntax"> != </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_chunk</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">prev_chunk</span><span class="plain-syntax"> != </span><span class="identifier-syntax">my_previous</span><span class="plain-syntax">))</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"*** prev_chunk is wrong\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">my_previous</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">OUTDENT</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP26_1" class="paragraph-anchor"></a><b>&#167;26.1. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Write holon</span><span class="named-paragraph-number">26.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"holon"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">ls_holon</span><span class="plain-syntax"> *</span><span class="identifier-syntax">holon</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon_name</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">placed_early</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (early)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">placed_very_early</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (very early)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">uc</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">holon_usage</span><span class="plain-syntax"> *</span><span class="identifier-syntax">hu</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">hu</span><span class="plain-syntax">, </span><span class="reserved-syntax">holon_usage</span><span class="plain-syntax">, </span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon_usages</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">uc</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (used in "</span><span class="plain-syntax">); </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">", "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">uc</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S%S"</span><span class="plain-syntax">, </span><a href="2-ls.html#SP16" class="function-link"><span class="function-syntax">LiterateSource::par_ornament</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">hu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">used_in_paragraph</span><span class="plain-syntax">),</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">hu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">used_in_paragraph</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">paragraph_number</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">hu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">multiplicity</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" x %d"</span><span class="plain-syntax">, </span><span class="identifier-syntax">hu</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">multiplicity</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">uc</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon_name</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (unused)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (used sequentially)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">")"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">INDENT</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">holon_splice</span><span class="plain-syntax"> *</span><span class="identifier-syntax">hs</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">hs</span><span class="plain-syntax">, </span><span class="reserved-syntax">holon_splice</span><span class="plain-syntax">, </span><span class="identifier-syntax">holon</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">splice_list</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">expansion</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">ls_paragraph</span><span class="plain-syntax"> *</span><span class="identifier-syntax">par</span><span class="plain-syntax"> = </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">expansion</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">corresponding_chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">owner</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"  holon '%S' (defined in %S%S)"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">expansion</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">holon_name</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><a href="2-ls.html#SP16" class="function-link"><span class="function-syntax">LiterateSource::par_ornament</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">par</span><span class="plain-syntax">),</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">par</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">paragraph_number</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">command</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"command '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">command</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><a href="2-ls.html#SP27" class="function-link"><span class="function-syntax">LiterateSource::write_code</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax">, </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">from</span><span class="plain-syntax">, </span><span class="identifier-syntax">hs</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">OUTDENT</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP26">&#167;26</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP26_2" class="paragraph-anchor"></a><b>&#167;26.2. </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Write non-holon chunk</span><span class="named-paragraph-number">26.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">chunk_type</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">COMMENTARY_LSCT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"commentary\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">QUOTATION_LSCT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"quotation\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EXTRACT_LSCT:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">hyperlinked</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"hyperlinked "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">plainer</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"undisplayed "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CODE_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"code "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EARLY_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"early code "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">VERY_EARLY_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"very early code "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">TEXT_AS_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"code "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"in %S "</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">TEXT_TO_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"plain text to file '%S' "</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">TEXT_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"plain text "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">NO_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"code "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"? "</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"extract\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">INSERTION_LSCT:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">AUDIO_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"audio '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CAROUSEL_SLIDE_MINLC:</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"carousel slide captioned '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">carousel_caption_position</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (positioned below)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">carousel_caption_position</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" (positioned above)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">CAROUSEL_END_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"carousel end"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DOWNLOAD_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"download '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EMBEDDED_AV_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"embedded av '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">FIGURE_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"figure '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HTML_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"HTML '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">VIDEO_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"video '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"?"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" insertion\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFINITION_LSCT:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">metadata</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFINE_COMMAND_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"define"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFAULT_COMMAND_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"default"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">ENUMERATE_COMMAND_MINLC:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"enumerate"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"? definition of some sort"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" '%S'"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_defined</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_value</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" = %S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">symbol_value</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HOLON_DECLARATION_LSCT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"holon definition\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">OTHER_LSCT:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"other\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"?\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">INDENT</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">chunk</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">first_line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax">; </span><span class="identifier-syntax">line</span><span class="plain-syntax"> = </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">next_line</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">COMMENTARY_MAJLC:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">QUOTATION_MAJLC:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">EXTRACT_MATTER_MAJLC:</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"_______ "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><a href="2-ls.html#SP27" class="function-link"><span class="function-syntax">LiterateSource::write_code</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">)-1);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">HOLON_DECLARATION_MAJLC:</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"holon declaration '%S'\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFINITION_MAJLC:</span><span class="plain-syntax"> </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DEFINITION_CONTINUED_MAJLC:</span>
<span class="plain-syntax">                </span><a href="2-ls.html#SP27" class="function-link"><span class="function-syntax">LiterateSource::write_code</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">Str::len</span><span class="plain-syntax">(</span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">text</span><span class="plain-syntax">)-1);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">INSERTION_MAJLC:</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">default:</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"class %d/%d: %S / %S / %S\n"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">major</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">minor</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand1</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand2</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">classification</span><span class="plain-syntax">.</span><span class="element-syntax">operand3</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">OUTDENT</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="2-ls.html#SP26">&#167;26</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP27" class="paragraph-anchor"></a><b>&#167;27. </b></p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">LiterateSource::write_code</span><button class="popup" onclick="togglePopup('usagePopup40')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup40">Usage of <span class="code-font"><span class="function-syntax">LiterateSource::write_code</span></span>:<br/><a href="2-ls.html#SP26_1">&#167;26.1</a>, <a href="2-ls.html#SP26_2">&#167;26.2</a></span></button><span class="plain-syntax">(</span><span class="identifier-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">ls_line</span><span class="plain-syntax"> *</span><span class="identifier-syntax">line</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%07d "</span><span class="plain-syntax">, </span><span class="identifier-syntax">line</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">origin</span><span class="plain-syntax">.</span><span class="element-syntax">line_count</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">from</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;=</span><span class="identifier-syntax">to</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">inchar32_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::get_at</span><span class="plain-syntax">(</span><span class="identifier-syntax">text</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">' '</span><span class="plain-syntax">) </span><span class="identifier-syntax">PUT</span><span class="plain-syntax">(</span><span class="constant-syntax">0x23D1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) </span><span class="identifier-syntax">PUT</span><span class="plain-syntax">(</span><span class="constant-syntax">0x21E2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">PUT</span><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax"> == </span><span class="character-syntax">'\t'</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"   "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="1-wr.html">&#10094;</a></li><li class="progresschapter"><a href="P-abgtl.html">P</a></li><li class="progresschapter"><a href="1-lm.html">1</a></li><li class="progresscurrentchapter">2</li><li class="progresscurrent">ls</li><li class="progresssection"><a href="2-lc.html">lc</a></li><li class="progresssection"><a href="2-we.html">we</a></li><li class="progresssection"><a href="2-wn.html">wn</a></li><li class="progresssection"><a href="2-hln.html">hln</a></li><li class="progresssection"><a href="2-hs.html">hs</a></li><li class="progresschapter"><a href="3-pl.html">3</a></li><li class="progresschapter"><a href="4-tt.html">4</a></li><li class="progresschapter"><a href="5-wd.html">5</a></li><li class="progresschapter"><a href="6-mkf.html">6</a></li><li class="progressnext"><a href="2-lc.html">&#10095;</a></li></ul></div>
</nav><!-- End of weave -->

		</main>
	</body>
</html>

